/*!
 * RasterMapProjection v0.0.24  2018-12-02
 *   https://github.com/tomosn/raster-map-projection
 *   A JavaScript library for on-the-fly map projection of raster tiles using WebGL.
 * Copyright (C) 2016-2018 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */

"use strict";if("undefined"!=typeof module&&module.exports)var RasterProjCommon=require("./rasterproj-common.js"),LambdaRangeUtils=RasterProjCommon.LambdaRangeRectUtils,GeographicRectUtils=RasterProjCommon.GeographicRectUtils,ProjMath=RasterProjCommon.ProjMath;var TileManager=function(t){this.rootNumX=2,this.rootNumY=1,this.rootTileSizeX=Math.PI,this.rootTileSizeY=Math.PI,this.numLevels=1,this.inverseY=!1,this.tileOrigin=[-Math.PI,-Math.PI/2],this.tileDomain=[-Math.PI,-Math.PI/2,+Math.PI,+Math.PI/2],this.dataLevelDef=null,this.tileUrlDef=null,void 0!==t&&("rootNumX"in t&&(this.rootNumX=t.rootNumX),"rootNumY"in t&&(this.rootNumY=t.rootNumY),"rootTileSizeX"in t&&(this.rootTileSizeX=t.rootTileSizeX),"rootTileSizeY"in t&&(this.rootTileSizeY=t.rootTileSizeY),"numLevels"in t&&(this.numLevels=t.numLevels),"inverseY"in t&&(this.inverseY=t.inverseY),"tileOrigin"in t&&(this.tileOrigin=t.tileOrigin),"dataLevelDef"in t&&(this.dataLevelDef=t.dataLevelDef),"tileUrlDef"in t&&(this.tileUrlDef=t.tileUrlDef))};TileManager.prototype.getTileX_=function(t,i){return Math.floor(t*(i-this.tileOrigin[0])/this.rootTileSizeX)},TileManager.prototype.getTileY_=function(t,i){var e=this.inverseY?-1:1;return Math.floor(e*t*(i-this.tileOrigin[1])/this.rootTileSizeY)},TileManager.prototype.getTileNumX_=function(t){return Math.ceil(t*(this.tileDomain[2]-this.tileOrigin[0])/this.rootTileSizeX)},TileManager.prototype.getTileNumY_=function(t){var i=this.inverseY?-1:1,e=this.inverseY?this.tileDomain[1]:this.tileDomain[3];return Math.ceil(i*t*(e-this.tileOrigin[1])/this.rootTileSizeY)},TileManager.prototype.getScale_=function(t){return 1<<Math.round(ProjMath.clamp(t,0,this.numLevels-1))},TileManager.prototype.getTileInfos=function(t,i){var e,r,o=this.getScale_(i),n=this.getTileNumX_(o),a=LambdaRangeUtils.normalize(t.lambda),s=this.getTileX_(o,a[0]),h=this.getTileX_(o,a[1]),l=this.getTileNumY_(o);r=this.inverseY?(e=this.getTileY_(o,t.phi[1]),this.getTileY_(o,t.phi[0])):(e=this.getTileY_(o,t.phi[0]),this.getTileY_(o,t.phi[1]));for(var c=[],d=l+1,p=e;p<=r;++p){var u=p%l;if(d==u)break;u<d&&(d=u);for(var g=n+1,w=s;w<=h;++w){var v=w%n;if(g==v)break;v<g&&(g=v);var y,_,m=this.tileUrlDef(i,v,u),f=this.rootTileSizeX*v/o+this.tileOrigin[0],T=this.rootTileSizeX*(v+1)/o+this.tileOrigin[0];_=this.inverseY?(y=-this.rootTileSizeY*(u+1)/o+this.tileOrigin[1],-this.rootTileSizeY*u/o+this.tileOrigin[1]):(y=this.rootTileSizeY*u/o+this.tileOrigin[1],this.rootTileSizeY*(u+1)/o+this.tileOrigin[1]);var M=null;(f<this.tileDomain[0]||y<this.tileDomain[1]||this.tileDomain[2]<T||this.tileDomain[3]<_)&&(M=[0,0,1,1],f<this.tileDomain[0]&&(M[0]=(this.tileDomain[0]-f)/(T-f)),y<this.tileDomain[1]&&(M[1]=(this.tileDomain[1]-y)/(_-y)),this.tileDomain[2]<T&&(M[2]=(this.tileDomain[2]-f)/(T-f)),this.tileDomain[3]<_&&(M[3]=(this.tileDomain[3]-y)/(_-y))),c.push({url:m,rect:[f,y,T,_],clipRect:M})}}return c};var ImageCache=function(t,i){this.num=32,this.crossOrigin=null,this.textures={},this.loading={},this.ongoingImageLoads=[],this.observer_=t,void 0!==i&&("num"in i&&(this.num=i.num),"crossOrigin"in i&&(this.crossOrigin=i.crossOrigin))};ImageCache.prototype.loadImage_=function(i,e,r){this.loading[e]=!0;var o=new Image;null!=this.crossOrigin&&(o.crossOrigin=this.crossOrigin),o.onload=function(){this.ongoingImageLoads.splice(this.ongoingImageLoads.indexOf(o),1);var t=ImageUtils.createTexture(i,o);t&&(this.textures[e]=[t,r]),delete this.loading.url,this.observer_.call(this)}.bind(this),this.ongoingImageLoads.push(o),o.src=e},ImageCache.prototype.loadImageIfAbsent=function(t,i,e){return!(i in this.textures)&&(!(i in this.loading)&&(this.loadImage_(t,i,e),!0))},ImageCache.prototype.getTexture=function(t){return this.textures[t]},ImageCache.prototype.clearOngoingImageLoads=function(){for(var t=0;t<this.ongoingImageLoads.length;t++)this.ongoingImageLoads[t].onload=void 0;this.ongoingImageLoads=[]};var CoordTransform=function(t,i,e,r,o,n){this.cxx_=t,this.cxy_=i,this.cyx_=e,this.cyy_=r,this.tx_=o,this.ty_=n};CoordTransform.prototype.clone=function(){return new CoordTransform(this.cxx_,this.cxy_,this.cyx_,this.cyy_,this.tx_,this.ty_)},CoordTransform.prototype.equals=function(t){return this.cxx_===t.cxx_&&this.cxy_===t.cxy_&&this.cyx_===t.cyx_&&this.cyy_===t.cyy_&&this.tx_===t.tx_&&this.ty_===t.ty_},CoordTransform.prototype.forwardPoint=function(t,i){return[this.cxx_*t+this.cxy_*i+this.tx_,this.cyx_*t+this.cyy_*i+this.ty_]},CoordTransform.prototype.forwardRectBounds=function(t,i,e,r){var o,n,a,s,h,l,c,d;return n=t<e?(o=t,e):(o=e,t),s=i<r?(a=i,r):(a=r,i),h=l=this.tx_,c=d=this.ty_,0<=this.cxx_?(h+=this.cxx_*o,l+=this.cxx_*n):(h+=this.cxx_*n,l+=this.cxx_*o),0<=this.cxy_?(h+=this.cxy_*a,l+=this.cxy_*s):(h+=this.cxy_*s,l+=this.cxy_*a),0<=this.cyx_?(c+=this.cyx_*o,d+=this.cyx_*n):(c+=this.cyx_*n,d+=this.cyx_*o),0<=this.cyy_?(c+=this.cyy_*a,d+=this.cyy_*s):(c+=this.cyy_*s,d+=this.cyy_*a),[h,c,l,d]};var ViewWindowManager=function(t,i,e){this.canvasSize={width:i.width,height:i.height},this.viewRect_=t,this.zoomInLimit_=null,this.zoomOutLimit_=null,void 0!==e&&("zoomInLimit"in e&&(this.zoomInLimit_=e.zoomInLimit),"zoomOutLimit"in e&&(this.zoomOutLimit_=e.zoomOutLimit));var r=(this.viewRect_[2]+this.viewRect_[0])/2,o=(this.viewRect_[3]+this.viewRect_[1])/2,n=this.viewRect_[2]-this.viewRect_[0],a=this.viewRect_[3]-this.viewRect_[1];this.viewCenter=[r,o],this.viewWindowSize=[n,a],this.rot_=null,this.setRotate(0),this.transform_=this.calcTransform_()};ViewWindowManager.prototype.calcTransform_=function(){var t=this.viewCenter[0],i=this.viewCenter[1],e=this.viewWindowSize[0]/2,r=this.viewWindowSize[1]/2,o=this.viewWindowSize[0]/this.canvasSize.width,n=this.viewWindowSize[1]/this.canvasSize.height,a=this.rot_.cost*o,s=-this.rot_.sint*n,h=t-this.rot_.cost*e-this.rot_.sint*r+this.rot_.sint*n*this.canvasSize.height,l=-this.rot_.sint*o,c=-this.rot_.cost*n,d=i+this.rot_.sint*e-this.rot_.cost*r+this.rot_.cost*n*this.canvasSize.height;return new CoordTransform(a,s,l,c,h,d)},ViewWindowManager.prototype.setRotate=function(t){var i=Math.cos(t),e=Math.sin(t);this.rot_={theta:t,cost:i,sint:e},this.transform_=this.calcTransform_()},ViewWindowManager.prototype.getRotate=function(){return this.rot_.theta},ViewWindowManager.prototype.rotate=function(t){var i=this.rot_.theta+t,e=Math.cos(i),r=Math.sin(i),o=Math.cos(t),n=Math.sin(t),a=this.viewCenter[0]*o+this.viewCenter[1]*n,s=-this.viewCenter[0]*n+this.viewCenter[1]*o;this.viewCenter=[a,s],this.rot_={theta:i,cost:e,sint:r},this.transform_=this.calcTransform_()},ViewWindowManager.prototype.setCanvasSize=function(t,i){this.canvasSize.width=t,this.canvasSize.height=i,this.transform_=this.calcTransform_()},ViewWindowManager.prototype.getCanvasSize=function(){return{width:this.canvasSize.width,height:this.canvasSize.height}},ViewWindowManager.prototype.getViewRect=function(){return this.viewRect_.slice(0)},ViewWindowManager.prototype.setViewWindowByCenter=function(t,i,e,r){this.viewCenter=[t,i],this.viewWindowSize=[e,r],this.transform_=this.calcTransform_()},ViewWindowManager.prototype.setViewWindow=function(t,i,e,r){var o=(e+t)/2,n=(r+i)/2,a=e-t,s=r-i;this.viewCenter=[o,n],this.viewWindowSize=[a,s],this.setRotate(0)},ViewWindowManager.prototype.getViewWindowBounds=function(){return this.transform_.forwardRectBounds(0,0,this.canvasSize.width,this.canvasSize.height)},ViewWindowManager.prototype.getViewWindowScale=function(){return Math.sqrt(this.viewWindowSize[0]*this.viewWindowSize[0]+this.viewWindowSize[1]*this.viewWindowSize[1])},ViewWindowManager.prototype.getViewRectBoundsFromWindow=function(t,i,e,r){return this.transform_.forwardRectBounds(t,i,e,r)},ViewWindowManager.prototype.setViewWindowCenter=function(t,i){this.viewCenter=[t,i],this.transform_=this.calcTransform_()},ViewWindowManager.prototype.getViewWindowCenter=function(){return this.viewCenter.slice(0)},ViewWindowManager.prototype.moveWindow=function(t,i){var e=this.viewWindowSize[0]/this.canvasSize.width,r=this.viewWindowSize[1]/this.canvasSize.height,o=this.viewCenter[0]-e*this.rot_.cost*t+r*this.rot_.sint*i,n=this.viewCenter[1]+e*this.rot_.sint*t+r*this.rot_.cost*i;this.viewCenter=[o,n],this.transform_=this.calcTransform_()},ViewWindowManager.prototype.zoomWindow=function(t){var i=(this.canvasSize.height-t)/this.canvasSize.height,e=i*this.viewWindowSize[0]/2,r=i*this.viewWindowSize[1]/2;null!=this.zoomInLimit_&&(e<this.zoomInLimit_||r<this.zoomInLimit_)||null!=this.zoomOutLimit_&&(this.zoomOutLimit_<e||this.zoomOutLimit_<r)||(this.viewWindowSize=[2*e,2*r],this.transform_=this.calcTransform_())},ViewWindowManager.prototype.getViewPointFromWindow=function(t,i){return this.transform_.forwardPoint(t,i)};var GeographicRectBoundsCalculateStrategy_=function(t){this.theta0_=t};GeographicRectBoundsCalculateStrategy_.prototype.calculate=function(t){var i=t-Math.floor(2*t/Math.PI)*Math.PI/2;return i<this.theta0_||Math.PI/2-this.theta0_<i?1:2};var MapView=function(t,i,e){this.imageProj=t,this.projection=i;var r={zoomInLimit:Math.PI/20,zoomOutLimit:20*Math.PI},o=this.projection.getRange();this.viewWindowManager_=new ViewWindowManager(o,e,r),this.calcStrategy_=new GeographicRectBoundsCalculateStrategy_(Math.PI/16),this.layers_=[],this.nameToLayers_={},this.isValid_=!1};MapView.prototype.setProjCenter=function(t,i){this.projection.setProjCenter(t,i),this.imageProj.setProjCenter(t,i),this.invalidateLayers(),this.invalidate()},MapView.prototype.getProjCenter=function(){return this.projection.getProjCenter()},MapView.prototype.getViewRect=function(){return this.viewWindowManager_.getViewRect()},MapView.prototype.getRotate=function(){return this.viewWindowManager_.getRotate()},MapView.prototype.setRotate=function(t){this.viewWindowManager_.setRotate(t),this.invalidate()},MapView.prototype.rotate=function(t){this.viewWindowManager_.rotate(t),this.invalidate()},MapView.prototype.getWindowBounds=function(){return this.viewWindowManager_.getViewWindowBounds()},MapView.prototype.setWindow=function(t,i,e,r){this.viewWindowManager_.setViewWindow(t,i,e,r),this.invalidateLayers(),this.invalidate()},MapView.prototype.setWindowByCenter=function(t,i,e,r){this.viewWindowManager_.setViewWindowByCenter(t,i,e,r),this.invalidateLayers(),this.invalidate()},MapView.prototype.moveWindow=function(t,i){this.viewWindowManager_.moveWindow(t,i),this.invalidate()},MapView.prototype.zoomWindow=function(t){this.viewWindowManager_.zoomWindow(t),this.invalidate()},MapView.prototype.getViewCenterPoint=function(){return this.viewWindowManager_.getViewWindowCenter()},MapView.prototype.setViewCenterPoint=function(t,i){this.viewWindowManager_.setViewWindowCenter(t,i),this.invalidate()},MapView.prototype.getLambdaPhiPointFromWindow=function(t,i){var e=this.viewWindowManager_.getViewPointFromWindow(t,i);return this.projection.inverse(e[0],e[1])},MapView.prototype.getViewPointFromWindow=function(t,i){return this.viewWindowManager_.getViewPointFromWindow(t,i)},MapView.prototype.getDividedGeographicRectBounds_=function(t){for(var i=null,e=0;e<t;e++)for(var r=e*this.viewWindowManager_.canvasSize.height/t,o=(e+1)*this.viewWindowManager_.canvasSize.height/t,n=0;n<t;n++){var a=n*this.viewWindowManager_.canvasSize.width/t,s=(n+1)*this.viewWindowManager_.canvasSize.width/t,h=this.viewWindowManager_.getViewRectBoundsFromWindow(a,r,s,o),l=this.projection.inverseBoundingBox(h[0],h[1],h[2],h[3]);i=null===i?l:GeographicRectUtils.union(l,i)}return i},MapView.prototype.getGeographicRectBounds=function(){var t=this.calcStrategy_.calculate(this.viewWindowManager_.getRotate()),i=this.viewWindowManager_.getViewWindowBounds(),e=this.projection.inverseBoundingBox(i[0],i[1],i[2],i[3]);if(1===t)return e;var r=this.getDividedGeographicRectBounds_(t);return GeographicRectUtils.intersection(e,r)},MapView.prototype.invalidate=function(){this.isValid_=!1},MapView.prototype.invalidateLayers=function(){for(var t=0;t<this.layers_.length;++t)this.layers_[t].invalidate()},MapView.prototype.loadData=function(){for(var t=0;t<this.layers_.length;++t)this.layers_[t].loadData(this);this.invalidate()},MapView.prototype.createTexture=function(t){return this.imageProj.createTexture(t)},MapView.prototype.addLayer=function(t){this.layers_.push(t),this.nameToLayers_[t.layerId]=t,this.invalidate()},MapView.prototype.clearLayers=function(){this.layers_.splice(0,this.layers_.length),this.nameToLayers_={},this.invalidate()},MapView.prototype.getLayerById=function(t){return this.nameToLayers_[t]},MapView.prototype.render=function(t){if(!0===t)for(var i=0;i<this.layers_.length;++i)this.layers_[i].markInvalid();else if(!this.requireRender_())return!1;this.imageProj.clear(this.viewWindowManager_.canvasSize);var e=this.projection.getProjCenter();this.imageProj.setProjCenter(e.lambda,e.phi);var r=this.viewWindowManager_.viewCenter,o=this.viewWindowManager_.viewWindowSize,n=this.viewWindowManager_.getRotate();this.imageProj.setTransform(r[0],r[1],o[0],o[1],n);for(var a=0;a<this.layers_.length;++a)this.layers_[a].visibility?this.layers_[a].render(this):this.layers_[a].markValid();return this.isValid_=!0},MapView.prototype.requireRender_=function(){if(!this.isValid_)return!0;for(var t=0;t<this.layers_.length;++t)if(!this.layers_[t].isValid())return!0;return!1};var Layer=function(t,i){this.layerId=t,this.coordType=i,this.visibility=!0,this.isValid_=!1};Layer.prototype.isValid=function(){return this.isValid_},Layer.prototype.markInvalid=function(){this.isValid_=!1},Layer.prototype.markValid=function(){this.isValid_=!0},Layer.prototype.loadData=function(t){},Layer.prototype.invalidate=function(){this.markInvalid()},Layer.prototype.setVisibility=function(t){this.visibility=t,this.markInvalid()},Layer.prototype.render=function(t){this.markValid()};var TileTextureLayer=function(t,i,e,r,o){Layer.call(this,t,i),this.tileManager=new TileManager(r),this.prevTileInfos_=null,this.prevTransform_=null;var n=function(){this.markInvalid()}.bind(this);this.imageCache=new ImageCache(n,o),this.opacity=1,void 0!==e&&"opacity"in e&&(this.opacity=e.opacity)};Object.setPrototypeOf(TileTextureLayer.prototype,Layer.prototype),TileTextureLayer.prototype.invalidate=function(){this.clearTileInfoCache_(),this.markInvalid()},TileTextureLayer.prototype.loadData=function(t){if(null==this.tileManager.tileUrlDef)return-1;var i=this.getTileInfos_(t),e=this.requestImages_(t.imageProj.getGLContext(),i);return this.markInvalid(),e},TileTextureLayer.prototype.setTileUrlDef=function(t){this.tileManager.tileUrlDef=t,this.markInvalid()},TileTextureLayer.prototype.setDataLevelDef=function(t){this.tileManager.dataLevelDef=t,this.markInvalid()},TileTextureLayer.prototype.resetImages=function(){this.imageCache.clearOngoingImageLoads(),this.markInvalid()},TileTextureLayer.prototype.render=function(t){if(null!=this.tileManager.tileUrlDef){var i=this.getTileInfos_(t);this.requestImages_(t.imageProj.getGLContext(),i);for(var e=[],r=0;r<i.length;++r){var o=i[r],n=this.imageCache.getTexture(o.url);n&&(n.push(o.clipRect),e.push(n))}if(0<e.length){t.imageProj.setCoordTypeData(),t.imageProj.setOpacity(this.opacity),t.imageProj.prepareRenderSurface();for(var a=0;a<e.length;a++){var s=e[a][0],h=e[a][1],l=e[a][2];t.imageProj.renderSurfaceTexture(s,h,l)}}this.markValid()}},TileTextureLayer.prototype.clearTileInfoCache_=function(){this.prevTransform_=null,this.prevTileInfos_=null,this.markInvalid()},TileTextureLayer.prototype.requestImages_=function(t,i){for(var e=0,r=0;r<i.length;++r)this.imageCache.loadImageIfAbsent(t,i[r].url,i[r].rect)&&++e;return e},TileTextureLayer.prototype.getTileInfos_=function(t){if(null!=this.prevTileInfos_&&null!=this.prevTransform_){if(this.prevTransform_.equals(t.viewWindowManager_.transform_))return this.prevTileInfos_;this.prevTileInfos_=null,this.prevTransform_=null}var i=t.getGeographicRectBounds(),e=t.viewWindowManager_.getViewWindowScale(),r=null!=this.tileManager.dataLevelDef?this.tileManager.dataLevelDef(e,i):0,o=this.tileManager.getTileInfos(i,r);return this.prevTransform_=t.viewWindowManager_.transform_.clone(),this.prevTileInfos_=o};var PointTextureLayer=function(t,i,e,r){Layer.call(this,t,i),this.pointTextureId=e,this.size=48,void 0!==r&&"size"in r&&(this.size=r.size),this.data_=[]};Object.setPrototypeOf(PointTextureLayer.prototype,Layer.prototype),PointTextureLayer.prototype.addPoint=function(t,i){this.data_.push(t,i),this.markInvalid()},PointTextureLayer.prototype.addPoints=function(t){this.data_=this.data_.concat(t),this.markInvalid()},PointTextureLayer.prototype.clear=function(){this.data_.splice(0,this.data_.length),this.markInvalid()},PointTextureLayer.prototype.render=function(t){0<this.data_.length&&(t.imageProj.prepareRenderPoints(),t.imageProj.setCoordType(this.coordType),t.imageProj.setPointSize(this.size),t.imageProj.setPointTexture(this.pointTextureId),t.imageProj.renderPoints(this.data_)),this.markValid()};var PolylineLayer=function(t,i,e){Layer.call(this,t,i),this.color={r:1,g:1,b:1,a:1},void 0!==e&&"color"in e&&(this.color=e.color),this.data_=[]};Object.setPrototypeOf(PolylineLayer.prototype,Layer.prototype),PolylineLayer.prototype.addPolyline=function(t){this.data_.push(t),this.markInvalid()},PolylineLayer.prototype.clear=function(){this.data_.splice(0,this.data_.length),this.markInvalid()},PolylineLayer.prototype.render=function(t){if(0<this.data_.length){t.imageProj.prepareRenderPolyline(),t.imageProj.setCoordType(this.coordType),t.imageProj.setColor(this.color);for(var i=0;i<this.data_.length;++i)t.imageProj.renderPolyline(this.data_[i])}this.markValid()};var GraticuleLayer=function(t,i){Layer.call(this,t,ProjShaderProgram.COORD_TYPE_DATA),this.graticuleRenderer_=null,this.color={r:.88,g:.88,b:.88,a:1},this.intervalDegrees=20,void 0!==i&&("color"in i&&(this.color=i.color),"intervalDegrees"in i&&(this.intervalDegrees=i.intervalDegrees))};Object.setPrototypeOf(GraticuleLayer.prototype,Layer.prototype),GraticuleLayer.prototype.invalidate=function(){this.graticuleRenderer_=null,this.markInvalid()},GraticuleLayer.prototype.render=function(t){if(0<this.intervalDegrees){null==this.graticuleRenderer_&&(this.graticuleRenderer_=new GraticuleRenderer(t.imageProj,t.projection)),t.imageProj.setCoordTypeData(),t.imageProj.setColor(this.color);var i=t.getWindowBounds(),e=t.projection.inverseBoundingBox(i[0],i[1],i[2],i[3]);this.graticuleRenderer_.renderLines(i,e,this.intervalDegrees)}this.markValid()},"undefined"!=typeof module&&module.exports&&(module.exports=MapView,module.exports.TileManager=TileManager,module.exports.ViewWindowManager=ViewWindowManager);