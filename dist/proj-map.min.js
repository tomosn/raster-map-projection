/*!
 * Raster Map Projection v0.0.19  2017-09-18
 *   https://github.com/tomosn/raster-map-projection
 * Copyright (C) 2016-2017 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */

"use strict";if("undefined"!=typeof module&&module.exports)var ProjMath=require("./rasterproj-common.js");var TileManager=function(t){this.rootNumX=2,this.rootNumY=1,this.rootTileSizeX=Math.PI,this.rootTileSizeY=Math.PI,this.numLevels=1,this.inverseY=!1,this.tileOrigin=[-Math.PI,-Math.PI/2],this.dataLevelDef=null,this.tileUrlDef=null,void 0!==t&&("rootNumX"in t&&(this.rootNumX=t.rootNumX),"rootNumY"in t&&(this.rootNumY=t.rootNumY),"rootTileSizeX"in t&&(this.rootTileSizeX=t.rootTileSizeX),"tileSizeY"in t&&(this.rootTileSizeY=t.rootTileSizeY),"numLevels"in t&&(this.numLevels=t.numLevels),"inverseY"in t&&(this.inverseY=t.inverseY),"tileOrigin"in t&&(this.tileOrigin=t.tileOrigin),"dataLevelDef"in t&&(this.dataLevelDef=t.dataLevelDef),"tileUrlDef"in t&&(this.tileUrlDef=t.tileUrlDef)),this.rootSizeX=this.rootNumX*this.rootTileSizeX,this.rootSizeY=this.rootNumY*this.rootTileSizeY};TileManager.prototype.getTileX_=function(t,e){return Math.floor(t*(e-this.tileOrigin[0])/this.rootSizeX)},TileManager.prototype.getTileY_=function(t,e){var i=this.inverseY?-1:1;return Math.floor(i*t*(e-this.tileOrigin[1])/this.rootSizeY)},TileManager.prototype.getTileNum_=function(t){var e=1<<Math.round(ProjMath.clamp(t,0,this.numLevels-1));return[e*this.rootNumX,e*this.rootNumY]},TileManager.prototype.getTileInfos=function(t,e){var i,r,o=this.getTileNum_(e),n=o[0],a=o[1],s=this.getTileX_(n,t.lambda[0]),h=this.getTileX_(n,t.lambda[1]);this.inverseY?(i=this.getTileY_(a,t.phi[1]),r=this.getTileY_(a,t.phi[0])):(i=this.getTileY_(a,t.phi[0]),r=this.getTileY_(a,t.phi[1]));for(var l=[],d=a+1,p=i;p<=r;++p){var c=p%a;if(d==c)break;c<d&&(d=c);for(var u=n+1,g=s;g<=h;++g){var y=g%n;if(u==y)break;y<u&&(u=y);var v,m,f=this.tileUrlDef(e,y,c),w=this.rootSizeX*y/n+this.tileOrigin[0],_=this.rootSizeX*(y+1)/n+this.tileOrigin[0];this.inverseY?(v=-this.rootSizeY*(c+1)/a+this.tileOrigin[1],m=-this.rootSizeY*c/a+this.tileOrigin[1]):(v=this.rootSizeY*c/a+this.tileOrigin[1],m=this.rootSizeY*(c+1)/a+this.tileOrigin[1]),l.push({url:f,rect:[w,v,_,m]})}}return l};var ImageCache=function(t,e){this.num=32,this.crossOrigin=null,this.textures={},this.loading={},this.ongoingImageLoads=[],this.observer_=t,void 0!==e&&("num"in e&&(this.num=e.num),"crossOrigin"in e&&(this.crossOrigin=e.crossOrigin))};ImageCache.prototype.loadImage_=function(t,e,i){this.loading[e]=!0;var r=new Image;null!=this.crossOrigin&&(r.crossOrigin=this.crossOrigin),r.onload=function(){this.ongoingImageLoads.splice(this.ongoingImageLoads.indexOf(r),1);var o=ImageUtils.createTexture(t,r);o&&(this.textures[e]=[o,i]),delete this.loading.url,this.observer_.call(this)}.bind(this),this.ongoingImageLoads.push(r),r.src=e},ImageCache.prototype.loadImageIfAbsent=function(t,e,i){return!(e in this.textures)&&(!(e in this.loading)&&(this.loadImage_(t,e,i),!0))},ImageCache.prototype.getTexture=function(t){return this.textures[t]},ImageCache.prototype.clearOngoingImageLoads=function(){for(var t=0;t<this.ongoingImageLoads.length;t++)this.ongoingImageLoads[t].onload=void 0;this.ongoingImageLoads=[]};var CoordTransform=function(t,e){this.src_x1_=t[0],this.src_y1_=t[1],this.src_x2_=t[2],this.src_y2_=t[3],this.dst_x1_=e[0],this.dst_y1_=e[1],this.dst_x2_=e[2],this.dst_y2_=e[3],this.scaleX_=(e[2]-e[0])/(t[2]-t[0]),this.scaleY_=(e[3]-e[1])/(t[3]-t[1])};CoordTransform.prototype.scaleX=function(){return this.scaleX_},CoordTransform.prototype.scaleY=function(){return this.scaleY_},CoordTransform.prototype.forwardPoint=function(t){return[this.dst_x1_+(t[0]-this.src_x1_)*this.scaleX_,this.dst_y1_+(t[1]-this.src_y1_)*this.scaleY_]},CoordTransform.prototype.forwardRect=function(t){var e=this.forwardPoint([t[0],t[1]]),i=this.forwardPoint([t[2],t[3]]);return[e[0],e[1],i[0],i[1]]};var ViewWindowManager=function(t,e,i){this.canvasSize={width:e.width,height:e.height},this.viewRect_=t,this.zoomInLimit_=null,this.zoomOutLimit_=null,void 0!==i&&("zoomInLimit"in i&&(this.zoomInLimit_=i.zoomInLimit),"zoomOutLimit"in i&&(this.zoomOutLimit_=i.zoomOutLimit)),this.rect=this.getViewRect()};ViewWindowManager.prototype.setCanvasSize=function(t,e){this.canvasSize.width=t,this.canvasSize.height=e},ViewWindowManager.prototype.getCanvasSize=function(){return{width:this.canvasSize.width,height:this.canvasSize.height}},ViewWindowManager.prototype.getViewRect=function(){return this.viewRect_.slice(0)},ViewWindowManager.prototype.setViewWindow=function(t,e,i,r){this.rect=[t,e,i,r]},ViewWindowManager.prototype.getViewWindow=function(){return this.rect.slice(0)},ViewWindowManager.prototype.setViewWindowCenter=function(t,e){var i=(this.rect[2]-this.rect[0])/2,r=(this.rect[3]-this.rect[1])/2;this.rect=[t-i,e-r,t+i,e+r]},ViewWindowManager.prototype.getViewWindowCenter=function(){return[(this.rect[2]+this.rect[0])/2,(this.rect[3]+this.rect[1])/2]},ViewWindowManager.prototype.moveWindow=function(t,e){var i=-t*(this.rect[2]-this.rect[0])/this.canvasSize.width,r=e*(this.rect[3]-this.rect[1])/this.canvasSize.height,o=this.rect[0]+i,n=this.rect[1]+r,a=this.rect[2]+i,s=this.rect[3]+r;this.rect=[o,n,a,s]},ViewWindowManager.prototype.zoomWindow=function(t){var e=(this.canvasSize.height-t)/this.canvasSize.height,i=e*(this.rect[2]-this.rect[0])/2,r=e*(this.rect[3]-this.rect[1])/2,o=(this.rect[2]+this.rect[0])/2,n=(this.rect[3]+this.rect[1])/2;null!=this.zoomInLimit_&&(i<this.zoomInLimit_||r<this.zoomInLimit_)||null!=this.zoomOutLimit_&&(this.zoomOutLimit_<i||this.zoomOutLimit_<r)||(this.rect=[o-i,n-r,o+i,n+r])},ViewWindowManager.prototype.getViewPointFromWindow=function(t,e){return new CoordTransform([0,this.canvasSize.height,this.canvasSize.width,0],this.rect).forwardPoint([t,e])};var MapView=function(t,e,i,r,o){this.gl=t,this.projection=e,this.imageProj=RasterMapProjection.createShaderProgram(t),this.imageProj.init(e.getVertexShaderStr(),e.getFragmentShaderStr());var n={zoomInLimit:Math.PI/20,zoomOutLimit:20*Math.PI},a=this.projection.getRange();this.viewWindowManager_=new ViewWindowManager(a,i,n),this.layers_=[],this.nameToLayers_={},this.isValid_=!1};MapView.prototype.setProjCenter=function(t,e){this.projection.setProjCenter(t,e),this.imageProj.setProjCenter(t,e),this.invalidateLayers(),this.invalidate()},MapView.prototype.getProjCenter=function(){return this.projection.getProjCenter()},MapView.prototype.getViewRect=function(){return this.viewWindowManager_.getViewRect()},MapView.prototype.getWindow=function(){return this.viewWindowManager_.getViewWindow()},MapView.prototype.setWindow=function(t,e,i,r){this.viewWindowManager_.setViewWindow(t,e,i,r),this.invalidateLayers(),this.invalidate()},MapView.prototype.moveWindow=function(t,e){this.viewWindowManager_.moveWindow(t,e),this.invalidate()},MapView.prototype.zoomWindow=function(t){this.viewWindowManager_.zoomWindow(t),this.invalidate()},MapView.prototype.getViewCenterPoint=function(){return this.viewWindowManager_.getViewWindowCenter()},MapView.prototype.setViewCenterPoint=function(t,e){this.viewWindowManager_.setViewWindowCenter(t,e),this.invalidate()},MapView.prototype.getLambdaPhiPointFromWindow=function(t,e){var i=this.viewWindowManager_.getViewPointFromWindow(t,e);return this.projection.inverse(i[0],i[1])},MapView.prototype.invalidate=function(){this.isValid_=!1},MapView.prototype.invalidateLayers=function(){for(var t=0;t<this.layers_.length;++t)this.layers_[t].invalidate()},MapView.prototype.loadData=function(){for(var t=0;t<this.layers_.length;++t)this.layers_[t].loadData(this);this.invalidate()},MapView.prototype.createTexture=function(t){return ImageUtils.createTexture(this.gl,t)},MapView.prototype.addLayer=function(t){this.layers_.push(t),this.nameToLayers_[t.layerId]=t,this.invalidate()},MapView.prototype.clearLayers=function(){this.layers_.clear(),this.nameToLayers_={},this.invalidate()},MapView.prototype.getLayerById=function(t){return this.nameToLayers_[t]},MapView.prototype.render=function(t){if(!0===t)for(var e=0;e<this.layers_.length;++e)this.layers_[e].markInvalid();else if(!this.requireRender_())return!1;this.imageProj.clear(this.viewWindowManager_.canvasSize);var i=this.projection.getProjCenter();this.imageProj.setProjCenter(i.lambda,i.phi);var r=this.viewWindowManager_.getViewWindow();this.imageProj.setViewWindow(r[0],r[1],r[2],r[3]);for(var o=0;o<this.layers_.length;++o)this.layers_[o].visibility?this.layers_[o].render(this):this.layers_[o].markValid();return this.isValid_=!0,!0},MapView.prototype.requireRender_=function(){if(!this.isValid_)return!0;for(var t=0;t<this.layers_.length;++t)if(!this.layers_[t].isValid())return!0;return!1};var Layer=function(t,e){this.layerId=t,this.coordType=e,this.visibility=!0,this.isValid_=!1};Layer.prototype.isValid=function(){return this.isValid_},Layer.prototype.markInvalid=function(){this.isValid_=!1},Layer.prototype.markValid=function(){this.isValid_=!0},Layer.prototype.loadData=function(t){},Layer.prototype.invalidate=function(){this.markInvalid()},Layer.prototype.setVisibility=function(t){this.visibility=t,this.markInvalid()},Layer.prototype.render=function(t){this.markValid()};var TileTextureLayer=function(t,e,i,r,o){Layer.call(this,t,e),this.tileManager=new TileManager(r),this.prevTileInfos_=null,this.prevWindow_=null;this.imageCache=new ImageCache(function(){this.markInvalid()}.bind(this),o),this.opacity=1,void 0!==i&&"opacity"in i&&(this.opacity=i.opacity)};Object.setPrototypeOf(TileTextureLayer.prototype,Layer.prototype),TileTextureLayer.prototype.invalidate=function(){this.clearTileInfoCache_(),this.markInvalid()},TileTextureLayer.prototype.loadData=function(t){if(null==this.tileManager.tileUrlDef)return-1;var e=this.getTileInfos_(t),i=this.requestImages_(t.gl,e);return this.markInvalid(),i},TileTextureLayer.prototype.setTileUrlDef=function(t){this.tileManager.tileUrlDef=t,this.markInvalid()},TileTextureLayer.prototype.setDataLevelDef=function(t){this.tileManager.dataLevelDef=t,this.markInvalid()},TileTextureLayer.prototype.resetImages=function(){this.imageCache.clearOngoingImageLoads(),this.markInvalid()},TileTextureLayer.prototype.render=function(t){if(null!=this.tileManager.tileUrlDef){var e=this.getTileInfos_(t);this.requestImages_(t.gl,e);for(var i=[],r=0;r<e.length;++r){var o=e[r],n=this.imageCache.getTexture(o.url);n&&i.push(n)}if(0<i.length){t.imageProj.setCoordTypeData(),t.imageProj.setOpacity(this.opacity),t.imageProj.prepareRenderSurface();for(var a=0;a<i.length;a++){var s=i[a][0],h=i[a][1];t.imageProj.renderSurfaceTexture(s,h)}}this.markValid()}},TileTextureLayer.prototype.clearTileInfoCache_=function(){this.prevWindow_=null,this.prevTileInfos_=null,this.markInvalid()},TileTextureLayer.prototype.requestImages_=function(t,e){for(var i=0,r=0;r<e.length;++r)this.imageCache.loadImageIfAbsent(t,e[r].url,e[r].rect)&&++i;return i},TileTextureLayer.prototype.getTileInfos_=function(t){var e=t.viewWindowManager_.getViewWindow();if(null!=this.prevTileInfos_&&null!=this.prevWindow_){if(e[0]==this.prevWindow_[0]&&e[1]==this.prevWindow_[1]&&e[2]==this.prevWindow_[2]&&e[3]==this.prevWindow_[3])return this.prevTileInfos_;this.prevTileInfos_=null,this.prevWindow_=null}var i=t.projection.inverseBoundingBox(e[0],e[1],e[2],e[3]),r=null!=this.tileManager.dataLevelDef?this.tileManager.dataLevelDef(e,i):0,o=this.tileManager.getTileInfos(i,r);return this.prevWindow_=e,this.prevTileInfos_=o,o};var PointTextureLayer=function(t,e,i,r){Layer.call(this,t,e),this.pointTextureId=i,this.size=48,void 0!==r&&"size"in r&&(this.size=r.size),this.data_=[]};Object.setPrototypeOf(PointTextureLayer.prototype,Layer.prototype),PointTextureLayer.prototype.addPoint=function(t,e){this.data_.push(t,e),this.markInvalid()},PointTextureLayer.prototype.addPoints=function(t){this.data_=this.data_.concat(t),this.markInvalid()},PointTextureLayer.prototype.clear=function(){this.data_.clear(),this.markInvalid()},PointTextureLayer.prototype.render=function(t){0<this.data_.length&&(t.imageProj.prepareRenderPoints(),t.imageProj.setCoordType(this.coordType),t.imageProj.setPointSize(this.size),t.imageProj.setPointTexture(this.pointTextureId),t.imageProj.renderPoints(this.data_)),this.markValid()};var PolylineLayer=function(t,e,i){Layer.call(this,t,e),this.color={r:1,g:1,b:1,a:1},void 0!==i&&"color"in i&&(this.color=i.color),this.data_=[]};Object.setPrototypeOf(PolylineLayer.prototype,Layer.prototype),PolylineLayer.prototype.addPolyline=function(t){this.data_.push(t),this.markInvalid()},PolylineLayer.prototype.clear=function(){this.data_.clear(),this.markInvalid()},PolylineLayer.prototype.render=function(t){if(0<this.data_.length){t.imageProj.prepareRenderPolyline(),t.imageProj.setCoordType(this.coordType),t.imageProj.setColor(this.color);for(var e=0;e<this.data_.length;++e)t.imageProj.renderPolyline(this.data_[e])}this.markValid()};var GraticuleLayer=function(t,e){Layer.call(this,t,ProjShaderProgram.COORD_TYPE_DATA),this.graticuleRenderer_=null,this.color={r:.88,g:.88,b:.88,a:1},this.intervalDegrees=20,void 0!==e&&("color"in e&&(this.color=e.color),"intervalDegrees"in e&&(this.intervalDegrees=e.intervalDegrees))};Object.setPrototypeOf(GraticuleLayer.prototype,Layer.prototype),GraticuleLayer.prototype.invalidate=function(){this.graticuleRenderer_=null,this.markInvalid()},GraticuleLayer.prototype.render=function(t){if(0<this.intervalDegrees){null==this.graticuleRenderer_&&(this.graticuleRenderer_=new GraticuleRenderer(t.imageProj,t.projection)),t.imageProj.setCoordTypeData(),t.imageProj.setColor(this.color);var e=t.getWindow(),i=t.projection.inverseBoundingBox(e[0],e[1],e[2],e[3]);this.graticuleRenderer_.renderLines(e,i,this.intervalDegrees)}this.markValid()},"undefined"!=typeof module&&module.exports&&(module.exports=MapView,module.exports.TileManager=TileManager);