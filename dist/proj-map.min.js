/*!
 * RasterMapProjection v0.0.29  2019-06-02
 *   https://github.com/tomosn/raster-map-projection
 *   A JavaScript library for on-the-fly map projection of raster tiles using WebGL.
 * Copyright (C) 2016-2019 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */

"use strict";if("undefined"!=typeof module&&module.exports)var RasterProjCommon=require("./rasterproj-common.js"),LambdaRangeUtils=RasterProjCommon.LambdaRangeRectUtils,GeographicRectUtils=RasterProjCommon.GeographicRectUtils,ProjMath=RasterProjCommon.ProjMath;function TileManager(t){this.rootNumX=2,this.rootNumY=1,this.rootTileSizeX=Math.PI,this.rootTileSizeY=Math.PI,this.numLevels=1,this.inverseY=!1,this.tileOrigin=[-Math.PI,-Math.PI/2],this.tileDomain={lambda1:-Math.PI,phi1:-Math.PI/2,lambda2:+Math.PI,phi2:+Math.PI/2},this.dataLevelDef=null,this.tileUrlDef=null,void 0!==t&&("rootNumX"in t&&(this.rootNumX=t.rootNumX),"rootNumY"in t&&(this.rootNumY=t.rootNumY),"rootTileSizeX"in t&&(this.rootTileSizeX=t.rootTileSizeX),"rootTileSizeY"in t&&(this.rootTileSizeY=t.rootTileSizeY),"numLevels"in t&&(this.numLevels=t.numLevels),"inverseY"in t&&(this.inverseY=t.inverseY),"tileOrigin"in t&&(this.tileOrigin=t.tileOrigin),"dataLevelDef"in t&&(this.dataLevelDef=t.dataLevelDef),"tileUrlDef"in t&&(this.tileUrlDef=t.tileUrlDef))}function ImageCache(t,i){this.num=32,this.crossOrigin=null,this.textures={},this.loading={},this.ongoingImageLoads=[],this.observer_=t,void 0!==i&&("num"in i&&(this.num=i.num),"crossOrigin"in i&&(this.crossOrigin=i.crossOrigin))}function CoordTransform(t,i,e,o,n,r){this.cxx_=t,this.cxy_=i,this.cyx_=e,this.cyy_=o,this.tx_=n,this.ty_=r}function ViewWindowManager(t,i,e){this.canvasSize={width:i.width,height:i.height},this.viewRect_=t,this.zoomInLimit_=null,this.zoomOutLimit_=null,void 0!==e&&("zoomInLimit"in e&&(this.zoomInLimit_=e.zoomInLimit),"zoomOutLimit"in e&&(this.zoomOutLimit_=e.zoomOutLimit));const o=(this.viewRect_.x2+this.viewRect_.x1)/2,n=(this.viewRect_.y2+this.viewRect_.y1)/2,r=this.viewRect_.x2-this.viewRect_.x1,a=this.viewRect_.y2-this.viewRect_.y1;this.viewCenter=[o,n],this.viewWindowSize={width:r,height:a},this.rot_=null,this.setRotate(0),this.transform_=this.calcTransform_()}function GeographicRectBoundsCalculateStrategy_(t){this.theta0_=t}function MapView(t,i,e){this.imageProj=t,this.projection=i;const o={zoomInLimit:Math.PI/20,zoomOutLimit:20*Math.PI},n=this.projection.getRange();this.viewWindowManager_=new ViewWindowManager(n,e,o),this.calcStrategy_=new GeographicRectBoundsCalculateStrategy_(Math.PI/16),this.layers_=[],this.nameToLayers_={},this.isValid_=!1}function Layer(t,i){this.layerId=t,this.coordType=i,this.visibility=!0,this.isValid_=!1}function TileTextureLayer(t,i,e,o,n){Layer.call(this,t,i),this.tileManager=new TileManager(o),this.prevTileInfos_=null,this.prevTransform_=null;const r=function(){this.markInvalid()}.bind(this);this.imageCache=new ImageCache(r,n),this.opacity=1,void 0!==e&&"opacity"in e&&(this.opacity=e.opacity)}function PointTextureLayer(t,i,e,o){Layer.call(this,t,i),this.pointTextureId=e,this.size=48,void 0!==o&&"size"in o&&(this.size=o.size),this.data_=[]}function PolylineLayer(t,i,e){Layer.call(this,t,i),this.color={r:1,g:1,b:1,a:1},void 0!==e&&"color"in e&&(this.color=e.color),this.data_=[]}function GraticuleLayer(t,i){Layer.call(this,t,ProjShaderProgram.COORD_TYPE_SCREEN),this.intervalDegrees=20,void 0!==i&&"intervalDegrees"in i&&(this.intervalDegrees=i.intervalDegrees)}TileManager.prototype.getTileX_=function(t,i){return Math.floor(t*(i-this.tileOrigin[0])/this.rootTileSizeX)},TileManager.prototype.getTileY_=function(t,i){const e=this.inverseY?-1:1;return Math.floor(e*t*(i-this.tileOrigin[1])/this.rootTileSizeY)},TileManager.prototype.getTileNumX_=function(t){return Math.ceil(t*(this.tileDomain.lambda2-this.tileOrigin[0])/this.rootTileSizeX)},TileManager.prototype.getTileNumY_=function(t){const i=this.inverseY?-1:1,e=this.inverseY?this.tileDomain.phi1:this.tileDomain.phi2;return Math.ceil(i*t*(e-this.tileOrigin[1])/this.rootTileSizeY)},TileManager.prototype.getScale_=function(t){return 1<<Math.round(ProjMath.clamp(t,0,this.numLevels-1))},TileManager.prototype.getTileInfos=function(t,i){const e=this.getScale_(i),o=this.getTileNumX_(e),n=LambdaRangeUtils.normalize({min:t.lambda1,max:t.lambda2}),r=this.getTileX_(e,n.min),a=this.getTileX_(e,n.max),s=this.getTileNumY_(e);let h,l;this.inverseY?(h=this.getTileY_(e,t.phi2),l=this.getTileY_(e,t.phi1)):(h=this.getTileY_(e,t.phi1),l=this.getTileY_(e,t.phi2));const c=[];let d=s+1;for(let t=h;t<=l;++t){const n=t%s;if(d==n)break;n<d&&(d=n);let h=o+1;for(let t=r;t<=a;++t){const r=t%o;if(h==r)break;r<h&&(h=r);const a=this.tileUrlDef(i,r,n),s=this.rootTileSizeX*r/e+this.tileOrigin[0],l=this.rootTileSizeX*(r+1)/e+this.tileOrigin[0];let d,p;this.inverseY?(d=-this.rootTileSizeY*(n+1)/e+this.tileOrigin[1],p=-this.rootTileSizeY*n/e+this.tileOrigin[1]):(d=this.rootTileSizeY*n/e+this.tileOrigin[1],p=this.rootTileSizeY*(n+1)/e+this.tileOrigin[1]);let g=null;(s<this.tileDomain.lambda1||d<this.tileDomain.phi1||this.tileDomain.lambda2<l||this.tileDomain.phi2<p)&&(g={x1:0,y1:0,x2:1,y2:1},s<this.tileDomain.lambda1&&(g.x1=(this.tileDomain.lambda1-s)/(l-s)),d<this.tileDomain.phi1&&(g.y1=(this.tileDomain.phi1-d)/(p-d)),this.tileDomain.lambda2<l&&(g.x2=(this.tileDomain.lambda2-s)/(l-s)),this.tileDomain.phi2<p&&(g.y2=(this.tileDomain.phi2-d)/(p-d))),c.push({url:a,rect:{lambda1:s,phi1:d,lambda2:l,phi2:p},clipRect:g})}}return c},ImageCache.prototype.loadImage_=function(t,i,e){this.loading[i]=!0;const o=new Image;null!=this.crossOrigin&&(o.crossOrigin=this.crossOrigin),o.onload=function(){this.ongoingImageLoads.splice(this.ongoingImageLoads.indexOf(o),1);const n=ImageUtils.createTexture(t,o);n&&(this.textures[i]=[n,e]),delete this.loading.url,this.observer_.call(this)}.bind(this),this.ongoingImageLoads.push(o),o.src=i},ImageCache.prototype.loadImageIfAbsent=function(t,i,e){return!(i in this.textures)&&(!(i in this.loading)&&(this.loadImage_(t,i,e),!0))},ImageCache.prototype.getTexture=function(t){return this.textures[t]},ImageCache.prototype.clearOngoingImageLoads=function(){for(let t=0;t<this.ongoingImageLoads.length;t++)this.ongoingImageLoads[t].onload=void 0;this.ongoingImageLoads=[]},CoordTransform.prototype.clone=function(){return new CoordTransform(this.cxx_,this.cxy_,this.cyx_,this.cyy_,this.tx_,this.ty_)},CoordTransform.prototype.equals=function(t){return this.cxx_===t.cxx_&&this.cxy_===t.cxy_&&this.cyx_===t.cyx_&&this.cyy_===t.cyy_&&this.tx_===t.tx_&&this.ty_===t.ty_},CoordTransform.prototype.forwardPoint=function(t,i){return[this.cxx_*t+this.cxy_*i+this.tx_,this.cyx_*t+this.cyy_*i+this.ty_]},CoordTransform.prototype.forwardRectBounds=function(t){let i,e,o,n,r,a,s,h;return t.x1<t.x2?(i=t.x1,e=t.x2):(i=t.x2,e=t.x1),t.y1<t.y2?(o=t.y1,n=t.y2):(o=t.y2,n=t.y1),r=a=this.tx_,s=h=this.ty_,0<=this.cxx_?(r+=this.cxx_*i,a+=this.cxx_*e):(r+=this.cxx_*e,a+=this.cxx_*i),0<=this.cxy_?(r+=this.cxy_*o,a+=this.cxy_*n):(r+=this.cxy_*n,a+=this.cxy_*o),0<=this.cyx_?(s+=this.cyx_*i,h+=this.cyx_*e):(s+=this.cyx_*e,h+=this.cyx_*i),0<=this.cyy_?(s+=this.cyy_*o,h+=this.cyy_*n):(s+=this.cyy_*n,h+=this.cyy_*o),{x1:r,y1:s,x2:a,y2:h}},ViewWindowManager.prototype.calcTransform_=function(){const t=this.viewCenter[0],i=this.viewCenter[1],e=this.viewWindowSize.width/2,o=this.viewWindowSize.height/2,n=this.viewWindowSize.width/this.canvasSize.width,r=this.viewWindowSize.height/this.canvasSize.height,a=this.rot_.cost*n,s=-this.rot_.sint*r,h=t-this.rot_.cost*e-this.rot_.sint*o+this.rot_.sint*r*this.canvasSize.height;return new CoordTransform(a,s,-this.rot_.sint*n,-this.rot_.cost*r,h,i+this.rot_.sint*e-this.rot_.cost*o+this.rot_.cost*r*this.canvasSize.height)},ViewWindowManager.prototype.setRotate=function(t){const i=Math.cos(t),e=Math.sin(t);this.rot_={theta:t,cost:i,sint:e},this.transform_=this.calcTransform_()},ViewWindowManager.prototype.getRotate=function(){return this.rot_.theta},ViewWindowManager.prototype.rotate=function(t){const i=this.rot_.theta+t,e=Math.cos(i),o=Math.sin(i),n=Math.cos(t),r=Math.sin(t),a=this.viewCenter[0]*n+this.viewCenter[1]*r,s=-this.viewCenter[0]*r+this.viewCenter[1]*n;this.viewCenter=[a,s],this.rot_={theta:i,cost:e,sint:o},this.transform_=this.calcTransform_()},ViewWindowManager.prototype.setCanvasSize=function(t){this.canvasSize=Object.assign({},t),this.transform_=this.calcTransform_()},ViewWindowManager.prototype.getCanvasSize=function(){return Object.assign({},this.canvasSize)},ViewWindowManager.prototype.getViewRect=function(){return Object.assign({},this.viewRect_)},ViewWindowManager.prototype.setViewWindowByCenter=function(t,i){this.viewCenter=t.slice(0),this.viewWindowSize=Object.assign({},i),this.transform_=this.calcTransform_()},ViewWindowManager.prototype.setViewWindow=function(t){this.viewCenter=RectangleUtils.getCenter(t),this.viewWindowSize=RectangleUtils.getSize(t),this.setRotate(0)},ViewWindowManager.prototype.getViewWindowBounds=function(){return this.transform_.forwardRectBounds({x1:0,y1:0,x2:this.canvasSize.width,y2:this.canvasSize.height})},ViewWindowManager.prototype.getViewWindowScale=function(){return Math.sqrt(this.viewWindowSize.width*this.viewWindowSize.width+this.viewWindowSize.height*this.viewWindowSize.height)},ViewWindowManager.prototype.getViewRectBoundsFromWindow=function(t){return this.transform_.forwardRectBounds(t)},ViewWindowManager.prototype.setViewWindowCenter=function(t,i){this.viewCenter=[t,i],this.transform_=this.calcTransform_()},ViewWindowManager.prototype.getViewWindowCenter=function(){return this.viewCenter.slice(0)},ViewWindowManager.prototype.moveWindow=function(t,i){const e=this.viewWindowSize.width/this.canvasSize.width,o=this.viewWindowSize.height/this.canvasSize.height,n=this.viewCenter[0]-e*this.rot_.cost*t+o*this.rot_.sint*i,r=this.viewCenter[1]+e*this.rot_.sint*t+o*this.rot_.cost*i;this.viewCenter=[n,r],this.transform_=this.calcTransform_()},ViewWindowManager.prototype.zoomWindow=function(t){const i=(this.canvasSize.height-t)/this.canvasSize.height,e=i*this.viewWindowSize.width/2,o=i*this.viewWindowSize.height/2;null!=this.zoomInLimit_&&(e<this.zoomInLimit_||o<this.zoomInLimit_)||null!=this.zoomOutLimit_&&(this.zoomOutLimit_<e||this.zoomOutLimit_<o)||(this.viewWindowSize={width:2*e,height:2*o},this.transform_=this.calcTransform_())},ViewWindowManager.prototype.getViewPointFromWindow=function(t,i){return this.transform_.forwardPoint(t,i)},GeographicRectBoundsCalculateStrategy_.prototype.calculate=function(t){const i=t-Math.floor(2*t/Math.PI)*Math.PI/2;return i<this.theta0_||Math.PI/2-this.theta0_<i?1:2},MapView.prototype.setProjCenter=function(t,i){this.projection.setProjCenter(t,i),this.imageProj.setProjCenter(t,i),this.invalidateLayers(),this.invalidate()},MapView.prototype.getProjCenter=function(){return this.projection.getProjCenter()},MapView.prototype.getViewRect=function(){return this.viewWindowManager_.getViewRect()},MapView.prototype.getRotate=function(){return this.viewWindowManager_.getRotate()},MapView.prototype.setRotate=function(t){this.viewWindowManager_.setRotate(t),this.invalidate()},MapView.prototype.rotate=function(t){this.viewWindowManager_.rotate(t),this.invalidate()},MapView.prototype.getWindowBounds=function(){return this.viewWindowManager_.getViewWindowBounds()},MapView.prototype.setWindow=function(t){this.viewWindowManager_.setViewWindow(t),this.invalidateLayers(),this.invalidate()},MapView.prototype.setWindowByCenter=function(t,i){this.viewWindowManager_.setViewWindowByCenter(t,i),this.invalidateLayers(),this.invalidate()},MapView.prototype.moveWindow=function(t,i){this.viewWindowManager_.moveWindow(t,i),this.invalidate()},MapView.prototype.zoomWindow=function(t){this.viewWindowManager_.zoomWindow(t),this.invalidate()},MapView.prototype.getViewCenterPoint=function(){return this.viewWindowManager_.getViewWindowCenter()},MapView.prototype.setViewCenterPoint=function(t,i){this.viewWindowManager_.setViewWindowCenter(t,i),this.invalidate()},MapView.prototype.getLambdaPhiPointFromWindow=function(t,i){const e=this.viewWindowManager_.getViewPointFromWindow(t,i);return this.projection.inverse(e[0],e[1])},MapView.prototype.getViewPointFromWindow=function(t,i){return this.viewWindowManager_.getViewPointFromWindow(t,i)},MapView.prototype.getDividedGeographicRectBounds_=function(t){let i=null;for(let e=0;e<t;e++){const o=e*this.viewWindowManager_.canvasSize.height/t,n=(e+1)*this.viewWindowManager_.canvasSize.height/t;for(let e=0;e<t;e++){const r=e*this.viewWindowManager_.canvasSize.width/t,a=(e+1)*this.viewWindowManager_.canvasSize.width/t,s=this.viewWindowManager_.getViewRectBoundsFromWindow({x1:r,y1:o,x2:a,y2:n}),h=this.projection.inverseBoundingBox(s);i=null===i?h:GeographicRectUtils.unionIfIntersects(h,i)}}return i},MapView.prototype.getGeographicRectBounds=function(){const t=this.calcStrategy_.calculate(this.viewWindowManager_.getRotate()),i=this.viewWindowManager_.getViewWindowBounds(),e=this.projection.inverseBoundingBox(i);if(1===t)return e;const o=this.getDividedGeographicRectBounds_(t),n=GeographicRectUtils.intersection(e,o);return n&&1===n.length?n[0]:e},MapView.prototype.invalidate=function(){this.isValid_=!1},MapView.prototype.invalidateLayers=function(){for(let t=0;t<this.layers_.length;++t)this.layers_[t].invalidate()},MapView.prototype.loadData=function(){for(let t=0;t<this.layers_.length;++t)this.layers_[t].loadData(this);this.invalidate()},MapView.prototype.createTexture=function(t){return this.imageProj.createTexture(t)},MapView.prototype.addLayer=function(t){this.layers_.push(t),this.nameToLayers_[t.layerId]=t,this.invalidate()},MapView.prototype.clearLayers=function(){this.layers_.splice(0,this.layers_.length),this.nameToLayers_={},this.invalidate()},MapView.prototype.getLayerById=function(t){return this.nameToLayers_[t]},MapView.prototype.render=function(t){if(!0===t)for(let t=0;t<this.layers_.length;++t)this.layers_[t].markInvalid();else if(!this.requireRender_())return!1;this.imageProj.clear(this.viewWindowManager_.canvasSize);const i=this.projection.getProjCenter();this.imageProj.setProjCenter(i.lambda,i.phi);const e=this.viewWindowManager_.viewCenter,o=this.viewWindowManager_.viewWindowSize,n=this.viewWindowManager_.getRotate();this.imageProj.setTransform(e,o,n),this.imageProj.setCanvasSize(this.viewWindowManager_.canvasSize);for(let t=0;t<this.layers_.length;++t)this.layers_[t].visibility?this.layers_[t].render(this):this.layers_[t].markValid();return this.isValid_=!0,!0},MapView.prototype.requireRender_=function(){if(!this.isValid_)return!0;for(let t=0;t<this.layers_.length;++t)if(!this.layers_[t].isValid())return!0;return!1},Layer.prototype.isValid=function(){return this.isValid_},Layer.prototype.markInvalid=function(){this.isValid_=!1},Layer.prototype.markValid=function(){this.isValid_=!0},Layer.prototype.loadData=function(t){},Layer.prototype.invalidate=function(){this.markInvalid()},Layer.prototype.setVisibility=function(t){this.visibility=t,this.markInvalid()},Layer.prototype.render=function(t){this.markValid()},Object.setPrototypeOf(TileTextureLayer.prototype,Layer.prototype),TileTextureLayer.prototype.invalidate=function(){this.clearTileInfoCache_(),this.markInvalid()},TileTextureLayer.prototype.loadData=function(t){if(null==this.tileManager.tileUrlDef)return-1;const i=this.getTileInfos_(t),e=this.requestImages_(t.imageProj.getGLContext(),i);return this.markInvalid(),e},TileTextureLayer.prototype.setTileUrlDef=function(t){this.tileManager.tileUrlDef=t,this.markInvalid()},TileTextureLayer.prototype.setDataLevelDef=function(t){this.tileManager.dataLevelDef=t,this.markInvalid()},TileTextureLayer.prototype.resetImages=function(){this.imageCache.clearOngoingImageLoads(),this.markInvalid()},TileTextureLayer.prototype.render=function(t){if(null==this.tileManager.tileUrlDef)return;const i=this.getTileInfos_(t);this.requestImages_(t.imageProj.getGLContext(),i);const e=[];for(let t=0;t<i.length;++t){const o=i[t],n=this.imageCache.getTexture(o.url);n&&(n.push(o.clipRect),e.push(n))}if(0<e.length){t.imageProj.setCoordTypeData(),t.imageProj.setOpacity(this.opacity),t.imageProj.prepareRenderSurface();for(let i=0;i<e.length;i++){const o=e[i][0],n=e[i][1],r=e[i][2];t.imageProj.renderSurfaceTexture(o,n,r)}}this.markValid()},TileTextureLayer.prototype.clearTileInfoCache_=function(){this.prevTransform_=null,this.prevTileInfos_=null,this.markInvalid()},TileTextureLayer.prototype.requestImages_=function(t,i){let e=0;for(let o=0;o<i.length;++o)this.imageCache.loadImageIfAbsent(t,i[o].url,i[o].rect)&&++e;return e},TileTextureLayer.prototype.getTileInfos_=function(t){if(null!=this.prevTileInfos_&&null!=this.prevTransform_){if(this.prevTransform_.equals(t.viewWindowManager_.transform_))return this.prevTileInfos_;this.prevTileInfos_=null,this.prevTransform_=null}const i=t.getGeographicRectBounds(),e=t.viewWindowManager_.getViewWindowScale(),o=null!=this.tileManager.dataLevelDef?this.tileManager.dataLevelDef(e,i):0,n=this.tileManager.getTileInfos(i,o);return this.prevTransform_=t.viewWindowManager_.transform_.clone(),this.prevTileInfos_=n,n},Object.setPrototypeOf(PointTextureLayer.prototype,Layer.prototype),PointTextureLayer.prototype.addPoint=function(t,i){this.data_.push(t,i),this.markInvalid()},PointTextureLayer.prototype.addPoints=function(t){this.data_=this.data_.concat(t),this.markInvalid()},PointTextureLayer.prototype.clear=function(){this.data_.splice(0,this.data_.length),this.markInvalid()},PointTextureLayer.prototype.render=function(t){0<this.data_.length&&(t.imageProj.prepareRenderPoints(),t.imageProj.setCoordType(this.coordType),t.imageProj.setPointSize(this.size),t.imageProj.setPointTexture(this.pointTextureId),t.imageProj.renderPoints(this.data_)),this.markValid()},Object.setPrototypeOf(PolylineLayer.prototype,Layer.prototype),PolylineLayer.prototype.addPolyline=function(t){this.data_.push(t),this.markInvalid()},PolylineLayer.prototype.clear=function(){this.data_.splice(0,this.data_.length),this.markInvalid()},PolylineLayer.prototype.render=function(t){if(0<this.data_.length){t.imageProj.prepareRenderPolyline(),t.imageProj.setCoordType(this.coordType),t.imageProj.setColor(this.color);for(let i=0;i<this.data_.length;++i)t.imageProj.renderPolyline(this.data_[i])}this.markValid()},Object.setPrototypeOf(GraticuleLayer.prototype,Layer.prototype),GraticuleLayer.prototype.invalidate=function(){this.markInvalid()},GraticuleLayer.prototype.render=function(t){0<this.intervalDegrees&&(t.imageProj.prepareRenderGraticule(),t.imageProj.renderGraticule(this.intervalDegrees)),this.markValid()},"undefined"!=typeof module&&module.exports&&(module.exports=MapView,module.exports.TileManager=TileManager,module.exports.ViewWindowManager=ViewWindowManager);