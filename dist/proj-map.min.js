/*!
 * Raster Map Projection v0.0.15  2017-05-28
 *   https://github.com/tomosn/raster-map-projection
 * Copyright (C) 2016-2017 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */
"use strict";if("undefined"!=typeof module&&module.exports)var ProjMath=require("./rasterproj-common.js");var TileManager=function(a){this.rootNumX=2,this.rootNumY=1,this.rootTileSizeX=Math.PI,this.rootTileSizeY=Math.PI,this.numLevels=1,this.inverseY=!1,this.tileOrigin=[-Math.PI,-Math.PI/2],"undefined"!=typeof a&&("rootNumX"in a&&(this.rootNumX=a.rootNumX),"rootNumY"in a&&(this.rootNumY=a.rootNumY),"rootTileSizeX"in a&&(this.rootTileSizeX=a.rootTileSizeX),"tileSizeY"in a&&(this.rootTileSizeY=a.rootTileSizeY),"numLevels"in a&&(this.numLevels=a.numLevels),"inverseY"in a&&(this.inverseY=a.inverseY),"tileOrigin"in a&&(this.tileOrigin=a.tileOrigin)),this.rootSizeX=this.rootNumX*this.rootTileSizeX,this.rootSizeY=this.rootNumY*this.rootTileSizeY};TileManager.prototype.getTileX_=function(a,b){return Math.floor(a*(b-this.tileOrigin[0])/this.rootSizeX)},TileManager.prototype.getTileY_=function(a,b){var c=this.inverseY?-1:1;return Math.floor(c*a*(b-this.tileOrigin[1])/this.rootSizeY)},TileManager.prototype.getTileNum_=function(a){var b=Math.round(ProjMath.clamp(a,0,this.numLevels-1)),c=1<<b;return[c*this.rootNumX,c*this.rootNumY]},TileManager.prototype.getTileInfos=function(a,b,c,d){var e,f,g=this.getTileNum_(c),h=g[0],i=g[1],j=this.getTileX_(h,a[0]),k=this.getTileX_(h,a[1]);this.inverseY?(e=this.getTileY_(i,b[1]),f=this.getTileY_(i,b[0])):(e=this.getTileY_(i,b[0]),f=this.getTileY_(i,b[1]));for(var l=[],m=i+1,n=e;n<=f;++n){var o=n%i;if(m==o)break;o<m&&(m=o);for(var p=h+1,q=j;q<=k;++q){var r=q%h;if(p==r)break;r<p&&(p=r);var s,t,u=d(c,r,o),v=this.rootSizeX*r/h+this.tileOrigin[0],w=this.rootSizeX*(r+1)/h+this.tileOrigin[0];this.inverseY?(s=-this.rootSizeY*(o+1)/i+this.tileOrigin[1],t=-this.rootSizeY*o/i+this.tileOrigin[1]):(s=this.rootSizeY*o/i+this.tileOrigin[1],t=this.rootSizeY*(o+1)/i+this.tileOrigin[1]),l.push({url:u,rect:[v,s,w,t]})}}return l};var ImageCache=function(a){this.num=32,this.crossOrigin=null,this.textures={},this.loading={},this.ongoingImageLoads=[],"undefined"!=typeof a&&("num"in a&&(this.num=a.num),"crossOrigin"in a&&(this.crossOrigin=a.crossOrigin)),this.createTexture=null};ImageCache.prototype.loadImage_=function(a,b){this.loading[a]=!0;var c=new Image;null!=this.crossOrigin&&(c.crossOrigin=this.crossOrigin);var d=this;c.onload=function(){if(d.ongoingImageLoads.splice(d.ongoingImageLoads.indexOf(c),1),null!=d.createTexture){var e=d.createTexture(c);e&&(d.textures[a]=[e,b]),delete d.loading.url}},this.ongoingImageLoads.push(c),c.src=a},ImageCache.prototype.loadImageIfAbsent=function(a,b){return!(a in this.textures)&&(!(a in this.loading)&&(this.loadImage_(a,b),!0))},ImageCache.prototype.getTexture=function(a){var b=this.textures[a];return b},ImageCache.prototype.clearOngoingImageLoads=function(){for(var a=0;a<this.ongoingImageLoads.length;a++)this.ongoingImageLoads[a].onload=void 0;this.ongoingImageLoads=[]};var CoordTransform=function(a,b){this.src_x1_=a[0],this.src_y1_=a[1],this.src_x2_=a[2],this.src_y2_=a[3],this.dst_x1_=b[0],this.dst_y1_=b[1],this.dst_x2_=b[2],this.dst_y2_=b[3],this.scaleX_=(b[2]-b[0])/(a[2]-a[0]),this.scaleY_=(b[3]-b[1])/(a[3]-a[1])};CoordTransform.prototype.scaleX=function(){return this.scaleX_},CoordTransform.prototype.scaleY=function(){return this.scaleY_},CoordTransform.prototype.forwardPoint=function(a){var b=this.dst_x1_+(a[0]-this.src_x1_)*this.scaleX_,c=this.dst_y1_+(a[1]-this.src_y1_)*this.scaleY_;return[b,c]},CoordTransform.prototype.forwardRect=function(a){var b=this.forwardPoint([a[0],a[1]]),c=this.forwardPoint([a[2],a[3]]);return[b[0],b[1],c[0],c[1]]};var ViewWindowManager=function(a,b,c){this.canvasSize={width:b.width,height:b.height},this.viewRect_=a,this.zoomInLimit_=null,this.zoomOutLimit_=null,"undefined"!=typeof c&&("zoomInLimit"in c&&(this.zoomInLimit_=c.zoomInLimit),"zoomOutLimit"in c&&(this.zoomOutLimit_=c.zoomOutLimit)),this.rect=this.getViewRect()};ViewWindowManager.prototype.setCanvasSize=function(a,b){this.canvasSize.width=a,this.canvasSize.height=b},ViewWindowManager.prototype.getCanvasSize=function(){return{width:this.canvasSize.width,height:this.canvasSize.height}},ViewWindowManager.prototype.getViewRect=function(){return this.viewRect_.slice(0)},ViewWindowManager.prototype.setViewWindow=function(a,b,c,d){this.rect=[a,b,c,d]},ViewWindowManager.prototype.getViewWindow=function(){return this.rect.slice(0)},ViewWindowManager.prototype.setViewWindowCenter=function(a,b){var c=(this.rect[2]-this.rect[0])/2,d=(this.rect[3]-this.rect[1])/2;this.rect=[a-c,b-d,a+c,b+d]},ViewWindowManager.prototype.getViewWindowCenter=function(){var a=(this.rect[2]+this.rect[0])/2,b=(this.rect[3]+this.rect[1])/2;return[a,b]},ViewWindowManager.prototype.moveWindow=function(a,b){var c=-a*(this.rect[2]-this.rect[0])/this.canvasSize.width,d=b*(this.rect[3]-this.rect[1])/this.canvasSize.height,e=this.rect[0]+c,f=this.rect[1]+d,g=this.rect[2]+c,h=this.rect[3]+d;this.rect=[e,f,g,h]},ViewWindowManager.prototype.zoomWindow=function(a){var b=(this.canvasSize.height-a)/this.canvasSize.height,c=b*(this.rect[2]-this.rect[0])/2,d=b*(this.rect[3]-this.rect[1])/2,e=(this.rect[2]+this.rect[0])/2,f=(this.rect[3]+this.rect[1])/2;null!=this.zoomInLimit_&&(c<this.zoomInLimit_||d<this.zoomInLimit_)||null!=this.zoomOutLimit_&&(this.zoomOutLimit_<c||this.zoomOutLimit_<d)||(this.rect=[e-c,f-d,e+c,f+d])},ViewWindowManager.prototype.getViewPointFromWindow=function(a,b){var c=new CoordTransform([0,this.canvasSize.height,this.canvasSize.width,0],this.rect);return c.forwardPoint([a,b])},ViewWindowManager.prototype.getNormalizedRectAsTriangleStrip=function(){var a=.5,b=.5;return this.canvasSize.width<this.canvasSize.width?b=.5*this.canvasSize.height/this.canvasSize.width:this.canvasSize.width<this.canvasSize.height&&(a=.5*this.canvasSize.width/this.canvasSize.height),new Float32Array([.5-a,.5-b,.5-a,.5+b,.5+a,.5-b,.5+a,.5+b])};var MapView=function(a,b,c,d,e){this.gl=a,this.projection=b,this.imageProj=RasterMapProjection.createShaderProgram(a),this.imageProj.init(b.getVertexShaderStr(),b.getFragmentShaderStr()),this.graticuleRenderer_=new GraticuleRenderer(this.imageProj,this.projection);var f={zoomInLimit:Math.PI/20,zoomOutLimit:20*Math.PI},g=this.projection.getRange();this.viewWindowManager_=new ViewWindowManager(g,c,f),this.tileManager=new TileManager(d),this.prevTileInfos_=null,this.prevWindow_=null,this.imageCache=new ImageCache(e);var h=this;this.imageCache.createTexture=function(a){return h.createTexture(a)},this.centerIcon_=null,this.centerIconSize_=null,this.graticuleInterval=20,this.createUrl=null,this.calculateLevel=null};MapView.prototype.clearTileInfoCache_=function(){this.prevWindow_=null,this.prevTileInfos_=null},MapView.prototype.setCenterIcon=function(a,b){this.centerIcon_=a,this.centerIconSize_=b},MapView.prototype.setProjCenter=function(a,b){this.clearTileInfoCache_(),this.projection.setProjCenter(a,b),this.imageProj.setProjCenter(a,b)},MapView.prototype.getProjCenter=function(){return this.projection.getProjCenter()},MapView.prototype.getViewRect=function(){return this.viewWindowManager_.getViewRect()},MapView.prototype.setWindow=function(a,b,c,d){this.clearTileInfoCache_(),this.viewWindowManager_.setViewWindow(a,b,c,d)},MapView.prototype.moveWindow=function(a,b){this.viewWindowManager_.moveWindow(a,b)},MapView.prototype.zoomWindow=function(a){this.viewWindowManager_.zoomWindow(a)},MapView.prototype.getViewCenterPoint=function(){return this.viewWindowManager_.getViewWindowCenter()},MapView.prototype.setViewCenterPoint=function(a,b){this.viewWindowManager_.setViewWindowCenter(a,b)},MapView.prototype.getLambdaPhiPointFromWindow=function(a,b){var c=this.viewWindowManager_.getViewPointFromWindow(a,b);return this.projection.inverse(c[0],c[1])},MapView.prototype.resetImages=function(){this.imageCache.clearOngoingImageLoads()},MapView.prototype.requestImagesIfNecessary=function(){if(null==this.createUrl)return-1;var a=this.getTileInfos_(),b=this.requestImages_(a);return b},MapView.prototype.render=function(){if(null!=this.createUrl){var a=this.getTileInfos_();this.requestImages_(a),this.render_(a)}},MapView.prototype.createTexture=function(a){return ImageUtils.createTexture(this.gl,a)},MapView.prototype.getTileInfos_=function(){var a=this.viewWindowManager_.getViewWindow();if(null!=this.prevTileInfos_&&null!=this.prevWindow_){if(a[0]==this.prevWindow_[0]&&a[1]==this.prevWindow_[1]&&a[2]==this.prevWindow_[2]&&a[3]==this.prevWindow_[3])return this.prevTileInfos_;this.prevTileInfos_=null,this.prevWindow_=null}var b=this.projection.inverseBoundingBox(a[0],a[1],a[2],a[3]),c=null!=this.calculateLevel?this.calculateLevel(a,b):0,d=this.tileManager.getTileInfos(b.lambda,b.phi,c,this.createUrl);return this.prevWindow_=a,this.prevTileInfos_=d,d},MapView.prototype.requestImages_=function(a){for(var b=0,c=0;c<a.length;++c)this.imageCache.loadImageIfAbsent(a[c].url,a[c].rect)&&++b;return b},MapView.prototype.render_=function(a){this.imageProj.clear(this.viewWindowManager_.canvasSize);var b=this.projection.getProjCenter();this.imageProj.setProjCenter(b.lambda,b.phi);var c=this.viewWindowManager_.getViewWindow();this.imageProj.setViewWindow(c[0],c[1],c[2],c[3]);for(var d=[],e=0;e<a.length;++e){var f=a[e],g=this.imageCache.getTexture(f.url);g&&d.push(g)}if(0<d.length){this.imageProj.setCoordTypeData(),this.imageProj.prepareRenderSurface();for(var h=0;h<d.length;h++){var i=d[h][0],j=d[h][1];this.imageProj.renderSurfaceTexture(i,j)}}if(0<this.graticuleInterval){this.imageProj.setCoordTypeData(),this.imageProj.setColor({r:.88,g:.88,b:.88,a:1});var k=this.projection.inverseBoundingBox(c[0],c[1],c[2],c[3]);this.graticuleRenderer_.renderLines(c,k,this.graticuleInterval)}this.centerIcon_&&(this.imageProj.prepareRenderPoints(),this.imageProj.setCoordTypeXY(),this.imageProj.setPointSize(48),this.imageProj.setPointTexture(this.centerIcon_),this.imageProj.renderPoints([0,0]))},"undefined"!=typeof module&&module.exports&&(module.exports=MapView,module.exports.TileManager=TileManager);