/*!
 * Raster Map Projection v0.0.17  2017-07-23
 *   https://github.com/tomosn/raster-map-projection
 * Copyright (C) 2016-2017 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */

"use strict";if("undefined"!=typeof module&&module.exports)var ProjMath=require("./rasterproj-common.js");var TileManager=function(e){this.rootNumX=2,this.rootNumY=1,this.rootTileSizeX=Math.PI,this.rootTileSizeY=Math.PI,this.numLevels=1,this.inverseY=!1,this.tileOrigin=[-Math.PI,-Math.PI/2],void 0!==e&&("rootNumX"in e&&(this.rootNumX=e.rootNumX),"rootNumY"in e&&(this.rootNumY=e.rootNumY),"rootTileSizeX"in e&&(this.rootTileSizeX=e.rootTileSizeX),"tileSizeY"in e&&(this.rootTileSizeY=e.rootTileSizeY),"numLevels"in e&&(this.numLevels=e.numLevels),"inverseY"in e&&(this.inverseY=e.inverseY),"tileOrigin"in e&&(this.tileOrigin=e.tileOrigin)),this.rootSizeX=this.rootNumX*this.rootTileSizeX,this.rootSizeY=this.rootNumY*this.rootTileSizeY};TileManager.prototype.getTileX_=function(e,t){return Math.floor(e*(t-this.tileOrigin[0])/this.rootSizeX)},TileManager.prototype.getTileY_=function(e,t){var i=this.inverseY?-1:1;return Math.floor(i*e*(t-this.tileOrigin[1])/this.rootSizeY)},TileManager.prototype.getTileNum_=function(e){var t=1<<Math.round(ProjMath.clamp(e,0,this.numLevels-1));return[t*this.rootNumX,t*this.rootNumY]},TileManager.prototype.getTileInfos=function(e,t,i,r){var o,n,a=this.getTileNum_(i),s=a[0],h=a[1],l=this.getTileX_(s,e[0]),c=this.getTileX_(s,e[1]);this.inverseY?(o=this.getTileY_(h,t[1]),n=this.getTileY_(h,t[0])):(o=this.getTileY_(h,t[0]),n=this.getTileY_(h,t[1]));for(var p=[],u=h+1,g=o;g<=n;++g){var d=g%h;if(u==d)break;d<u&&(u=d);for(var y=s+1,m=l;m<=c;++m){var w=m%s;if(y==w)break;w<y&&(y=w);var f,v,_=r(i,w,d),T=this.rootSizeX*w/s+this.tileOrigin[0],L=this.rootSizeX*(w+1)/s+this.tileOrigin[0];this.inverseY?(f=-this.rootSizeY*(d+1)/h+this.tileOrigin[1],v=-this.rootSizeY*d/h+this.tileOrigin[1]):(f=this.rootSizeY*d/h+this.tileOrigin[1],v=this.rootSizeY*(d+1)/h+this.tileOrigin[1]),p.push({url:_,rect:[T,f,L,v]})}}return p};var ImageCache=function(e){this.num=32,this.crossOrigin=null,this.textures={},this.loading={},this.ongoingImageLoads=[],void 0!==e&&("num"in e&&(this.num=e.num),"crossOrigin"in e&&(this.crossOrigin=e.crossOrigin))};ImageCache.prototype.loadImage_=function(e,t,i){this.loading[t]=!0;var r=new Image;null!=this.crossOrigin&&(r.crossOrigin=this.crossOrigin);var o=this;r.onload=function(){o.ongoingImageLoads.splice(o.ongoingImageLoads.indexOf(r),1);var n=ImageUtils.createTexture(e,r);n&&(o.textures[t]=[n,i]),delete o.loading.url},this.ongoingImageLoads.push(r),r.src=t},ImageCache.prototype.loadImageIfAbsent=function(e,t,i){return!(t in this.textures)&&(!(t in this.loading)&&(this.loadImage_(e,t,i),!0))},ImageCache.prototype.getTexture=function(e){return this.textures[e]},ImageCache.prototype.clearOngoingImageLoads=function(){for(var e=0;e<this.ongoingImageLoads.length;e++)this.ongoingImageLoads[e].onload=void 0;this.ongoingImageLoads=[]};var CoordTransform=function(e,t){this.src_x1_=e[0],this.src_y1_=e[1],this.src_x2_=e[2],this.src_y2_=e[3],this.dst_x1_=t[0],this.dst_y1_=t[1],this.dst_x2_=t[2],this.dst_y2_=t[3],this.scaleX_=(t[2]-t[0])/(e[2]-e[0]),this.scaleY_=(t[3]-t[1])/(e[3]-e[1])};CoordTransform.prototype.scaleX=function(){return this.scaleX_},CoordTransform.prototype.scaleY=function(){return this.scaleY_},CoordTransform.prototype.forwardPoint=function(e){return[this.dst_x1_+(e[0]-this.src_x1_)*this.scaleX_,this.dst_y1_+(e[1]-this.src_y1_)*this.scaleY_]},CoordTransform.prototype.forwardRect=function(e){var t=this.forwardPoint([e[0],e[1]]),i=this.forwardPoint([e[2],e[3]]);return[t[0],t[1],i[0],i[1]]};var ViewWindowManager=function(e,t,i){this.canvasSize={width:t.width,height:t.height},this.viewRect_=e,this.zoomInLimit_=null,this.zoomOutLimit_=null,void 0!==i&&("zoomInLimit"in i&&(this.zoomInLimit_=i.zoomInLimit),"zoomOutLimit"in i&&(this.zoomOutLimit_=i.zoomOutLimit)),this.rect=this.getViewRect()};ViewWindowManager.prototype.setCanvasSize=function(e,t){this.canvasSize.width=e,this.canvasSize.height=t},ViewWindowManager.prototype.getCanvasSize=function(){return{width:this.canvasSize.width,height:this.canvasSize.height}},ViewWindowManager.prototype.getViewRect=function(){return this.viewRect_.slice(0)},ViewWindowManager.prototype.setViewWindow=function(e,t,i,r){this.rect=[e,t,i,r]},ViewWindowManager.prototype.getViewWindow=function(){return this.rect.slice(0)},ViewWindowManager.prototype.setViewWindowCenter=function(e,t){var i=(this.rect[2]-this.rect[0])/2,r=(this.rect[3]-this.rect[1])/2;this.rect=[e-i,t-r,e+i,t+r]},ViewWindowManager.prototype.getViewWindowCenter=function(){return[(this.rect[2]+this.rect[0])/2,(this.rect[3]+this.rect[1])/2]},ViewWindowManager.prototype.moveWindow=function(e,t){var i=-e*(this.rect[2]-this.rect[0])/this.canvasSize.width,r=t*(this.rect[3]-this.rect[1])/this.canvasSize.height,o=this.rect[0]+i,n=this.rect[1]+r,a=this.rect[2]+i,s=this.rect[3]+r;this.rect=[o,n,a,s]},ViewWindowManager.prototype.zoomWindow=function(e){var t=(this.canvasSize.height-e)/this.canvasSize.height,i=t*(this.rect[2]-this.rect[0])/2,r=t*(this.rect[3]-this.rect[1])/2,o=(this.rect[2]+this.rect[0])/2,n=(this.rect[3]+this.rect[1])/2;null!=this.zoomInLimit_&&(i<this.zoomInLimit_||r<this.zoomInLimit_)||null!=this.zoomOutLimit_&&(this.zoomOutLimit_<i||this.zoomOutLimit_<r)||(this.rect=[o-i,n-r,o+i,n+r])},ViewWindowManager.prototype.getViewPointFromWindow=function(e,t){return new CoordTransform([0,this.canvasSize.height,this.canvasSize.width,0],this.rect).forwardPoint([e,t])};var MapView=function(e,t,i,r,o){this.gl=e,this.projection=t,this.imageProj=RasterMapProjection.createShaderProgram(e),this.imageProj.init(t.getVertexShaderStr(),t.getFragmentShaderStr());var n={zoomInLimit:Math.PI/20,zoomOutLimit:20*Math.PI},a=this.projection.getRange();this.viewWindowManager_=new ViewWindowManager(a,i,n),this.layers_=[],this.nameToLayers_={}};MapView.prototype.setProjCenter=function(e,t){this.invalidateLayers(),this.projection.setProjCenter(e,t),this.imageProj.setProjCenter(e,t)},MapView.prototype.getProjCenter=function(){return this.projection.getProjCenter()},MapView.prototype.getViewRect=function(){return this.viewWindowManager_.getViewRect()},MapView.prototype.getWindow=function(){return this.viewWindowManager_.getViewWindow()},MapView.prototype.setWindow=function(e,t,i,r){this.invalidateLayers(),this.viewWindowManager_.setViewWindow(e,t,i,r)},MapView.prototype.moveWindow=function(e,t){this.viewWindowManager_.moveWindow(e,t)},MapView.prototype.zoomWindow=function(e){this.viewWindowManager_.zoomWindow(e)},MapView.prototype.getViewCenterPoint=function(){return this.viewWindowManager_.getViewWindowCenter()},MapView.prototype.setViewCenterPoint=function(e,t){this.viewWindowManager_.setViewWindowCenter(e,t)},MapView.prototype.getLambdaPhiPointFromWindow=function(e,t){var i=this.viewWindowManager_.getViewPointFromWindow(e,t);return this.projection.inverse(i[0],i[1])},MapView.prototype.invalidateLayers=function(){for(var e=0;e<this.layers_.length;++e)this.layers_[e].invalidate()},MapView.prototype.loadData=function(){for(var e=0;e<this.layers_.length;++e)this.layers_[e].loadData(this)},MapView.prototype.createTexture=function(e){return ImageUtils.createTexture(this.gl,e)},MapView.prototype.addLayer=function(e){this.layers_.push(e),this.nameToLayers_[e.layerId]=e},MapView.prototype.clearLayers=function(){this.layers_.clear(),this.nameToLayers_={}},MapView.prototype.getLayerById=function(e){return this.nameToLayers_[e]},MapView.prototype.render=function(){this.imageProj.clear(this.viewWindowManager_.canvasSize);var e=this.projection.getProjCenter();this.imageProj.setProjCenter(e.lambda,e.phi);var t=this.viewWindowManager_.getViewWindow();this.imageProj.setViewWindow(t[0],t[1],t[2],t[3]);for(var i=0;i<this.layers_.length;++i)this.layers_[i].render(this)};var Layer=function(e,t){this.layerId=e,this.coordType=t};Layer.prototype.loadData=function(e){},Layer.prototype.invalidate=function(){},Layer.prototype.render=function(e){throw new Error("Not Implemented")};var TileTextureLayer=function(e,t,i,r,o){Layer.call(this,e,t),this.tileManager=new TileManager(r),this.prevTileInfos_=null,this.prevWindow_=null,this.imageCache=new ImageCache(o),this.tileUrlDef=null,this.dataLevelDef=null,this.opacity=1,void 0!==i&&"opacity"in i&&(this.opacity=i.opacity)};Object.setPrototypeOf(TileTextureLayer.prototype,Layer.prototype),TileTextureLayer.prototype.invalidate=function(){this.clearTileInfoCache_()},TileTextureLayer.prototype.loadData=function(e){if(null==this.tileUrlDef)return-1;var t=this.getTileInfos_(e);return this.requestImages_(e.gl,t)},TileTextureLayer.prototype.resetImages=function(){this.imageCache.clearOngoingImageLoads()},TileTextureLayer.prototype.render=function(e){if(null!=this.tileUrlDef){var t=this.getTileInfos_(e);this.requestImages_(e.gl,t);for(var i=[],r=0;r<t.length;++r){var o=t[r],n=this.imageCache.getTexture(o.url);n&&i.push(n)}if(0!=i.length){e.imageProj.setCoordTypeData(),e.imageProj.setOpacity(this.opacity),e.imageProj.prepareRenderSurface();for(var a=0;a<i.length;a++){var s=i[a][0],h=i[a][1];e.imageProj.renderSurfaceTexture(s,h)}}}},TileTextureLayer.prototype.clearTileInfoCache_=function(){this.prevWindow_=null,this.prevTileInfos_=null},TileTextureLayer.prototype.requestImages_=function(e,t){for(var i=0,r=0;r<t.length;++r)this.imageCache.loadImageIfAbsent(e,t[r].url,t[r].rect)&&++i;return i},TileTextureLayer.prototype.getTileInfos_=function(e){var t=e.viewWindowManager_.getViewWindow();if(null!=this.prevTileInfos_&&null!=this.prevWindow_){if(t[0]==this.prevWindow_[0]&&t[1]==this.prevWindow_[1]&&t[2]==this.prevWindow_[2]&&t[3]==this.prevWindow_[3])return this.prevTileInfos_;this.prevTileInfos_=null,this.prevWindow_=null}var i=e.projection.inverseBoundingBox(t[0],t[1],t[2],t[3]),r=null!=this.dataLevelDef?this.dataLevelDef(t,i):0,o=this.tileManager.getTileInfos(i.lambda,i.phi,r,this.tileUrlDef);return this.prevWindow_=t,this.prevTileInfos_=o,o};var PointTextureLayer=function(e,t,i,r){Layer.call(this,e,t),this.pointTextureId=i,this.size=48,void 0!==r&&"size"in r&&(this.size=r.size),this.data_=[]};Object.setPrototypeOf(PointTextureLayer.prototype,Layer.prototype),PointTextureLayer.prototype.addPoint=function(e,t){this.data_.push(e,t)},PointTextureLayer.prototype.addPoints=function(e){this.data_=this.data_.concat(e)},PointTextureLayer.prototype.clear=function(){this.data_.clear()},PointTextureLayer.prototype.render=function(e){0!==this.data_.length&&(e.imageProj.prepareRenderPoints(),e.imageProj.setCoordType(this.coordType),e.imageProj.setPointSize(this.size),e.imageProj.setPointTexture(this.pointTextureId),e.imageProj.renderPoints(this.data_))};var PolylineLayer=function(e,t,i){Layer.call(this,e,t),this.color={r:1,g:1,b:1,a:1},void 0!==i&&"color"in i&&(this.color=i.color),this.data_=[]};Object.setPrototypeOf(PolylineLayer.prototype,Layer.prototype),PolylineLayer.prototype.addPolyline=function(e){this.data_.push(e)},PolylineLayer.prototype.clear=function(){this.data_.clear()},PolylineLayer.prototype.render=function(e){if(0!==this.data_.length){e.imageProj.prepareRenderPolyline(),e.imageProj.setCoordType(this.coordType),e.imageProj.setColor(this.color);for(var t=0;t<this.data_.length;++t)e.imageProj.renderPolyline(this.data_[t])}};var GraticuleLayer=function(e,t){Layer.call(this,e,ProjShaderProgram.COORD_TYPE_DATA),this.graticuleRenderer_=null,this.color={r:.88,g:.88,b:.88,a:1},this.intervalDegrees=20,void 0!==t&&("color"in t&&(this.color=t.color),"intervalDegrees"in t&&(this.intervalDegrees=t.intervalDegrees))};Object.setPrototypeOf(GraticuleLayer.prototype,Layer.prototype),GraticuleLayer.prototype.invalidate=function(){this.graticuleRenderer_=null},GraticuleLayer.prototype.render=function(e){if(!(this.intervalDegrees<=0)){null==this.graticuleRenderer_&&(this.graticuleRenderer_=new GraticuleRenderer(e.imageProj,e.projection)),e.imageProj.setCoordTypeData(),e.imageProj.setColor(this.color);var t=e.getWindow(),i=e.projection.inverseBoundingBox(t[0],t[1],t[2],t[3]);this.graticuleRenderer_.renderLines(t,i,this.intervalDegrees)}},"undefined"!=typeof module&&module.exports&&(module.exports=MapView,module.exports.TileManager=TileManager);