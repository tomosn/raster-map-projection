/*!
 * RasterMapProjection v0.0.26  2018-12-30
 *   https://github.com/tomosn/raster-map-projection
 *   A JavaScript library for on-the-fly map projection of raster tiles using WebGL.
 * Copyright (C) 2016-2018 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */

"use strict";if("undefined"!=typeof module&&module.exports)var RasterProjCommon=require("./rasterproj-common.js"),LambdaRangeUtils=RasterProjCommon.LambdaRangeRectUtils,GeographicRectUtils=RasterProjCommon.GeographicRectUtils,ProjMath=RasterProjCommon.ProjMath;function TileManager(t){this.rootNumX=2,this.rootNumY=1,this.rootTileSizeX=Math.PI,this.rootTileSizeY=Math.PI,this.numLevels=1,this.inverseY=!1,this.tileOrigin=[-Math.PI,-Math.PI/2],this.tileDomain=[-Math.PI,-Math.PI/2,+Math.PI,+Math.PI/2],this.dataLevelDef=null,this.tileUrlDef=null,void 0!==t&&("rootNumX"in t&&(this.rootNumX=t.rootNumX),"rootNumY"in t&&(this.rootNumY=t.rootNumY),"rootTileSizeX"in t&&(this.rootTileSizeX=t.rootTileSizeX),"rootTileSizeY"in t&&(this.rootTileSizeY=t.rootTileSizeY),"numLevels"in t&&(this.numLevels=t.numLevels),"inverseY"in t&&(this.inverseY=t.inverseY),"tileOrigin"in t&&(this.tileOrigin=t.tileOrigin),"dataLevelDef"in t&&(this.dataLevelDef=t.dataLevelDef),"tileUrlDef"in t&&(this.tileUrlDef=t.tileUrlDef))}function ImageCache(t,i){this.num=32,this.crossOrigin=null,this.textures={},this.loading={},this.ongoingImageLoads=[],this.observer_=t,void 0!==i&&("num"in i&&(this.num=i.num),"crossOrigin"in i&&(this.crossOrigin=i.crossOrigin))}function CoordTransform(t,i,e,o,n,r){this.cxx_=t,this.cxy_=i,this.cyx_=e,this.cyy_=o,this.tx_=n,this.ty_=r}function ViewWindowManager(t,i,e){this.canvasSize={width:i.width,height:i.height},this.viewRect_=t,this.zoomInLimit_=null,this.zoomOutLimit_=null,void 0!==e&&("zoomInLimit"in e&&(this.zoomInLimit_=e.zoomInLimit),"zoomOutLimit"in e&&(this.zoomOutLimit_=e.zoomOutLimit));const o=(this.viewRect_[2]+this.viewRect_[0])/2,n=(this.viewRect_[3]+this.viewRect_[1])/2,r=this.viewRect_[2]-this.viewRect_[0],s=this.viewRect_[3]-this.viewRect_[1];this.viewCenter=[o,n],this.viewWindowSize=[r,s],this.rot_=null,this.setRotate(0),this.transform_=this.calcTransform_()}function GeographicRectBoundsCalculateStrategy_(t){this.theta0_=t}function MapView(t,i,e){this.imageProj=t,this.projection=i;const o={zoomInLimit:Math.PI/20,zoomOutLimit:20*Math.PI},n=this.projection.getRange();this.viewWindowManager_=new ViewWindowManager(n,e,o),this.calcStrategy_=new GeographicRectBoundsCalculateStrategy_(Math.PI/16),this.layers_=[],this.nameToLayers_={},this.isValid_=!1}function Layer(t,i){this.layerId=t,this.coordType=i,this.visibility=!0,this.isValid_=!1}function TileTextureLayer(t,i,e,o,n){Layer.call(this,t,i),this.tileManager=new TileManager(o),this.prevTileInfos_=null,this.prevTransform_=null;const r=function(){this.markInvalid()}.bind(this);this.imageCache=new ImageCache(r,n),this.opacity=1,void 0!==e&&"opacity"in e&&(this.opacity=e.opacity)}function PointTextureLayer(t,i,e,o){Layer.call(this,t,i),this.pointTextureId=e,this.size=48,void 0!==o&&"size"in o&&(this.size=o.size),this.data_=[]}function PolylineLayer(t,i,e){Layer.call(this,t,i),this.color={r:1,g:1,b:1,a:1},void 0!==e&&"color"in e&&(this.color=e.color),this.data_=[]}function GraticuleLayer(t,i){Layer.call(this,t,ProjShaderProgram.COORD_TYPE_DATA),this.graticuleRenderer_=null,this.color={r:.88,g:.88,b:.88,a:1},this.intervalDegrees=20,void 0!==i&&("color"in i&&(this.color=i.color),"intervalDegrees"in i&&(this.intervalDegrees=i.intervalDegrees))}TileManager.prototype.getTileX_=function(t,i){return Math.floor(t*(i-this.tileOrigin[0])/this.rootTileSizeX)},TileManager.prototype.getTileY_=function(t,i){const e=this.inverseY?-1:1;return Math.floor(e*t*(i-this.tileOrigin[1])/this.rootTileSizeY)},TileManager.prototype.getTileNumX_=function(t){return Math.ceil(t*(this.tileDomain[2]-this.tileOrigin[0])/this.rootTileSizeX)},TileManager.prototype.getTileNumY_=function(t){const i=this.inverseY?-1:1,e=this.inverseY?this.tileDomain[1]:this.tileDomain[3];return Math.ceil(i*t*(e-this.tileOrigin[1])/this.rootTileSizeY)},TileManager.prototype.getScale_=function(t){return 1<<Math.round(ProjMath.clamp(t,0,this.numLevels-1))},TileManager.prototype.getTileInfos=function(t,i){const e=this.getScale_(i),o=this.getTileNumX_(e),n=LambdaRangeUtils.normalize(t.lambda),r=this.getTileX_(e,n[0]),s=this.getTileX_(e,n[1]),a=this.getTileNumY_(e);let h,l;this.inverseY?(h=this.getTileY_(e,t.phi[1]),l=this.getTileY_(e,t.phi[0])):(h=this.getTileY_(e,t.phi[0]),l=this.getTileY_(e,t.phi[1]));const c=[];let d=a+1;for(let t=h;t<=l;++t){const n=t%a;if(d==n)break;n<d&&(d=n);let h=o+1;for(let t=r;t<=s;++t){const r=t%o;if(h==r)break;r<h&&(h=r);const s=this.tileUrlDef(i,r,n),a=this.rootTileSizeX*r/e+this.tileOrigin[0],l=this.rootTileSizeX*(r+1)/e+this.tileOrigin[0];let d,p;this.inverseY?(d=-this.rootTileSizeY*(n+1)/e+this.tileOrigin[1],p=-this.rootTileSizeY*n/e+this.tileOrigin[1]):(d=this.rootTileSizeY*n/e+this.tileOrigin[1],p=this.rootTileSizeY*(n+1)/e+this.tileOrigin[1]);let u=null;(a<this.tileDomain[0]||d<this.tileDomain[1]||this.tileDomain[2]<l||this.tileDomain[3]<p)&&(u=[0,0,1,1],a<this.tileDomain[0]&&(u[0]=(this.tileDomain[0]-a)/(l-a)),d<this.tileDomain[1]&&(u[1]=(this.tileDomain[1]-d)/(p-d)),this.tileDomain[2]<l&&(u[2]=(this.tileDomain[2]-a)/(l-a)),this.tileDomain[3]<p&&(u[3]=(this.tileDomain[3]-d)/(p-d))),c.push({url:s,rect:[a,d,l,p],clipRect:u})}}return c},ImageCache.prototype.loadImage_=function(t,i,e){this.loading[i]=!0;const o=new Image;null!=this.crossOrigin&&(o.crossOrigin=this.crossOrigin),o.onload=function(){this.ongoingImageLoads.splice(this.ongoingImageLoads.indexOf(o),1);const n=ImageUtils.createTexture(t,o);n&&(this.textures[i]=[n,e]),delete this.loading.url,this.observer_.call(this)}.bind(this),this.ongoingImageLoads.push(o),o.src=i},ImageCache.prototype.loadImageIfAbsent=function(t,i,e){return!(i in this.textures)&&(!(i in this.loading)&&(this.loadImage_(t,i,e),!0))},ImageCache.prototype.getTexture=function(t){return this.textures[t]},ImageCache.prototype.clearOngoingImageLoads=function(){for(let t=0;t<this.ongoingImageLoads.length;t++)this.ongoingImageLoads[t].onload=void 0;this.ongoingImageLoads=[]},CoordTransform.prototype.clone=function(){return new CoordTransform(this.cxx_,this.cxy_,this.cyx_,this.cyy_,this.tx_,this.ty_)},CoordTransform.prototype.equals=function(t){return this.cxx_===t.cxx_&&this.cxy_===t.cxy_&&this.cyx_===t.cyx_&&this.cyy_===t.cyy_&&this.tx_===t.tx_&&this.ty_===t.ty_},CoordTransform.prototype.forwardPoint=function(t,i){return[this.cxx_*t+this.cxy_*i+this.tx_,this.cyx_*t+this.cyy_*i+this.ty_]},CoordTransform.prototype.forwardRectBounds=function(t,i,e,o){let n,r,s,a,h,l,c,d;return t<e?(n=t,r=e):(n=e,r=t),i<o?(s=i,a=o):(s=o,a=i),h=l=this.tx_,c=d=this.ty_,0<=this.cxx_?(h+=this.cxx_*n,l+=this.cxx_*r):(h+=this.cxx_*r,l+=this.cxx_*n),0<=this.cxy_?(h+=this.cxy_*s,l+=this.cxy_*a):(h+=this.cxy_*a,l+=this.cxy_*s),0<=this.cyx_?(c+=this.cyx_*n,d+=this.cyx_*r):(c+=this.cyx_*r,d+=this.cyx_*n),0<=this.cyy_?(c+=this.cyy_*s,d+=this.cyy_*a):(c+=this.cyy_*a,d+=this.cyy_*s),[h,c,l,d]},ViewWindowManager.prototype.calcTransform_=function(){const t=this.viewCenter[0],i=this.viewCenter[1],e=this.viewWindowSize[0]/2,o=this.viewWindowSize[1]/2,n=this.viewWindowSize[0]/this.canvasSize.width,r=this.viewWindowSize[1]/this.canvasSize.height,s=this.rot_.cost*n,a=-this.rot_.sint*r,h=t-this.rot_.cost*e-this.rot_.sint*o+this.rot_.sint*r*this.canvasSize.height;return new CoordTransform(s,a,-this.rot_.sint*n,-this.rot_.cost*r,h,i+this.rot_.sint*e-this.rot_.cost*o+this.rot_.cost*r*this.canvasSize.height)},ViewWindowManager.prototype.setRotate=function(t){const i=Math.cos(t),e=Math.sin(t);this.rot_={theta:t,cost:i,sint:e},this.transform_=this.calcTransform_()},ViewWindowManager.prototype.getRotate=function(){return this.rot_.theta},ViewWindowManager.prototype.rotate=function(t){const i=this.rot_.theta+t,e=Math.cos(i),o=Math.sin(i),n=Math.cos(t),r=Math.sin(t),s=this.viewCenter[0]*n+this.viewCenter[1]*r,a=-this.viewCenter[0]*r+this.viewCenter[1]*n;this.viewCenter=[s,a],this.rot_={theta:i,cost:e,sint:o},this.transform_=this.calcTransform_()},ViewWindowManager.prototype.setCanvasSize=function(t,i){this.canvasSize.width=t,this.canvasSize.height=i,this.transform_=this.calcTransform_()},ViewWindowManager.prototype.getCanvasSize=function(){return{width:this.canvasSize.width,height:this.canvasSize.height}},ViewWindowManager.prototype.getViewRect=function(){return this.viewRect_.slice(0)},ViewWindowManager.prototype.setViewWindowByCenter=function(t,i,e,o){this.viewCenter=[t,i],this.viewWindowSize=[e,o],this.transform_=this.calcTransform_()},ViewWindowManager.prototype.setViewWindow=function(t,i,e,o){const n=(e+t)/2,r=(o+i)/2,s=e-t,a=o-i;this.viewCenter=[n,r],this.viewWindowSize=[s,a],this.setRotate(0)},ViewWindowManager.prototype.getViewWindowBounds=function(){return this.transform_.forwardRectBounds(0,0,this.canvasSize.width,this.canvasSize.height)},ViewWindowManager.prototype.getViewWindowScale=function(){return Math.sqrt(this.viewWindowSize[0]*this.viewWindowSize[0]+this.viewWindowSize[1]*this.viewWindowSize[1])},ViewWindowManager.prototype.getViewRectBoundsFromWindow=function(t,i,e,o){return this.transform_.forwardRectBounds(t,i,e,o)},ViewWindowManager.prototype.setViewWindowCenter=function(t,i){this.viewCenter=[t,i],this.transform_=this.calcTransform_()},ViewWindowManager.prototype.getViewWindowCenter=function(){return this.viewCenter.slice(0)},ViewWindowManager.prototype.moveWindow=function(t,i){const e=this.viewWindowSize[0]/this.canvasSize.width,o=this.viewWindowSize[1]/this.canvasSize.height,n=this.viewCenter[0]-e*this.rot_.cost*t+o*this.rot_.sint*i,r=this.viewCenter[1]+e*this.rot_.sint*t+o*this.rot_.cost*i;this.viewCenter=[n,r],this.transform_=this.calcTransform_()},ViewWindowManager.prototype.zoomWindow=function(t){const i=(this.canvasSize.height-t)/this.canvasSize.height,e=i*this.viewWindowSize[0]/2,o=i*this.viewWindowSize[1]/2;null!=this.zoomInLimit_&&(e<this.zoomInLimit_||o<this.zoomInLimit_)||null!=this.zoomOutLimit_&&(this.zoomOutLimit_<e||this.zoomOutLimit_<o)||(this.viewWindowSize=[2*e,2*o],this.transform_=this.calcTransform_())},ViewWindowManager.prototype.getViewPointFromWindow=function(t,i){return this.transform_.forwardPoint(t,i)},GeographicRectBoundsCalculateStrategy_.prototype.calculate=function(t){const i=t-Math.floor(2*t/Math.PI)*Math.PI/2;return i<this.theta0_||Math.PI/2-this.theta0_<i?1:2},MapView.prototype.setProjCenter=function(t,i){this.projection.setProjCenter(t,i),this.imageProj.setProjCenter(t,i),this.invalidateLayers(),this.invalidate()},MapView.prototype.getProjCenter=function(){return this.projection.getProjCenter()},MapView.prototype.getViewRect=function(){return this.viewWindowManager_.getViewRect()},MapView.prototype.getRotate=function(){return this.viewWindowManager_.getRotate()},MapView.prototype.setRotate=function(t){this.viewWindowManager_.setRotate(t),this.invalidate()},MapView.prototype.rotate=function(t){this.viewWindowManager_.rotate(t),this.invalidate()},MapView.prototype.getWindowBounds=function(){return this.viewWindowManager_.getViewWindowBounds()},MapView.prototype.setWindow=function(t,i,e,o){this.viewWindowManager_.setViewWindow(t,i,e,o),this.invalidateLayers(),this.invalidate()},MapView.prototype.setWindowByCenter=function(t,i,e,o){this.viewWindowManager_.setViewWindowByCenter(t,i,e,o),this.invalidateLayers(),this.invalidate()},MapView.prototype.moveWindow=function(t,i){this.viewWindowManager_.moveWindow(t,i),this.invalidate()},MapView.prototype.zoomWindow=function(t){this.viewWindowManager_.zoomWindow(t),this.invalidate()},MapView.prototype.getViewCenterPoint=function(){return this.viewWindowManager_.getViewWindowCenter()},MapView.prototype.setViewCenterPoint=function(t,i){this.viewWindowManager_.setViewWindowCenter(t,i),this.invalidate()},MapView.prototype.getLambdaPhiPointFromWindow=function(t,i){const e=this.viewWindowManager_.getViewPointFromWindow(t,i);return this.projection.inverse(e[0],e[1])},MapView.prototype.getViewPointFromWindow=function(t,i){return this.viewWindowManager_.getViewPointFromWindow(t,i)},MapView.prototype.getDividedGeographicRectBounds_=function(t){let i=null;for(let e=0;e<t;e++){const o=e*this.viewWindowManager_.canvasSize.height/t,n=(e+1)*this.viewWindowManager_.canvasSize.height/t;for(let e=0;e<t;e++){const r=e*this.viewWindowManager_.canvasSize.width/t,s=(e+1)*this.viewWindowManager_.canvasSize.width/t,a=this.viewWindowManager_.getViewRectBoundsFromWindow(r,o,s,n),h=this.projection.inverseBoundingBox(a[0],a[1],a[2],a[3]);i=null===i?h:GeographicRectUtils.union(h,i)}}return i},MapView.prototype.getGeographicRectBounds=function(){const t=this.calcStrategy_.calculate(this.viewWindowManager_.getRotate()),i=this.viewWindowManager_.getViewWindowBounds(),e=this.projection.inverseBoundingBox(i[0],i[1],i[2],i[3]);if(1===t)return e;const o=this.getDividedGeographicRectBounds_(t);return GeographicRectUtils.intersection(e,o)},MapView.prototype.invalidate=function(){this.isValid_=!1},MapView.prototype.invalidateLayers=function(){for(let t=0;t<this.layers_.length;++t)this.layers_[t].invalidate()},MapView.prototype.loadData=function(){for(let t=0;t<this.layers_.length;++t)this.layers_[t].loadData(this);this.invalidate()},MapView.prototype.createTexture=function(t){return this.imageProj.createTexture(t)},MapView.prototype.addLayer=function(t){this.layers_.push(t),this.nameToLayers_[t.layerId]=t,this.invalidate()},MapView.prototype.clearLayers=function(){this.layers_.splice(0,this.layers_.length),this.nameToLayers_={},this.invalidate()},MapView.prototype.getLayerById=function(t){return this.nameToLayers_[t]},MapView.prototype.render=function(t){if(!0===t)for(let t=0;t<this.layers_.length;++t)this.layers_[t].markInvalid();else if(!this.requireRender_())return!1;this.imageProj.clear(this.viewWindowManager_.canvasSize);const i=this.projection.getProjCenter();this.imageProj.setProjCenter(i.lambda,i.phi);const e=this.viewWindowManager_.viewCenter,o=this.viewWindowManager_.viewWindowSize,n=this.viewWindowManager_.getRotate();this.imageProj.setTransform(e[0],e[1],o[0],o[1],n);for(let t=0;t<this.layers_.length;++t)this.layers_[t].visibility?this.layers_[t].render(this):this.layers_[t].markValid();return this.isValid_=!0,!0},MapView.prototype.requireRender_=function(){if(!this.isValid_)return!0;for(let t=0;t<this.layers_.length;++t)if(!this.layers_[t].isValid())return!0;return!1},Layer.prototype.isValid=function(){return this.isValid_},Layer.prototype.markInvalid=function(){this.isValid_=!1},Layer.prototype.markValid=function(){this.isValid_=!0},Layer.prototype.loadData=function(t){},Layer.prototype.invalidate=function(){this.markInvalid()},Layer.prototype.setVisibility=function(t){this.visibility=t,this.markInvalid()},Layer.prototype.render=function(t){this.markValid()},Object.setPrototypeOf(TileTextureLayer.prototype,Layer.prototype),TileTextureLayer.prototype.invalidate=function(){this.clearTileInfoCache_(),this.markInvalid()},TileTextureLayer.prototype.loadData=function(t){if(null==this.tileManager.tileUrlDef)return-1;const i=this.getTileInfos_(t),e=this.requestImages_(t.imageProj.getGLContext(),i);return this.markInvalid(),e},TileTextureLayer.prototype.setTileUrlDef=function(t){this.tileManager.tileUrlDef=t,this.markInvalid()},TileTextureLayer.prototype.setDataLevelDef=function(t){this.tileManager.dataLevelDef=t,this.markInvalid()},TileTextureLayer.prototype.resetImages=function(){this.imageCache.clearOngoingImageLoads(),this.markInvalid()},TileTextureLayer.prototype.render=function(t){if(null==this.tileManager.tileUrlDef)return;const i=this.getTileInfos_(t);this.requestImages_(t.imageProj.getGLContext(),i);const e=[];for(let t=0;t<i.length;++t){const o=i[t],n=this.imageCache.getTexture(o.url);n&&(n.push(o.clipRect),e.push(n))}if(0<e.length){t.imageProj.setCoordTypeData(),t.imageProj.setOpacity(this.opacity),t.imageProj.prepareRenderSurface();for(let i=0;i<e.length;i++){const o=e[i][0],n=e[i][1],r=e[i][2];t.imageProj.renderSurfaceTexture(o,n,r)}}this.markValid()},TileTextureLayer.prototype.clearTileInfoCache_=function(){this.prevTransform_=null,this.prevTileInfos_=null,this.markInvalid()},TileTextureLayer.prototype.requestImages_=function(t,i){let e=0;for(let o=0;o<i.length;++o)this.imageCache.loadImageIfAbsent(t,i[o].url,i[o].rect)&&++e;return e},TileTextureLayer.prototype.getTileInfos_=function(t){if(null!=this.prevTileInfos_&&null!=this.prevTransform_){if(this.prevTransform_.equals(t.viewWindowManager_.transform_))return this.prevTileInfos_;this.prevTileInfos_=null,this.prevTransform_=null}const i=t.getGeographicRectBounds(),e=t.viewWindowManager_.getViewWindowScale(),o=null!=this.tileManager.dataLevelDef?this.tileManager.dataLevelDef(e,i):0,n=this.tileManager.getTileInfos(i,o);return this.prevTransform_=t.viewWindowManager_.transform_.clone(),this.prevTileInfos_=n,n},Object.setPrototypeOf(PointTextureLayer.prototype,Layer.prototype),PointTextureLayer.prototype.addPoint=function(t,i){this.data_.push(t,i),this.markInvalid()},PointTextureLayer.prototype.addPoints=function(t){this.data_=this.data_.concat(t),this.markInvalid()},PointTextureLayer.prototype.clear=function(){this.data_.splice(0,this.data_.length),this.markInvalid()},PointTextureLayer.prototype.render=function(t){0<this.data_.length&&(t.imageProj.prepareRenderPoints(),t.imageProj.setCoordType(this.coordType),t.imageProj.setPointSize(this.size),t.imageProj.setPointTexture(this.pointTextureId),t.imageProj.renderPoints(this.data_)),this.markValid()},Object.setPrototypeOf(PolylineLayer.prototype,Layer.prototype),PolylineLayer.prototype.addPolyline=function(t){this.data_.push(t),this.markInvalid()},PolylineLayer.prototype.clear=function(){this.data_.splice(0,this.data_.length),this.markInvalid()},PolylineLayer.prototype.render=function(t){if(0<this.data_.length){t.imageProj.prepareRenderPolyline(),t.imageProj.setCoordType(this.coordType),t.imageProj.setColor(this.color);for(let i=0;i<this.data_.length;++i)t.imageProj.renderPolyline(this.data_[i])}this.markValid()},Object.setPrototypeOf(GraticuleLayer.prototype,Layer.prototype),GraticuleLayer.prototype.invalidate=function(){this.graticuleRenderer_=null,this.markInvalid()},GraticuleLayer.prototype.render=function(t){if(0<this.intervalDegrees){null==this.graticuleRenderer_&&(this.graticuleRenderer_=new GraticuleRenderer(t.imageProj,t.projection)),t.imageProj.setCoordTypeData(),t.imageProj.setColor(this.color);const i=t.getWindowBounds(),e=t.projection.inverseBoundingBox(i[0],i[1],i[2],i[3]);this.graticuleRenderer_.renderLines(i,e,this.intervalDegrees)}this.markValid()},"undefined"!=typeof module&&module.exports&&(module.exports=MapView,module.exports.TileManager=TileManager,module.exports.ViewWindowManager=ViewWindowManager);