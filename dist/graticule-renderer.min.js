/*!
 * Raster Map Projection v0.0.14  2017-05-07
 *   https://github.com/tomosn/raster-map-projection
 * Copyright (C) 2016-2017 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */
"use strict";var GraticuleInterpolator=function(a,b,c,d){this.proj_=a,this.initDivNum_=b,this.threshold_=c,this.thSq_=c*c,this.maxRecursion_=d;var e=this;this.longitudeProcessor_=function(a,b){var c=e.proj_.forward(b,a);return e.checkRange_(c)?c:null},this.latitudeProcessor_=function(a,b){var c=e.proj_.forward(a,b);return e.checkRange_(c)?c:null}};GraticuleInterpolator.prototype.checkRange_=function(a){return null!=a&&this.proj_.checkXYDomain(a.x,a.y,.9)},GraticuleInterpolator.prototype.createLongitudeLine=function(a,b,c){return this.createGraticuleLine_(a,b,c,this.longitudeProcessor_)},GraticuleInterpolator.prototype.createLatitudeLine=function(a,b,c){return this.createGraticuleLine_(a,b,c,this.latitudeProcessor_)},GraticuleInterpolator.prototype.interpolateValue_=function(a,b,c){return(a*(this.initDivNum_-c)+b*c)/this.initDivNum_},GraticuleInterpolator.prototype.searchEndPoint_=function(a,b,c,d){for(var e=null,f=0;f<this.initDivNum_;++f){var g=this.interpolateValue_(b,c,f),h=d(a,g);if(null!=h){if(null==e)return g;for(var i=0;i<this.initDivNum_;++i){var j=this.interpolateValue_(e,g,i);if(h=d(a,j),null!=h)return j}return g}e=g}return null},GraticuleInterpolator.prototype.createGraticuleLine_=function(a,b,c,d){var e=[],f=this.searchEndPoint_(a,b,c,d);if(null==f)return null;var g=this.searchEndPoint_(a,c,b,d);if(null==g)return null;for(var h=0,i=null,j=null,k=0;k<=this.initDivNum_;++k){var l=this.interpolateValue_(f,g,k),m=d(a,l);if(null!=m){var n=0;if(null!=j&&(n=(m.x-j.x)*(m.x-j.x)+(m.y-j.y)*(m.y-j.y)),this.thSq_<n)h+=this.interpolateGraticule_(a,i,l,j,m,0,e,d);else{var o=Math.sqrt(n);e.push([m,l,o]),h+=o}j=m,i=l}}return new GraticuleLine_(a,h,e)},GraticuleInterpolator.prototype.interpolateGraticule_=function(a,b,c,d,e,f,g,h){var i=(b+c)/2,j=h(a,i);if(null==j&&(i=(2*b+c)/3,j=h(a,i)),null==j&&(i=(b+2*c)/3,j=h(a,i)),null==j){var k=(d.x-e.x)*(d.x-e.x)+(d.y-e.y)*(d.y-e.y),l=Math.sqrt(k);return g.push([e,c,l]),l}var m=(d.x-j.x)*(d.x-j.x)+(d.y-j.y)*(d.y-j.y),n=(e.x-j.x)*(e.x-j.x)+(e.y-j.y)*(e.y-j.y);if(this.maxRecursion_<=f){var o=Math.sqrt(m),p=Math.sqrt(n);return g.push([j,i,o]),g.push([e,c,p]),o+p}var q=0;if(m<=this.thSq_){var r=Math.sqrt(m);g.push([j,i,r]),q+=r}else q+=this.interpolateGraticule_(a,b,i,d,j,f+1,g,h);if(n<=this.thSq_){var s=Math.sqrt(n);g.push([e,c,s]),q+=s}else q+=this.interpolateGraticule_(a,i,c,j,e,f+1,g,h);return q};var GraticuleLine_=function(a,b,c){this.c0=a,this.length_=b,this.points_=c};GraticuleLine_.prototype.generateVariables_=function(a,b,c){for(var d=this.points_[a][1],e=this.points_[b][1],f=new Array(c),g=0;g<=c-1;g++)f[g]=(d*(c-1-g)+e*g)/(c-1);return f},GraticuleLine_.prototype.generateLists=function(a,b,c){for(var d=[],e=0,f=0,g=1;g<this.points_.length;g++){var h=this.points_[g];b<h[2]?(e+1<g&&this.generateEachLists_(e,g-1,f,a,c,d),e=g,f=0):(f+=h[2],this.points_.length-1<=g&&e<g&&this.generateEachLists_(e,g,f,a,c,d))}return d},GraticuleLine_.prototype.generateEachLists_=function(a,b,c,d,e,f){for(var g=c<d?1:Math.round(c/d),h=b-a+1,i=c,j=g,k=a;0<j;){var l,m=0;if(j<=1)l=h-1;else{var n=i/j;for(l=k+1;l<=b&&(m+=this.points_[l][2],!(n<=m||b<=l));l++);}if(f.push(this.generateVariables_(k,l,e)),k=l,j--,i-=m,b<=k)break}};var GraticuleRenderer=function(a,b){this.shaderProg_=a,this.proj_=b,this.unitLength_=Math.PI/8,this.separateThreshold_=Math.PI/8,this.interpolator_=new GraticuleInterpolator(this.proj_,8,Math.PI/8,8)};GraticuleRenderer.prototype.renderLines=function(a,b){this.renderLatitudeLines(a,b),this.renderLongitudeLines(a,b)},GraticuleRenderer.prototype.renderLatitudeLines=function(a,b){var c=Math.max(-80*Math.PI/180,a.phi[0]),d=Math.min(80*Math.PI/180,a.phi[1]),e=[];c<-this.proj_.phi0&&-this.proj_.phi0<d?(e.push([c,-this.proj_.phi0]),e.push([-this.proj_.phi0,d])):e.push([c,d]);var f=b*Math.floor(180*a.lambda[0]/Math.PI/b),g=180*a.lambda[1]/Math.PI,h=this.shaderProg_.coordsBuffer_.maxNum*this.shaderProg_.coordsBuffer_.dimension;this.shaderProg_.prepareRenderLatitudeLine();for(var i=f;i<=g;i+=b)for(var j=i*Math.PI/180,k=0;k<e.length;k++){var l=e[k],m=this.interpolator_.createLatitudeLine(j,l[0],l[1]);if(null!=m)for(var n=m.generateLists(this.unitLength_,this.separateThreshold_,h),o=0;o<n.length;o++)this.shaderProg_.renderLatitudeLine(j,n[o])}},GraticuleRenderer.prototype.renderLongitudeLines=function(a,b){var c=ProjMath.normalizeLambda(this.proj_.lam0-Math.PI),d=[];a.lambda[0]<c&&c<a.lambda[1]?(d.push([a.lambda[0],c]),d.push([c,a.lambda[1]])):c<a.lambda[1]-2*Math.PI?(d.push([c,a.lambda[1]-2*Math.PI]),d.push([a.lambda[0],c+2*Math.PI])):d.push(a.lambda);var e=b*Math.floor(180*a.phi[0]/Math.PI/b),f=Math.min(80,180*a.phi[1]/Math.PI),g=this.shaderProg_.coordsBuffer_.maxNum*this.shaderProg_.coordsBuffer_.dimension;this.shaderProg_.prepareRenderLongitudeLine();for(var h=e;h<=f;h+=b)for(var i=h*Math.PI/180,j=0;j<d.length;j++){var k=d[j],l=this.interpolator_.createLongitudeLine(i,k[0],k[1]);if(null!=l)for(var m=l.generateLists(this.unitLength_,this.separateThreshold_,g),n=0;n<m.length;n++)this.shaderProg_.renderLongitudeLine(i,m[n])}},"undefined"!=typeof module&&module.exports&&(module.exports=GraticuleInterpolator);