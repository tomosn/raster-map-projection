/*!
 * RasterMapProjection v0.0.23  2018-11-18
 *   https://github.com/tomosn/raster-map-projection
 * Copyright (C) 2016-2018 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */

"use strict";var GraticuleInterpolator=function(t,r,e,i){this.proj_=t,this.initDivNum_=r,this.threshold_=e,this.thSq_=e*e,this.maxRecursion_=i,this.longitudeProcessor_=function(t,r){var e=this.proj_.forward(r,t);return this.checkRange_(e)?e:null}.bind(this),this.latitudeProcessor_=function(t,r){var e=this.proj_.forward(t,r);return this.checkRange_(e)?e:null}.bind(this)};GraticuleInterpolator.prototype.checkRange_=function(t){return null!=t&&this.proj_.checkXYDomain(t.x,t.y,.9)},GraticuleInterpolator.prototype.createLongitudeLine=function(t,r,e){return this.createGraticuleLine_(t,r,e,this.longitudeProcessor_)},GraticuleInterpolator.prototype.createLatitudeLine=function(t,r,e){return this.createGraticuleLine_(t,r,e,this.latitudeProcessor_)},GraticuleInterpolator.prototype.interpolateValue_=function(t,r,e){return(t*(this.initDivNum_-e)+r*e)/this.initDivNum_},GraticuleInterpolator.prototype.searchEndPoint_=function(t,r,e,i){for(var a=null,n=0;n<this.initDivNum_;++n){var o=this.interpolateValue_(r,e,n),h=i(t,o);if(null!=h){if(null==a)return o;for(var s=0;s<this.initDivNum_;++s){var u=this.interpolateValue_(a,o,s);if(null!=(h=i(t,u)))return u}return o}a=o}return null},GraticuleInterpolator.prototype.createGraticuleLine_=function(t,r,e,i){var a=[],n=this.searchEndPoint_(t,r,e,i);if(null==n)return null;var o=this.searchEndPoint_(t,e,r,i);if(null==o)return null;for(var h=0,s=null,u=null,l=0;l<=this.initDivNum_;++l){var p=this.interpolateValue_(n,o,l),_=i(t,p);if(null!=_){var c=0;if(null!=u&&(c=(_.x-u.x)*(_.x-u.x)+(_.y-u.y)*(_.y-u.y)),this.thSq_<c)h+=this.interpolateGraticule_(t,s,p,u,_,0,a,i);else{var d=Math.sqrt(c);a.push([_,p,d]),h+=d}u=_,s=p}}return new GraticuleLine_(t,h,a)},GraticuleInterpolator.prototype.interpolateGraticule_=function(t,r,e,i,a,n,o,h){var s=(r+e)/2,u=h(t,s);if(null==u&&(u=h(t,s=(2*r+e)/3)),null==u&&(u=h(t,s=(r+2*e)/3)),null==u){var l=(i.x-a.x)*(i.x-a.x)+(i.y-a.y)*(i.y-a.y),p=Math.sqrt(l);return o.push([a,e,p]),p}var _=(i.x-u.x)*(i.x-u.x)+(i.y-u.y)*(i.y-u.y),c=(a.x-u.x)*(a.x-u.x)+(a.y-u.y)*(a.y-u.y);if(this.maxRecursion_<=n){var d=Math.sqrt(_),f=Math.sqrt(c);return o.push([u,s,d]),o.push([a,e,f]),d+f}var v=0;if(_<=this.thSq_){var L=Math.sqrt(_);o.push([u,s,L]),v+=L}else v+=this.interpolateGraticule_(t,r,s,i,u,n+1,o,h);if(c<=this.thSq_){var g=Math.sqrt(c);o.push([a,e,g]),v+=g}else v+=this.interpolateGraticule_(t,s,e,u,a,n+1,o,h);return v};var GraticuleLine_=function(t,r,e){this.c0=t,this.length_=r,this.points_=e};GraticuleLine_.prototype.generateVariables_=function(t,r,e){for(var i=this.points_[t][1],a=this.points_[r][1],n=new Array(e),o=0;o<=e-1;o++)n[o]=(i*(e-1-o)+a*o)/(e-1);return n},GraticuleLine_.prototype.generateLists=function(t,r,e){for(var i=[],a=0,n=0,o=1;o<this.points_.length;o++){var h=this.points_[o];r<h[2]?(a+1<o&&this.generateEachLists_(a,o-1,n,t,e,i),a=o,n=0):(n+=h[2],this.points_.length-1<=o&&a<o&&this.generateEachLists_(a,o,n,t,e,i))}return i},GraticuleLine_.prototype.generateEachLists_=function(t,r,e,i,a,n){for(var o=e,h=e<i?1:Math.round(e/i),s=t;0<h;){var u,l=0;if(h<=1)u=r;else{var p=o/h;for(u=s+1;u<=r&&!(p<=(l+=this.points_[u][2])||r<=u);u++);}if(n.push(this.generateVariables_(s,u,a)),h--,o-=l,r<=(s=u))break}};var GraticuleRenderer=function(t,r){this.shaderProg_=t,this.proj_=r,this.unitLength_=Math.PI/8,this.separateThreshold_=Math.PI/8,this.interpolator_=new GraticuleInterpolator(this.proj_,8,Math.PI/8,8)};GraticuleRenderer.prototype.renderLines=function(t,r,e){this.renderLatitudeLines(t,r,e),this.renderLongitudeLines(t,r,e)},GraticuleRenderer.prototype.renderLatitudeLines=function(t,r,e){var i,a=Math.max(-80*Math.PI/180,r.phi[0]),n=Math.min(80*Math.PI/180,r.phi[1]),o=[];if(i=a<0&&0<n?[a,0,n]:[a,n],a<-this.proj_.phi0&&-this.proj_.phi0<n&&0!==this.proj_.phi0)for(var h=1;h<=i.length;h++)if(-this.proj_.phi0<i[h]){i.splice(h,0,-this.proj_.phi0);break}for(var s=1;s<i.length;s++)o.push([i[s-1],i[s]]);var u=e*Math.floor(180*r.lambda[0]/Math.PI/e),l=180*r.lambda[1]/Math.PI,p=this.shaderProg_.coordsBuffer_.maxNum*this.shaderProg_.coordsBuffer_.dimension;this.shaderProg_.prepareRenderLatitudeLine();for(var _=u;_<=l;_+=e)for(var c=_*Math.PI/180,d=0;d<o.length;d++){var f=o[d],v=this.interpolator_.createLatitudeLine(c,f[0],f[1]);if(null!=v)for(var L=v.generateLists(this.unitLength_,this.separateThreshold_,p),g=0;g<L.length;g++)this.shaderProg_.renderLatitudeLine(c,L[g],t)}},GraticuleRenderer.prototype.renderLongitudeLines=function(t,r,e){var i=ProjMath.normalizeLambda(this.proj_.lam0-Math.PI),a=[];r.lambda[0]<i&&i<r.lambda[1]?(a.push([r.lambda[0],i]),a.push([i,r.lambda[1]])):i<r.lambda[1]-2*Math.PI?(a.push([i,r.lambda[1]-2*Math.PI]),a.push([r.lambda[0],i+2*Math.PI])):a.push(r.lambda);var n=e*Math.floor(180*r.phi[0]/Math.PI/e),o=Math.min(80,180*r.phi[1]/Math.PI),h=this.shaderProg_.coordsBuffer_.maxNum*this.shaderProg_.coordsBuffer_.dimension;this.shaderProg_.prepareRenderLongitudeLine();for(var s=n;s<=o;s+=e)for(var u=s*Math.PI/180,l=0;l<a.length;l++){var p=a[l],_=this.interpolator_.createLongitudeLine(u,p[0],p[1]);if(null!=_)for(var c=_.generateLists(this.unitLength_,this.separateThreshold_,h),d=0;d<c.length;d++)this.shaderProg_.renderLongitudeLine(u,c[d],t)}},"undefined"!=typeof module&&module.exports&&(module.exports=GraticuleInterpolator);