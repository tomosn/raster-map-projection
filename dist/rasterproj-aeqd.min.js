/*!
 * Raster Map Projection v0.0.15  2017-05-28
 *   https://github.com/tomosn/raster-map-projection
 * Copyright (C) 2016-2017 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */
"use strict";if("undefined"!=typeof module&&module.exports)var ProjMath=require("./rasterproj-common.js");RasterMapProjection.createProjection=function(a,b,c){return new ProjAEQD(a,b,c)};var ProjDiscreteMath=function(a){this.divN_=a,this.unit_=Math.PI/a};ProjDiscreteMath.prototype.toDiscrete=function(a){var b=Math.floor(a/this.unit_);return b},ProjDiscreteMath.prototype.cosR_lower=function(a,b){var c=0<=a?(a+1)*this.unit_:-a*this.unit_,d=Math.sqrt(c*c+b*b);return d<=Math.PI?Math.cos(d):-1},ProjDiscreteMath.prototype.cosR_upper=function(a,b){var c=0<=a?a*this.unit_:(-a-1)*this.unit_,d=Math.sqrt(c*c+b*b);return d<=Math.PI?Math.cos(d):-1},ProjDiscreteMath.prototype.sinR_lower=function(a,b){var c=a*this.unit_,d=(a+1)*this.unit_,e=Math.sqrt(c*c+b*b),f=Math.sqrt(d*d+b*b);if(Math.PI<=e||Math.PI<=f)return 0;if(e<=ProjMath.HALF_PI&&f<=ProjMath.HALF_PI){var g=Math.min(e,f);return Math.sin(g)}if(ProjMath.HALF_PI<=e&&ProjMath.HALF_PI<=f){var h=Math.max(e,f);return Math.sin(h)}var i=Math.sin(e),j=Math.sin(f);return i<j?i:j},ProjDiscreteMath.prototype.sinR_upper=function(a,b){var c=a*this.unit_,d=(a+1)*this.unit_,e=Math.sqrt(c*c+b*b),f=Math.sqrt(d*d+b*b);if(Math.PI<=e&&Math.PI<=f)return 0;if(e<=ProjMath.HALF_PI&&f<=ProjMath.HALF_PI){var g=Math.max(e,f);return Math.sin(g)}if(ProjMath.HALF_PI<=e&&ProjMath.HALF_PI<=f){var h=Math.min(e,f);return Math.sin(h)}return 1},ProjDiscreteMath.prototype.R_cotR_lower=function(a,b){var c=0<=a?(a+1)*this.unit_:-a*this.unit_,d=Math.sqrt(c*c+b*b);return d<ProjMath.EPSILON?1:d<Math.PI?d/Math.tan(d):-(1/0)},ProjDiscreteMath.prototype.R_cotR_upper=function(a,b){var c=0<=a?a*this.unit_:(-a-1)*this.unit_,d=Math.sqrt(c*c+b*b);return d<ProjMath.EPSILON?1:d<Math.PI?d/Math.tan(d):-(1/0)},ProjDiscreteMath.prototype.sinR_divR_lower=function(a,b){var c=0<=a?(a+1)*this.unit_:-a*this.unit_,d=Math.sqrt(c*c+b*b);return d<ProjMath.EPSILON?1:d<Math.PI?Math.sin(d)/d:0},ProjDiscreteMath.prototype.sinR_divR_upper=function(a,b){var c=0<=a?a*this.unit_:(-a-1)*this.unit_,d=Math.sqrt(c*c+b*b);return d<ProjMath.EPSILON?1:d<Math.PI?Math.sin(d)/d:0},ProjDiscreteMath.prototype.X_lower=function(a){return a*this.unit_},ProjDiscreteMath.prototype.X_upper=function(a){return(a+1)*this.unit_};var ProjAEQD=function(a,b,c){this.lam0=a,this.phi0=b,this.divN_="undefined"!=typeof c?c:180,this.dMath_=new ProjDiscreteMath(this.divN_),this.sin_phi0_=Math.sin(b),this.cos_phi0_=Math.cos(b)};ProjAEQD.RANGE_RECTANGLE=[-Math.PI,-Math.PI,+Math.PI,+Math.PI],ProjAEQD.prototype.getRange=function(){return ProjAEQD.RANGE_RECTANGLE.slice(0)},ProjAEQD.prototype.getProjCenter=function(){return{lambda:this.lam0,phi:this.phi0}},ProjAEQD.prototype.setProjCenter=function(a,b){this.lam0=a,this.phi0=b,this.sin_phi0_=Math.sin(b),this.cos_phi0_=Math.cos(b)},ProjAEQD.prototype.checkXYDomain=function(a,b,c){var d=Math.PI;if(null!=c&&(d*=c),Math.abs(a)<d&&Math.abs(b)<d)return!0;var e=a*a+b*b;return e<d*d},ProjAEQD.prototype.forward=function(a,b){var c=Math.sin(b),d=Math.cos(b),e=Math.sin(a-this.lam0),f=Math.cos(a-this.lam0),g=Math.acos(this.sin_phi0_*c+this.cos_phi0_*d*f);if(Math.abs(g)<ProjMath.EPSILON)return{x:0,y:0};var h=Math.sin(g);if(Math.abs(h)<ProjMath.EPSILON)return null;var i=g/h,j=i*d*e,k=i*(this.cos_phi0_*c-this.sin_phi0_*d*f);return{x:j,y:k}},ProjAEQD.prototype.inverse=function(a,b){var c=a*a+b*b;if(ProjMath.PI_SQ<c)return null;var d=Math.sqrt(c);if(d<ProjMath.EPSILON)return{lambda:this.lam0,phi:this.phi0};var e,f=d,g=Math.sin(f),h=Math.cos(f),i=h*this.sin_phi0_+b*g*this.cos_phi0_/d,j=Math.asin(ProjMath.clamp(i,-1,1));return e=ProjMath.HALF_PI-ProjMath.EPSILON<this.phi0?Math.atan2(a,-b)+this.lam0:this.phi0<-(ProjMath.HALF_PI-ProjMath.EPSILON)?Math.atan2(a,b)+this.lam0:Math.atan2(a*g,d*h*this.cos_phi0_-b*this.sin_phi0_*g)+this.lam0,(e<-Math.PI||Math.PI<=e)&&(e-=2*Math.PI*Math.floor((e+Math.PI)/(2*Math.PI))),{lambda:e,phi:j}},ProjAEQD.prototype.inverseBoundingBox=function(a,b,c,d){var e=a<=c?a:c,f=a<=c?c:a,g=b<=d?b:d,h=b<=d?d:b;if(e<=0&&0<=f){var i=ProjMath.HALF_PI-this.phi0,j=-(ProjMath.HALF_PI-ProjMath.EPSILON)<this.phi0&&g<=i&&i<=h,k=-ProjMath.HALF_PI-this.phi0,l=this.phi0<ProjMath.HALF_PI-ProjMath.EPSILON&&g<=k&&k<=h;if(j&&l)return{lambda:[-Math.PI,+Math.PI],phi:[-Math.PI/2,+Math.PI/2]};if(j||l){var m=this.inversePhiRange_([e,f],[g,h]);return j?{lambda:[-Math.PI,+Math.PI],phi:[m[0],Math.PI/2]}:{lambda:[-Math.PI,+Math.PI],phi:[-Math.PI/2,m[1]]}}if(h<k||i<g){var n=this.inverseLambdaRangeAtY_([e,-ProjMath.EPSILON],[g,h]),o=this.inverseLambdaRangeAtX_([g,h],[e]),p=this.inverseLambdaRangeAtY_([ProjMath.EPSILON,f],[g,h]),q=this.inverseLambdaRangeAtX_([g,h],[f]),r=this.mergeRange_(n,o),s=this.mergeRange_(p,q),t=[s[0],r[1]+2*Math.PI],u=this.inversePhiRange_([e,f],[g,h]);return t=this.normalizeLambdaRange_(t),{lambda:t,phi:u}}}var v=this.inversePhiRange_([e,f],[g,h]),w=this.inverseLambdaRange_([e,f],[g,h]);return w=this.normalizeLambdaRange_(w),{lambda:w,phi:v}},ProjAEQD.prototype.mergeRange_=function(a,b){var c=null;return null==a?c=b:null!=b&&(c=a,b[0]<c[0]&&(c[0]=b[0]),c[1]<b[1]&&(c[1]=b[1])),c},ProjAEQD.prototype.normalizeLambdaRange_=function(a){var b=a[0];if(-Math.PI<=b&&b<Math.PI)return a;var c=2*Math.PI*Math.floor((b+Math.PI)/(2*Math.PI));return[a[0]-c,a[1]-c]},ProjAEQD.prototype.inverseLambdaRange_=function(a,b){var c=a[0]<=a[1]?a[0]:a[1],d=a[0]<=a[1]?a[1]:a[0],e=b[0]<=b[1]?b[0]:b[1],f=b[0]<=b[1]?b[1]:b[0],g=this.inverseLambdaRangeAtY_([c,d],[e,f]),h=this.inverseLambdaRangeAtX_([e,f],[c,d]),i=this.mergeRange_(h,g);return i},ProjAEQD.prototype.inverseLambdaRangeAtY_=function(a,b){for(var c=a[0]<=a[1]?a[0]:a[1],d=a[0]<=a[1]?a[1]:a[0],e=null,f=this.dMath_.toDiscrete(c),g=this.dMath_.toDiscrete(d),h=b.length,i=f;i<=g;++i)for(var j=0;j<h;++j){var k=this.inverseLambdaAtY_(i,b[j]);e=this.mergeRange_(e,k)}return e},ProjAEQD.prototype.inverseLambdaRangeAtX_=function(a,b){for(var c=a[0]<=a[1]?a[0]:a[1],d=a[0]<=a[1]?a[1]:a[0],e=null,f=this.dMath_.toDiscrete(c),g=this.dMath_.toDiscrete(d),h=b.length,i=f;i<=g;++i)for(var j=0;j<h;++j){var k=this.inverseLambdaAtX_(i,b[j]);e=this.mergeRange_(e,k)}return e},ProjAEQD.prototype.inversePhiRange_=function(a,b){var c=a[0]<=a[1]?a[0]:a[1],d=a[0]<=a[1]?a[1]:a[0],e=b[0]<=b[1]?b[0]:b[1],f=b[0]<=b[1]?b[1]:b[0],g=this.inversePhiRangeAtY_([c,d],[e,f]),h=this.inversePhiRangeAtX_([e,f],[c,d]),i=this.mergeRange_(h,g);return i},ProjAEQD.prototype.inversePhiRangeAtY_=function(a,b){for(var c=a[0]<=a[1]?a[0]:a[1],d=a[0]<=a[1]?a[1]:a[0],e=null,f=this.dMath_.toDiscrete(c),g=this.dMath_.toDiscrete(d),h=b.length,i=f;i<=g;++i)for(var j=0;j<h;++j){var k=this.inversePhiAtY_(i,b[j]);e=this.mergeRange_(e,k)}return e},ProjAEQD.prototype.inversePhiRangeAtX_=function(a,b){for(var c=a[0]<=a[1]?a[0]:a[1],d=a[0]<=a[1]?a[1]:a[0],e=null,f=this.dMath_.toDiscrete(c),g=this.dMath_.toDiscrete(d),h=b.length,i=f;i<=g;++i)for(var j=0;j<h;++j){var k=this.inversePhiAtX_(i,b[j]);e=this.mergeRange_(e,k)}return e},ProjAEQD.prototype.inverseLambdaAtX_=function(a,b){if(ProjMath.HALF_PI-ProjMath.EPSILON<Math.abs(this.phi0)){var c=0<this.phi0?-1:1,d=c*this.dMath_.X_lower(a),e=c*this.dMath_.X_upper(a),f=d<=e?e:d,g=d<=e?d:e,h=ProjMath.atan2Range({min:b,max:b},{min:g,max:f});return[h.min+this.lam0,h.max+this.lam0]}var i=this.cos_phi0_*this.dMath_.R_cotR_lower(a,b),j=this.cos_phi0_*this.dMath_.R_cotR_upper(a,b),k=i<=j?j:i,l=i<=j?i:j,m=-this.sin_phi0_*this.dMath_.X_lower(a),n=-this.sin_phi0_*this.dMath_.X_upper(a),o=m<=n?n:m,p=m<=n?m:n,q=k+o,r=l+p,s=ProjMath.atan2Range({min:b,max:b},{min:r,max:q});return[s.min+this.lam0,s.max+this.lam0]},ProjAEQD.prototype.inverseLambdaAtY_=function(a,b){if(ProjMath.HALF_PI-ProjMath.EPSILON<Math.abs(this.phi0)){var c=0<this.phi0?-1:1,d=this.dMath_.X_lower(a),e=this.dMath_.X_upper(a),f=ProjMath.atan2Range({min:d,max:e},{min:c*b,max:c*b});return[f.min+this.lam0,f.max+this.lam0]}var g=this.cos_phi0_*this.dMath_.R_cotR_lower(a,b)-this.sin_phi0_*b,h=this.cos_phi0_*this.dMath_.R_cotR_upper(a,b)-this.sin_phi0_*b,i=h<=g?g:h,j=h<=g?h:g,k=this.dMath_.X_lower(a),l=this.dMath_.X_upper(a),m=ProjMath.atan2Range({min:k,max:l},{min:j,max:i});return[m.min+this.lam0,m.max+this.lam0]},ProjAEQD.prototype.inversePhiAtY_=function(a,b){var c=this.dMath_.cosR_lower(a,b)*this.sin_phi0_,d=this.dMath_.cosR_upper(a,b)*this.sin_phi0_,e=c<=d?d:c,f=c<=d?c:d,g=b*this.dMath_.sinR_divR_lower(a,b)*this.cos_phi0_,h=b*this.dMath_.sinR_divR_upper(a,b)*this.cos_phi0_,i=g<=h?h:g,j=g<=h?g:h,k=ProjMath.clamp(e+i,-1,1),l=ProjMath.clamp(f+j,-1,1);return[Math.asin(l),Math.asin(k)]},ProjAEQD.prototype.inversePhiAtX_=function(a,b){var c=this.dMath_.cosR_lower(a,b)*this.sin_phi0_,d=this.dMath_.cosR_upper(a,b)*this.sin_phi0_,e=c<=d?d:c,f=c<=d?c:d,g=Math.abs(this.dMath_.X_lower(a)),h=Math.abs(this.dMath_.X_upper(a)),i=g<=h?h:g,j=g<=h?g:h,k=Math.abs(this.cos_phi0_),l=i*this.dMath_.sinR_divR_upper(a,b)*k,m=j*this.dMath_.sinR_divR_lower(a,b)*k,n=0<=a*this.cos_phi0_?1:-1,o=0<n?+l:-m,p=0<n?+m:-l,q=ProjMath.clamp(e+o,-1,1),r=ProjMath.clamp(f+p,-1,1);return[Math.asin(r),Math.asin(q)]},ProjAEQD.prototype.getVertexShaderStr=function(){return ProjAEQD.VERTEX_SHADER_STR},ProjAEQD.prototype.getFragmentShaderStr=function(){return ProjAEQD.FRAGMENT_SHADER_STR},ProjAEQD.VERTEX_SHADER_STR=["precision highp float;","attribute float aCoordX;","attribute float aCoordY;","uniform mat3 uFwdTransform;","uniform vec2 uProjCenter;","varying vec2 vCoord;","varying float vInRange;","uniform float uPointSize;","uniform lowp int uCoordType;","uniform lowp int uTextureType;","const float pi = 3.141592653589793;","const float epsilon = 0.001;","const float xyDomain = 0.94 * pi;","vec2 proj_forward(vec2 center, vec2 lp)","{","  float sinPhi0 = sin(center.y);","  float cosPhi0 = cos(center.y);","  float sinPhi = sin(lp.y);","  float cosPhi = cos(lp.y);","  float sinLam = sin(lp.x - center.x);","  float cosLam = cos(lp.x - center.x);","  float v = sinPhi0 * sinPhi + cosPhi0 * cosPhi * cosLam;","  float x = cosPhi * sinLam;","  float y = cosPhi0 * sinPhi - sinPhi0 * cosPhi * cosLam;","  float k;","  if ( v < -1.0 + epsilon ) {","    return pi * normalize(vec2(x, y));","  }","  float c = acos(v);","  if ( abs(c) < epsilon ) {","    k = 1.0;","  } else {","    k = c / sin(c);","  }","  return k * vec2(x, y);","}","float check_xy_range(vec2 xy)","{","  return 1.0 - step(xyDomain, length(xy));","}","void main()","{","  vInRange = 1.0;","  vec3 pos;","  if ( uTextureType == 2 || uCoordType == 2 ) {","    pos = vec3(aCoordX, aCoordY, 1.0);","  } else if ( uCoordType == 1 ) {","    pos = uFwdTransform * vec3(aCoordX, aCoordY, 1.0);","    vInRange = check_xy_range(vec2(aCoordX, aCoordY));","  } else {","    vec2 xy = proj_forward(uProjCenter, vec2(aCoordX, aCoordY));","    vInRange = check_xy_range(xy);","    pos = uFwdTransform * vec3(xy.x, xy.y, 1.0);","  }","  vCoord = pos.xy;","  gl_Position = vec4(pos, 1.0);","  gl_PointSize = uPointSize;","}"].join("\n"),ProjAEQD.FRAGMENT_SHADER_STR=["precision highp float;","uniform mat3 uInvTransform;","uniform vec2 uDataCoord1;","uniform vec2 uDataCoord2;","uniform lowp int uCoordType;","uniform lowp int uTextureType;","uniform sampler2D uTexture;","uniform vec2 uProjCenter;","uniform vec4 uColor;","varying vec2 vCoord;","varying float vInRange;","const float pi = 3.141592653589793;","const float epsilon = 0.00000001;","const float blurRatio = 0.015;","const float xyRadius = pi;","vec2 proj_inverse(vec2 center, vec2 xy)","{","  float sinPhi0 = sin(center.y);","  float cosPhi0 = cos(center.y);","  float rho = length(xy);","  if ( rho < epsilon ) {","    return center;","  }","  if ( rho - epsilon > xyRadius ) {","    rho = xyRadius;","  }","  float c_rh = rho;","  float cos_c = cos(c_rh);","  float sin_c = sin(c_rh);","  float phi = asin( clamp( cos_c * sinPhi0 + xy.y * sin_c * cosPhi0 / rho, -1.0, 1.0 ) );","  float lam = mod( center.x + atan( xy.x * sin_c, rho * cosPhi0 * cos_c - xy.y * sinPhi0 * sin_c ) + pi, 2.0 * pi ) - pi;","  return vec2(lam, phi);","}","float inner_xy(vec2 xy)","{","  return 1.0 - smoothstep( (1.0 - blurRatio) * xyRadius, (1.0 + blurRatio) * xyRadius, length(xy) );","}","void main()","{","  if ( vInRange < 0.5 ) {","    discard;","    return;","  }","  vec4 outColor;","  bool isDiscard = false;","  if ( uTextureType == 2 ) {","    float inXY = 1.0;","    vec2 coord;","    if ( uCoordType == 2 ) {","      coord = vCoord;","    } else {","      vec3 viewCoord = uInvTransform * vec3(vCoord.x, vCoord.y, 1.0);","      inXY = inner_xy(viewCoord.xy);","      if ( 0.0 < inXY ) {","        if ( uCoordType == 1 ) {","          coord = viewCoord.xy;","        } else if ( uCoordType == 0 ) {","          coord = proj_inverse(uProjCenter, viewCoord.xy);","        }","      } else {","        isDiscard = true;","        coord = vec2(0.0, 0.0);","      }","    }","    if ( !isDiscard ) {","      vec2 ts = (coord - uDataCoord1) / (uDataCoord2 - uDataCoord1);","      if ( 0.0 <= ts.x && 0.0 <= ts.y && ts.x <= 1.0 && ts.y <= 1.0) {","        outColor = texture2D(uTexture, vec2(ts.x, 1.0 - ts.y)) * inXY;","      } else {","        isDiscard = true;","      }","    }","  } else if ( uTextureType == 1 ) {","    outColor = texture2D(uTexture, gl_PointCoord);","    isDiscard = (outColor.a == 0.0);","  } else {","    outColor = uColor;","    isDiscard = (outColor.a == 0.0);","  }","  if ( isDiscard ) {","    discard;","  } else {","    gl_FragColor = outColor;","  }","}"].join("\n"),"undefined"!=typeof module&&module.exports&&(module.exports=ProjAEQD,module.exports.ProjDiscreteMath=ProjDiscreteMath);