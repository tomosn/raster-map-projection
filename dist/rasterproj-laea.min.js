/*!
 * Raster Map Projection v0.0.18  2017-08-16
 *   https://github.com/tomosn/raster-map-projection
 * Copyright (C) 2016-2017 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */

"use strict";if("undefined"!=typeof module&&module.exports)var ProjMath=require("./rasterproj-common.js");RasterMapProjection.createProjection=function(t,r,i){return new ProjLAEA(t,r,i)};var ProjDiscreteMath=function(t){this.divN_=t,this.unit_=2/t};ProjDiscreteMath.prototype.toDiscrete=function(t){return Math.floor(t/this.unit_)},ProjDiscreteMath.prototype.cosR_lower=function(t,r){var i=0<=t?(t+1)*this.unit_:-t*this.unit_,o=Math.sqrt(i*i+r*r);return o<=2?Math.cos(2*Math.asin(o/2)):-1},ProjDiscreteMath.prototype.cosR_upper=function(t,r){var i=0<=t?t*this.unit_:(-t-1)*this.unit_,o=Math.sqrt(i*i+r*r);return o<=2?Math.cos(2*Math.asin(o/2)):-1},ProjDiscreteMath.prototype.sinR_lower=function(t,r){var i=t*this.unit_,o=(t+1)*this.unit_,a=Math.sqrt(i*i+r*r),e=Math.sqrt(o*o+r*r);if(2<=a||2<=e)return 0;if(a<=ProjMath.SQRT_2&&e<=ProjMath.SQRT_2){var n=Math.min(a,e);return Math.sin(2*Math.asin(n/2))}if(ProjMath.SQRT_2<=a&&ProjMath.SQRT_2<=e){var h=Math.max(a,e);return Math.sin(2*Math.asin(h/2))}var s=Math.sin(2*Math.asin(a/2)),_=Math.sin(2*Math.asin(e/2));return s<_?s:_},ProjDiscreteMath.prototype.sinR_upper=function(t,r){var i=t*this.unit_,o=(t+1)*this.unit_,a=Math.sqrt(i*i+r*r),e=Math.sqrt(o*o+r*r);if(2<=a&&2<=e)return 0;if(a<=ProjMath.SQRT_2&&e<=ProjMath.SQRT_2){var n=Math.max(a,e);return Math.sin(2*Math.asin(n/2))}if(ProjMath.HALF_PI<=a&&ProjMath.HALF_PI<=e){var h=Math.min(a,e);return Math.sin(2*Math.asin(h/2))}return 1},ProjDiscreteMath.prototype.R_cotR_lower=function(t,r){var i=0<=t?(t+1)*this.unit_:-t*this.unit_,o=Math.sqrt(i*i+r*r);return o<ProjMath.EPSILON?1:o<2?o/Math.tan(2*Math.asin(o/2)):-1/0},ProjDiscreteMath.prototype.R_cotR_upper=function(t,r){var i=0<=t?t*this.unit_:(-t-1)*this.unit_,o=Math.sqrt(i*i+r*r);return o<ProjMath.EPSILON?1:o<2?o/Math.tan(2*Math.asin(o/2)):-1/0},ProjDiscreteMath.prototype.sinR_divR_lower=function(t,r){var i=0<=t?(t+1)*this.unit_:-t*this.unit_,o=Math.sqrt(i*i+r*r);return o<ProjMath.EPSILON?1:o<2?Math.sin(2*Math.asin(o/2))/o:0},ProjDiscreteMath.prototype.sinR_divR_upper=function(t,r){var i=0<=t?t*this.unit_:(-t-1)*this.unit_,o=Math.sqrt(i*i+r*r);return o<ProjMath.EPSILON?1:o<2?Math.sin(2*Math.asin(o/2))/o:0},ProjDiscreteMath.prototype.X_lower=function(t){return t*this.unit_},ProjDiscreteMath.prototype.X_upper=function(t){return(t+1)*this.unit_};var ProjLAEA=function(t,r,i){this.lam0=t,this.phi0=r,this.divN_=void 0!==i?i:180,this.dMath_=new ProjDiscreteMath(this.divN_),this.sin_phi0_=Math.sin(r),this.cos_phi0_=Math.cos(r)};ProjLAEA.RANGE_RECTANGLE=[-2,-2,2,2],ProjLAEA.prototype.getRange=function(){return ProjLAEA.RANGE_RECTANGLE.slice(0)},ProjLAEA.prototype.getProjCenter=function(){return{lambda:this.lam0,phi:this.phi0}},ProjLAEA.prototype.setProjCenter=function(t,r){this.lam0=t,this.phi0=r,this.sin_phi0_=Math.sin(r),this.cos_phi0_=Math.cos(r)},ProjLAEA.prototype.checkXYDomain=function(t,r,i){var o=2;return null!=i&&(o*=i),Math.abs(t)<o&&Math.abs(r)<o||t*t+r*r<o*o},ProjLAEA.prototype.forward=function(t,r){var i=Math.sin(r),o=Math.cos(r),a=Math.sin(t-this.lam0),e=Math.cos(t-this.lam0),n=1+this.sin_phi0_*i+this.cos_phi0_*o*e;if(Math.abs(n)<ProjMath.EPSILON)return null;var h=Math.sqrt(2/n);return{x:h*o*a,y:h*(this.cos_phi0_*i-this.sin_phi0_*o*e)}},ProjLAEA.prototype.inverse=function(t,r){var i=t*t+r*r;if(4<i)return null;var o=Math.sqrt(i);if(o<ProjMath.EPSILON)return{lambda:this.lam0,phi:this.phi0};var a,e=2*Math.asin(ProjMath.clamp(o/2,-1,1)),n=Math.sin(e),h=Math.cos(e),s=h*this.sin_phi0_+r*n*this.cos_phi0_/o,_=Math.asin(ProjMath.clamp(s,-1,1));return((a=ProjMath.HALF_PI-ProjMath.EPSILON<this.phi0?Math.atan2(t,-r)+this.lam0:this.phi0<-(ProjMath.HALF_PI-ProjMath.EPSILON)?Math.atan2(t,r)+this.lam0:Math.atan2(t*n,o*h*this.cos_phi0_-r*this.sin_phi0_*n)+this.lam0)<-Math.PI||Math.PI<=a)&&(a-=2*Math.PI*Math.floor((a+Math.PI)/(2*Math.PI))),{lambda:a,phi:_}},ProjLAEA.prototype.inverseBoundingBox=function(t,r,i,o){var a=t<=i?t:i,e=t<=i?i:t,n=r<=o?r:o,h=r<=o?o:r;if(a<=0&&0<=e){var s=ProjMath.SQRT_2*this.cos_phi0_/Math.sqrt(1+this.sin_phi0_),_=-(ProjMath.HALF_PI-ProjMath.EPSILON)<this.phi0&&n<=s&&s<=h,u=-ProjMath.SQRT_2*this.cos_phi0_/Math.sqrt(1-this.sin_phi0_),p=this.phi0<ProjMath.HALF_PI-ProjMath.EPSILON&&n<=u&&u<=h;if(_&&p)return{lambda:[-Math.PI,+Math.PI],phi:[-Math.PI/2,+Math.PI/2]};if(_||p){var c=this.inversePhiRange_([a,e],[n,h]);return _?{lambda:[-Math.PI,+Math.PI],phi:[c[0],Math.PI/2]}:{lambda:[-Math.PI,+Math.PI],phi:[-Math.PI/2,c[1]]}}if(h<u||s<n){var M=this.inverseLambdaRangeAtY_([a,-ProjMath.EPSILON],[n,h]),P=this.inverseLambdaRangeAtX_([n,h],[a]),l=this.inverseLambdaRangeAtY_([ProjMath.EPSILON,e],[n,h]),v=this.inverseLambdaRangeAtX_([n,h],[e]),d=this.mergeRange_(M,P),f=[this.mergeRange_(l,v)[0],d[1]+2*Math.PI],m=this.inversePhiRange_([a,e],[n,h]);return f=this.normalizeLambdaRange_(f),{lambda:f,phi:m}}}var R=this.inversePhiRange_([a,e],[n,h]),j=this.inverseLambdaRange_([a,e],[n,h]);return j=this.normalizeLambdaRange_(j),{lambda:j,phi:R}},ProjLAEA.prototype.mergeRange_=function(t,r){var i=null;return null==t?i=r:null!=r&&(i=t,r[0]<i[0]&&(i[0]=r[0]),i[1]<r[1]&&(i[1]=r[1])),i},ProjLAEA.prototype.normalizeLambdaRange_=function(t){var r=t[0];if(-Math.PI<=r&&r<Math.PI)return t;var i=2*Math.PI*Math.floor((r+Math.PI)/(2*Math.PI));return[t[0]-i,t[1]-i]},ProjLAEA.prototype.inverseLambdaRange_=function(t,r){var i=t[0]<=t[1]?t[0]:t[1],o=t[0]<=t[1]?t[1]:t[0],a=r[0]<=r[1]?r[0]:r[1],e=r[0]<=r[1]?r[1]:r[0],n=this.inverseLambdaRangeAtY_([i,o],[a,e]),h=this.inverseLambdaRangeAtX_([a,e],[i,o]);return this.mergeRange_(h,n)},ProjLAEA.prototype.inverseLambdaRangeAtY_=function(t,r){for(var i=t[0]<=t[1]?t[0]:t[1],o=t[0]<=t[1]?t[1]:t[0],a=null,e=this.dMath_.toDiscrete(i),n=this.dMath_.toDiscrete(o),h=r.length,s=e;s<=n;++s)for(var _=0;_<h;++_){var u=this.inverseLambdaAtY_(s,r[_]);a=this.mergeRange_(a,u)}return a},ProjLAEA.prototype.inverseLambdaRangeAtX_=function(t,r){for(var i=t[0]<=t[1]?t[0]:t[1],o=t[0]<=t[1]?t[1]:t[0],a=null,e=this.dMath_.toDiscrete(i),n=this.dMath_.toDiscrete(o),h=r.length,s=e;s<=n;++s)for(var _=0;_<h;++_){var u=this.inverseLambdaAtX_(s,r[_]);a=this.mergeRange_(a,u)}return a},ProjLAEA.prototype.inversePhiRange_=function(t,r){var i=t[0]<=t[1]?t[0]:t[1],o=t[0]<=t[1]?t[1]:t[0],a=r[0]<=r[1]?r[0]:r[1],e=r[0]<=r[1]?r[1]:r[0],n=this.inversePhiRangeAtY_([i,o],[a,e]),h=this.inversePhiRangeAtX_([a,e],[i,o]);return this.mergeRange_(h,n)},ProjLAEA.prototype.inversePhiRangeAtY_=function(t,r){for(var i=t[0]<=t[1]?t[0]:t[1],o=t[0]<=t[1]?t[1]:t[0],a=null,e=this.dMath_.toDiscrete(i),n=this.dMath_.toDiscrete(o),h=r.length,s=e;s<=n;++s)for(var _=0;_<h;++_){var u=this.inversePhiAtY_(s,r[_]);a=this.mergeRange_(a,u)}return a},ProjLAEA.prototype.inversePhiRangeAtX_=function(t,r){for(var i=t[0]<=t[1]?t[0]:t[1],o=t[0]<=t[1]?t[1]:t[0],a=null,e=this.dMath_.toDiscrete(i),n=this.dMath_.toDiscrete(o),h=r.length,s=e;s<=n;++s)for(var _=0;_<h;++_){var u=this.inversePhiAtX_(s,r[_]);a=this.mergeRange_(a,u)}return a},ProjLAEA.prototype.inverseLambdaAtX_=function(t,r){if(ProjMath.HALF_PI-ProjMath.EPSILON<Math.abs(this.phi0)){var i=0<this.phi0?-1:1,o=i*this.dMath_.X_lower(t),a=i*this.dMath_.X_upper(t),e=o<=a?a:o,n=o<=a?o:a,h=ProjMath.atan2Range({min:r,max:r},{min:n,max:e});return[h.min+this.lam0,h.max+this.lam0]}var s=this.cos_phi0_*this.dMath_.R_cotR_lower(t,r),_=this.cos_phi0_*this.dMath_.R_cotR_upper(t,r),u=s<=_?_:s,p=s<=_?s:_,c=-this.sin_phi0_*this.dMath_.X_lower(t),M=-this.sin_phi0_*this.dMath_.X_upper(t),P=u+(c<=M?M:c),l=p+(c<=M?c:M),v=ProjMath.atan2Range({min:r,max:r},{min:l,max:P});return[v.min+this.lam0,v.max+this.lam0]},ProjLAEA.prototype.inverseLambdaAtY_=function(t,r){if(ProjMath.HALF_PI-ProjMath.EPSILON<Math.abs(this.phi0)){var i=0<this.phi0?-1:1,o=this.dMath_.X_lower(t),a=this.dMath_.X_upper(t),e=ProjMath.atan2Range({min:o,max:a},{min:i*r,max:i*r});return[e.min+this.lam0,e.max+this.lam0]}var n=this.cos_phi0_*this.dMath_.R_cotR_lower(t,r)-this.sin_phi0_*r,h=this.cos_phi0_*this.dMath_.R_cotR_upper(t,r)-this.sin_phi0_*r,s=h<=n?n:h,_=h<=n?h:n,u=this.dMath_.X_lower(t),p=this.dMath_.X_upper(t),c=ProjMath.atan2Range({min:u,max:p},{min:_,max:s});return[c.min+this.lam0,c.max+this.lam0]},ProjLAEA.prototype.inversePhiAtY_=function(t,r){var i=this.dMath_.cosR_lower(t,r)*this.sin_phi0_,o=this.dMath_.cosR_upper(t,r)*this.sin_phi0_,a=i<=o?o:i,e=i<=o?i:o,n=r*this.dMath_.sinR_divR_lower(t,r)*this.cos_phi0_,h=r*this.dMath_.sinR_divR_upper(t,r)*this.cos_phi0_,s=n<=h?h:n,_=n<=h?n:h,u=ProjMath.clamp(a+s,-1,1),p=ProjMath.clamp(e+_,-1,1);return[Math.asin(p),Math.asin(u)]},ProjLAEA.prototype.inversePhiAtX_=function(t,r){var i=this.dMath_.cosR_lower(t,r)*this.sin_phi0_,o=this.dMath_.cosR_upper(t,r)*this.sin_phi0_,a=i<=o?o:i,e=i<=o?i:o,n=Math.abs(this.dMath_.X_lower(t)),h=Math.abs(this.dMath_.X_upper(t)),s=n<=h?h:n,_=n<=h?n:h,u=Math.abs(this.cos_phi0_),p=s*this.dMath_.sinR_divR_upper(t,r)*u,c=_*this.dMath_.sinR_divR_lower(t,r)*u,M=0<=t*this.cos_phi0_?1:-1,P=0<M?+p:-c,l=0<M?+c:-p,v=ProjMath.clamp(a+P,-1,1),d=ProjMath.clamp(e+l,-1,1);return[Math.asin(d),Math.asin(v)]},ProjLAEA.prototype.getVertexShaderStr=function(){return ProjLAEA.VERTEX_SHADER_STR},ProjLAEA.prototype.getFragmentShaderStr=function(){return ProjLAEA.FRAGMENT_SHADER_STR},ProjLAEA.VERTEX_SHADER_STR=["precision highp float;","attribute float aCoordX;","attribute float aCoordY;","uniform mat3 uFwdTransform;","uniform vec2 uProjCenter;","varying vec2 vCoord;","varying float vInRange;","uniform float uPointSize;","uniform lowp int uCoordType;","uniform lowp int uTextureType;","const float pi = 3.141592653589793;","const float epsilon = 0.001;","const float xyDomain = 0.86 * 0.707106781 * pi;","vec2 proj_forward(vec2 center, vec2 lp)","{","  float sinPhi0 = sin(center.y);","  float cosPhi0 = cos(center.y);","  float sinPhi = sin(lp.y);","  float cosPhi = cos(lp.y);","  float sinLam = sin(lp.x - center.x);","  float cosLam = cos(lp.x - center.x);","  float v = sinPhi0 * sinPhi + cosPhi0 * cosPhi * cosLam;","  float x = cosPhi * sinLam;","  float y = cosPhi0 * sinPhi - sinPhi0 * cosPhi * cosLam;","  if ( v < -1.0 + epsilon ) {","    return 2.0 * normalize(vec2(x, y));","  }","  float k = sqrt(2.0 / (1.0 + v));","  return k * vec2(x, y);","}","float check_xy_range(vec2 xy)","{","  return 1.0 - step(xyDomain, length(xy));","}","void main()","{","  vInRange = 1.0;","  vec3 pos;","  if ( uTextureType == 2 || uCoordType == 2 ) {","    pos = vec3(aCoordX, aCoordY, 1.0);","  } else if ( uCoordType == 1 ) {","    pos = uFwdTransform * vec3(aCoordX, aCoordY, 1.0);","    vInRange = check_xy_range(vec2(aCoordX, aCoordY));","  } else {","    vec2 xy = proj_forward(uProjCenter, vec2(aCoordX, aCoordY));","    vInRange = check_xy_range(xy);","    pos = uFwdTransform * vec3(xy.x, xy.y, 1.0);","  }","  vCoord = pos.xy;","  gl_Position = vec4(pos, 1.0);","  gl_PointSize = uPointSize;","}"].join("\n"),ProjLAEA.FRAGMENT_SHADER_STR=["precision highp float;","uniform mat3 uInvTransform;","uniform vec2 uDataCoord1;","uniform vec2 uDataCoord2;","uniform lowp int uCoordType;","uniform lowp int uTextureType;","uniform sampler2D uTexture;","uniform vec2 uProjCenter;","uniform vec4 uColor;","varying vec2 vCoord;","varying float vInRange;","const float pi = 3.141592653589793;","const float epsilon = 0.00000001;","const float blurRatio = 0.015;","const float xyRadius = 2.0;","vec2 proj_inverse(vec2 center, vec2 xy)","{","  float sinPhi0 = sin(center.y);","  float cosPhi0 = cos(center.y);","  float rho = length(xy);","  if ( rho < epsilon ) {","    return center;","  }","  if ( rho - epsilon > xyRadius ) {","    rho = xyRadius;","  }","  float c_rh = 2.0 * asin( clamp( rho/2.0, -1.0, 1.0) );","  float cos_c = cos(c_rh);","  float sin_c = sin(c_rh);","  float phi = asin( clamp( cos_c * sinPhi0 + xy.y * sin_c * cosPhi0 / rho, -1.0, 1.0 ) );","  float lam = mod( center.x + atan( xy.x * sin_c, rho * cosPhi0 * cos_c - xy.y * sinPhi0 * sin_c ) + pi, 2.0 * pi ) - pi;","  return vec2(lam, phi);","}","float inner_xy(vec2 xy)","{","  return 1.0 - smoothstep( (1.0 - blurRatio) * xyRadius, (1.0 + blurRatio) * xyRadius, length(xy) );","}","void main()","{","  if ( vInRange < 0.5 ) {","    discard;","    return;","  }","  vec4 outColor;","  bool isDiscard = false;","  if ( uTextureType == 2 ) {","    float inXY = 1.0;","    vec2 coord;","    if ( uCoordType == 2 ) {","      coord = vCoord;","    } else {","      vec3 viewCoord = uInvTransform * vec3(vCoord.x, vCoord.y, 1.0);","      inXY = inner_xy(viewCoord.xy);","      if ( 0.0 < inXY ) {","        if ( uCoordType == 1 ) {","          coord = viewCoord.xy;","        } else if ( uCoordType == 0 ) {","          coord = proj_inverse(uProjCenter, viewCoord.xy);","        }","      } else {","        isDiscard = true;","        coord = vec2(0.0, 0.0);","      }","    }","    if ( !isDiscard ) {","      vec2 ts = (coord - uDataCoord1) / (uDataCoord2 - uDataCoord1);","      if ( 0.0 <= ts.x && 0.0 <= ts.y && ts.x <= 1.0 && ts.y <= 1.0) {","        outColor = texture2D(uTexture, vec2(ts.x, 1.0 - ts.y)) * inXY;","      } else {","        isDiscard = true;","      }","    }","  } else if ( uTextureType == 1 ) {","    outColor = texture2D(uTexture, gl_PointCoord);","    isDiscard = (outColor.a == 0.0);","  } else {","    outColor = uColor;","    isDiscard = (outColor.a == 0.0);","  }","  if ( isDiscard ) {","    discard;","  } else {","    gl_FragColor = outColor;","  }","}"].join("\n"),"undefined"!=typeof module&&module.exports&&(module.exports=ProjLAEA,module.exports.ProjDiscreteMath=ProjDiscreteMath);