/*!
 * Raster Map Projection v0.0.19  2017-09-18
 *   https://github.com/tomosn/raster-map-projection
 * Copyright (C) 2016-2017 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */

"use strict";Math.cosh||(Math.cosh=function(t){return(Math.exp(t)+Math.exp(-t))/2}),Math.sinh||(Math.sinh=function(t){return(Math.exp(t)-Math.exp(-t))/2});var RasterMapProjection=function(){};RasterMapProjection.createProjection=function(t,r,o){return null},RasterMapProjection.createShaderProgram=function(t){return new ProjShaderProgram(t)};var CommonUtils=function(){};CommonUtils.clone=function(t){var r={};for(var o in t)r[o]=t[o];return r};var ImageUtils=function(){};ImageUtils.createTexture=function(t,r){var o=t.createTexture();return t.bindTexture(t.TEXTURE_2D,o),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,o),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.bindTexture(t.TEXTURE_2D,null),o};var MathUtils=function(){};MathUtils.getTransform=function(t,r){var o=t.x2-t.x1,e=t.y2-t.y1;return[(r.x2-r.x1)/o,0,0,0,(r.y2-r.y1)/e,0,(r.x1*t.x2-t.x1*r.x2)/o,(r.y1*t.y2-t.y1*r.y2)/e,1]};var ProjMath=function(){};ProjMath.EPSILON=1e-7,ProjMath.SQRT_2=Math.sqrt(2),ProjMath.PI_SQ=Math.PI*Math.PI,ProjMath.HALF_PI=Math.PI/2,ProjMath.clamp=function(t,r,o){return Math.max(r,Math.min(o,t))},ProjMath.atan2Range=function(t,r){var o=r.min,e=r.max,i=t.min,a=t.max;if(0<=i)return 0<o?{min:Math.atan2(i,e),max:Math.atan2(a,o)}:e<0?{min:Math.atan2(a,e),max:Math.atan2(i,o)}:{min:Math.atan2(i,e),max:Math.atan2(i,o)};if(a<0)return 0<o?{min:Math.atan2(i,o),max:Math.atan2(a,e)}:e<0?{min:Math.atan2(a,o),max:Math.atan2(i,e)}:{min:Math.atan2(a,o),max:Math.atan2(a,e)};if(0<o)return{min:Math.atan2(i,o),max:Math.atan2(a,o)};if(e<0){var h=Math.atan2(a,e),n=Math.atan2(i,e);return Math.PI<=h?{min:h-2*Math.PI,max:n}:{min:h,max:n+2*Math.PI}}return{min:-Math.PI,max:Math.PI}},ProjMath.toLambdaPhi=function(t){var r=Math.sqrt(t[0]*t[0]+t[1]*t[1]);return{lambda:Math.atan2(t[1],t[0]),phi:Math.atan2(t[2],r)}},ProjMath.normalizeLambda=function(t){return-Math.PI<=t&&t<Math.PI?t:t-2*Math.PI*Math.floor((t+Math.PI)/(2*Math.PI))},ProjMath.neighborPoint=function(t,r){if(ProjMath.EPSILON<=Math.abs(t.phi-r.phi))return!1;var o=ProjMath.normalizeLambda(t.lambda),e=ProjMath.normalizeLambda(r.lambda);return Math.abs(o-e)<ProjMath.EPSILON};var ProjShaderProgram=function(t){this.gl_=t,this.vbo_=null,this.program_=null,this.coordsBuffer_=null,this.locAttrCoordX_=null,this.locAttrCoordY_=null,this.locUnifFwdTransform_=null,this.locUnifInvTransform_=null,this.locUnifProjCenter_=null,this.locUnifDataCoord1_=null,this.locUnifDataCoord2_=null,this.locUnifPointSize_=null,this.locUnifCoordType_=null,this.locUnifColor_=null,this.locUnifOpacity_=null,this.locUnifTextureType_=null,this.locUnifTexture_=null};ProjShaderProgram.SCREEN_RECT={x1:-1,y1:-1,x2:1,y2:1},ProjShaderProgram.DIMENSION=2,ProjShaderProgram.POINTS_BUFFER_SIZE=64,ProjShaderProgram.COORD_TYPE_DATA=0,ProjShaderProgram.COORD_TYPE_XY=1,ProjShaderProgram.COORD_TYPE_SCREEN=2,ProjShaderProgram.TEXTURE_TYPE_NONE=0,ProjShaderProgram.TEXTURE_TYPE_POINT=1,ProjShaderProgram.TEXTURE_TYPE_SURFACE=2,ProjShaderProgram.prototype.setColor=function(t){this.gl_.uniform4f(this.locUnifColor_,t.r,t.g,t.b,t.a)},ProjShaderProgram.prototype.setViewWindow=function(t,r,o,e){var i=o-t,a=e-r,h=t+o,n=r+e,l=[2/i,0,0,0,2/a,0,-h/i,-n/a,1],_=[i/2,0,0,0,a/2,0,h/2,n/2,1];this.gl_.uniformMatrix3fv(this.locUnifFwdTransform_,!1,l),this.gl_.uniformMatrix3fv(this.locUnifInvTransform_,!1,_)},ProjShaderProgram.prototype.setProjCenter=function(t,r){this.gl_.uniform2f(this.locUnifProjCenter_,t,r)},ProjShaderProgram.prototype.setPointSize=function(t){this.gl_.uniform1f(this.locUnifPointSize_,t)},ProjShaderProgram.prototype.setPointTexture=function(t){null!=t?(this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_POINT),this.bindTexture(t)):(this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_NONE),this.bindTexture(null))},ProjShaderProgram.prototype.setCoordType=function(t){this.gl_.uniform1i(this.locUnifCoordType_,t)},ProjShaderProgram.prototype.setCoordTypeData=function(){this.gl_.uniform1i(this.locUnifCoordType_,ProjShaderProgram.COORD_TYPE_DATA)},ProjShaderProgram.prototype.setCoordTypeXY=function(){this.gl_.uniform1i(this.locUnifCoordType_,ProjShaderProgram.COORD_TYPE_XY)},ProjShaderProgram.prototype.setCoordTypeScreen=function(){this.gl_.uniform1i(this.locUnifCoordType_,ProjShaderProgram.COORD_TYPE_SCREEN)},ProjShaderProgram.prototype.setClearColor=function(t){this.gl_.clearColor(t.r,t.g,t.b,t.a),this.gl_.enable(this.gl_.BLEND)},ProjShaderProgram.prototype.clear=function(t){this.gl_.clear(this.gl_.COLOR_BUFFER_BIT),this.gl_.viewport(0,0,t.width,t.height)},ProjShaderProgram.prototype.setOpacity=function(t){this.gl_.uniform1f(this.locUnifOpacity_,t)},ProjShaderProgram.prototype.bindTexture=function(t){this.gl_.activeTexture(this.gl_.TEXTURE0),this.gl_.bindTexture(this.gl_.TEXTURE_2D,t)},ProjShaderProgram.prototype.setTextureType_=function(t){this.gl_.uniform1i(this.locUnifTextureType_,t)},ProjShaderProgram.prototype.prepareRenderSurface=function(){this.gl_.enableVertexAttribArray(this.locAttrCoordX_),this.gl_.vertexAttribPointer(this.locAttrCoordX_,1,this.gl_.FLOAT,this.gl_.FALSE,8,0),this.gl_.enableVertexAttribArray(this.locAttrCoordY_),this.gl_.vertexAttribPointer(this.locAttrCoordY_,1,this.gl_.FLOAT,this.gl_.FALSE,8,4);var t=new Float32Array([-1,1,-1,-1,1,1,1,-1]);this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,t),this.gl_.activeTexture(this.gl_.TEXTURE0),this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_SURFACE),this.bindTexture(null)},ProjShaderProgram.prototype.prepareRenderPoints=function(){this.gl_.enableVertexAttribArray(this.locAttrCoordX_),this.gl_.vertexAttribPointer(this.locAttrCoordX_,1,this.gl_.FLOAT,this.gl_.FALSE,8,0),this.gl_.enableVertexAttribArray(this.locAttrCoordY_),this.gl_.vertexAttribPointer(this.locAttrCoordY_,1,this.gl_.FLOAT,this.gl_.FALSE,8,4),this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_NONE),this.bindTexture(null)},ProjShaderProgram.prototype.prepareRenderPolyline=function(){this.gl_.enableVertexAttribArray(this.locAttrCoordX_),this.gl_.vertexAttribPointer(this.locAttrCoordX_,1,this.gl_.FLOAT,this.gl_.FALSE,8,0),this.gl_.enableVertexAttribArray(this.locAttrCoordY_),this.gl_.vertexAttribPointer(this.locAttrCoordY_,1,this.gl_.FLOAT,this.gl_.FALSE,8,4),this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_NONE),this.bindTexture(null)},ProjShaderProgram.prototype.prepareRenderLatitudeLine=function(){this.gl_.disableVertexAttribArray(this.locAttrCoordX_),this.gl_.enableVertexAttribArray(this.locAttrCoordY_),this.gl_.vertexAttribPointer(this.locAttrCoordY_,1,this.gl_.FLOAT,this.gl_.FALSE,0,0),this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_NONE),this.bindTexture(null)},ProjShaderProgram.prototype.prepareRenderLongitudeLine=function(){this.gl_.disableVertexAttribArray(this.locAttrCoordY_),this.gl_.enableVertexAttribArray(this.locAttrCoordX_),this.gl_.vertexAttribPointer(this.locAttrCoordX_,1,this.gl_.FLOAT,this.gl_.FALSE,0,0),this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_NONE),this.bindTexture(null)},ProjShaderProgram.prototype.renderSurfaceTexture=function(t,r){this.gl_.bindTexture(this.gl_.TEXTURE_2D,t),this.gl_.uniform2f(this.locUnifDataCoord1_,r[0],r[1]),this.gl_.uniform2f(this.locUnifDataCoord2_,r[2],r[3]),this.gl_.drawArrays(this.gl_.TRIANGLE_STRIP,0,4)},ProjShaderProgram.prototype.renderPolyline=function(t){if(t.length/2<=ProjShaderProgram.POINTS_BUFFER_SIZE)this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(t)),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,t.length/2);else{var r=0,o=0;do{o=r+2*ProjShaderProgram.POINTS_BUFFER_SIZE,t.length<o&&(o=t.length);var e=t.slice(r,o);this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(e)),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,e.length/2),r=o-2}while(o<t.length)}},ProjShaderProgram.prototype.renderPoints=function(t){if(t.length/2<=ProjShaderProgram.POINTS_BUFFER_SIZE)this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(t)),this.gl_.drawArrays(this.gl_.POINTS,0,t.length/2);else{var r=0,o=0;do{o=r+2*ProjShaderProgram.POINTS_BUFFER_SIZE,t.length<o&&(o=t.length);var e=t.slice(r,o);this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(e)),this.gl_.drawArrays(this.gl_.POINTS,0,e.length/2),r=o}while(o<t.length)}},ProjShaderProgram.prototype.renderLatitudeLine=function(t,r,o){this.gl_.vertexAttrib1f(this.locAttrCoordX_,t),this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(r)),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,r.length)},ProjShaderProgram.prototype.renderLongitudeLine=function(t,r,o){this.gl_.vertexAttrib1f(this.locAttrCoordY_,t),this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(r)),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,r.length)},ProjShaderProgram.prototype.init=function(t,r){var o=this.loadShader_(this.gl_.VERTEX_SHADER,t),e=this.loadShader_(this.gl_.FRAGMENT_SHADER,r),i=this.gl_.createProgram();if(this.gl_.attachShader(i,o),this.gl_.attachShader(i,e),this.gl_.linkProgram(i),!this.gl_.getProgramParameter(i,this.gl_.LINK_STATUS)&&!this.gl_.isContextLost()){var a=this.gl_.getProgramInfoLog(i);return alert("Error linking program:\n"+a),this.gl_.deleteProgram(i),!1}return this.program_=i,this.gl_.useProgram(this.program_),this.locAttrCoordX_=this.gl_.getAttribLocation(this.program_,"aCoordX"),this.locAttrCoordY_=this.gl_.getAttribLocation(this.program_,"aCoordY"),this.locUnifFwdTransform_=this.gl_.getUniformLocation(this.program_,"uFwdTransform"),this.locUnifInvTransform_=this.gl_.getUniformLocation(this.program_,"uInvTransform"),this.locUnifProjCenter_=this.gl_.getUniformLocation(this.program_,"uProjCenter"),this.locUnifDataCoord1_=this.gl_.getUniformLocation(this.program_,"uDataCoord1"),this.locUnifDataCoord2_=this.gl_.getUniformLocation(this.program_,"uDataCoord2"),this.locUnifPointSize_=this.gl_.getUniformLocation(this.program_,"uPointSize"),this.locUnifCoordType_=this.gl_.getUniformLocation(this.program_,"uCoordType"),this.locUnifColor_=this.gl_.getUniformLocation(this.program_,"uColor"),this.locUnifOpacity_=this.gl_.getUniformLocation(this.program_,"uOpacity"),this.locUnifTextureType_=this.gl_.getUniformLocation(this.program_,"uTextureType"),this.locUnifTexture_=this.gl_.getUniformLocation(this.program_,"uTexture"),this.coordsBuffer_=this.createBuffer_(ProjShaderProgram.DIMENSION,ProjShaderProgram.POINTS_BUFFER_SIZE),this.gl_.bindBuffer(this.gl_.ARRAY_BUFFER,this.coordsBuffer_.buffer),this.setClearColor({r:0,g:.1,b:0,a:1}),this.setOpacity(1),this.gl_.blendFunc(this.gl_.SRC_ALPHA,this.gl_.ONE_MINUS_SRC_ALPHA),!0},ProjShaderProgram.prototype.loadShader_=function(t,r){var o=this.gl_.createShader(t);if(this.gl_.shaderSource(o,r),this.gl_.compileShader(o),!this.gl_.getShaderParameter(o,this.gl_.COMPILE_STATUS)&&!this.gl_.isContextLost()){var e=this.gl_.getShaderInfoLog(o);return alert("Error compiling shader:\n"+e),this.gl_.deleteShader(o),null}return o},ProjShaderProgram.prototype.createBuffer_=function(t,r){var o=this.gl_.createBuffer();return this.gl_.bindBuffer(this.gl_.ARRAY_BUFFER,o),this.gl_.bufferData(this.gl_.ARRAY_BUFFER,r*t*4,this.gl_.DYNAMIC_DRAW),{buffer:o,dimension:t,maxNum:r}},"undefined"!=typeof module&&module.exports&&(module.exports=ProjShaderProgram);