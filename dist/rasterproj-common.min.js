/*!
 * Raster Map Projection v0.0.16  2017-06-18
 *   https://github.com/tomosn/raster-map-projection
 * Copyright (C) 2016-2017 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */
"use strict";Math.cosh||(Math.cosh=function(a){return(Math.exp(a)+Math.exp(-a))/2}),Math.sinh||(Math.sinh=function(a){return(Math.exp(a)-Math.exp(-a))/2});var RasterMapProjection=function(){};RasterMapProjection.createProjection=function(a,b,c){return null},RasterMapProjection.createShaderProgram=function(a){return new ProjShaderProgram(a)};var CommonUtils=function(){};CommonUtils.clone=function(a){var b={};for(var c in a)b[c]=a[c];return b};var ImageUtils=function(){};ImageUtils.createTexture=function(a,b){var c=a.createTexture();return a.bindTexture(a.TEXTURE_2D,c),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,c),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b),a.bindTexture(a.TEXTURE_2D,null),c};var MathUtils=function(){};MathUtils.getTransform=function(a,b){var c=a.x2-a.x1,d=a.y2-a.y1,e=(b.x2-b.x1)/c,f=(b.y2-b.y1)/d,g=(b.x1*a.x2-a.x1*b.x2)/c,h=(b.y1*a.y2-a.y1*b.y2)/d;return[e,0,0,0,f,0,g,h,1]};var ProjMath=function(){};ProjMath.EPSILON=1e-7,ProjMath.SQRT_2=Math.sqrt(2),ProjMath.PI_SQ=Math.PI*Math.PI,ProjMath.HALF_PI=Math.PI/2,ProjMath.clamp=function(a,b,c){return Math.max(b,Math.min(c,a))},ProjMath.atan2Range=function(a,b){var c=b.min,d=b.max,e=a.min,f=a.max;if(0<=e)return 0<c?{min:Math.atan2(e,d),max:Math.atan2(f,c)}:d<0?{min:Math.atan2(f,d),max:Math.atan2(e,c)}:{min:Math.atan2(e,d),max:Math.atan2(e,c)};if(f<0)return 0<c?{min:Math.atan2(e,c),max:Math.atan2(f,d)}:d<0?{min:Math.atan2(f,c),max:Math.atan2(e,d)}:{min:Math.atan2(f,c),max:Math.atan2(f,d)};if(0<c)return{min:Math.atan2(e,c),max:Math.atan2(f,c)};if(d<0){var g=Math.atan2(f,d),h=Math.atan2(e,d);return Math.PI<=g?{min:g-2*Math.PI,max:h}:{min:g,max:h+2*Math.PI}}return{min:-Math.PI,max:Math.PI}},ProjMath.toLambdaPhi=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]),c=Math.atan2(a[1],a[0]),d=Math.atan2(a[2],b);return{lambda:c,phi:d}},ProjMath.normalizeLambda=function(a){return-Math.PI<=a&&a<Math.PI?a:a-2*Math.PI*Math.floor((a+Math.PI)/(2*Math.PI))},ProjMath.neighborPoint=function(a,b){if(ProjMath.EPSILON<=Math.abs(a.phi-b.phi))return!1;var c=ProjMath.normalizeLambda(a.lambda),d=ProjMath.normalizeLambda(b.lambda);return Math.abs(c-d)<ProjMath.EPSILON};var ProjShaderProgram=function(a){this.gl_=a,this.vbo_=null,this.program_=null,this.coordsBuffer_=null,this.locAttrCoordX_=null,this.locAttrCoordY_=null,this.locUnifFwdTransform_=null,this.locUnifInvTransform_=null,this.locUnifProjCenter_=null,this.locUnifDataCoord1_=null,this.locUnifDataCoord2_=null,this.locUnifPointSize_=null,this.locUnifCoordType_=null,this.locUnifColor_=null,this.locUnifTextureType_=null,this.locUnifTexture_=null};ProjShaderProgram.SCREEN_RECT={x1:-1,y1:-1,x2:1,y2:1},ProjShaderProgram.DIMENSION=2,ProjShaderProgram.POINTS_BUFFER_SIZE=64,ProjShaderProgram.COORD_TYPE_DATA=0,ProjShaderProgram.COORD_TYPE_XY=1,ProjShaderProgram.COORD_TYPE_SCREEN=2,ProjShaderProgram.TEXTURE_TYPE_NONE=0,ProjShaderProgram.TEXTURE_TYPE_POINT=1,ProjShaderProgram.TEXTURE_TYPE_SURFACE=2,ProjShaderProgram.prototype.setColor=function(a){this.gl_.uniform4f(this.locUnifColor_,a.r,a.g,a.b,a.a)},ProjShaderProgram.prototype.setViewWindow=function(a,b,c,d){var e=c-a,f=d-b,g=a+c,h=b+d,i=[2/e,0,0,0,2/f,0,-g/e,-h/f,1],j=[e/2,0,0,0,f/2,0,g/2,h/2,1];this.gl_.uniformMatrix3fv(this.locUnifFwdTransform_,!1,i),this.gl_.uniformMatrix3fv(this.locUnifInvTransform_,!1,j)},ProjShaderProgram.prototype.setProjCenter=function(a,b){this.gl_.uniform2f(this.locUnifProjCenter_,a,b)},ProjShaderProgram.prototype.setPointSize=function(a){this.gl_.uniform1f(this.locUnifPointSize_,a)},ProjShaderProgram.prototype.setPointTexture=function(a){null!=a?(this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_POINT),this.bindTexture(a)):(this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_NONE),this.bindTexture(null))},ProjShaderProgram.prototype.setCoordType=function(a){this.gl_.uniform1i(this.locUnifCoordType_,a)},ProjShaderProgram.prototype.setCoordTypeData=function(){this.gl_.uniform1i(this.locUnifCoordType_,ProjShaderProgram.COORD_TYPE_DATA)},ProjShaderProgram.prototype.setCoordTypeXY=function(){this.gl_.uniform1i(this.locUnifCoordType_,ProjShaderProgram.COORD_TYPE_XY)},ProjShaderProgram.prototype.setCoordTypeScreen=function(){this.gl_.uniform1i(this.locUnifCoordType_,ProjShaderProgram.COORD_TYPE_SCREEN)},ProjShaderProgram.prototype.setClearColor=function(a){this.gl_.clearColor(a.r,a.g,a.b,a.a),this.gl_.enable(this.gl_.BLEND)},ProjShaderProgram.prototype.clear=function(a){this.gl_.clear(this.gl_.COLOR_BUFFER_BIT),this.gl_.viewport(0,0,a.width,a.height)},ProjShaderProgram.prototype.bindTexture=function(a){this.gl_.activeTexture(this.gl_.TEXTURE0),this.gl_.bindTexture(this.gl_.TEXTURE_2D,a)},ProjShaderProgram.prototype.setTextureType_=function(a){this.gl_.uniform1i(this.locUnifTextureType_,a)},ProjShaderProgram.prototype.prepareRenderSurface=function(){this.gl_.enableVertexAttribArray(this.locAttrCoordX_),this.gl_.vertexAttribPointer(this.locAttrCoordX_,1,this.gl_.FLOAT,this.gl_.FALSE,8,0),this.gl_.enableVertexAttribArray(this.locAttrCoordY_),this.gl_.vertexAttribPointer(this.locAttrCoordY_,1,this.gl_.FLOAT,this.gl_.FALSE,8,4);var a=new Float32Array([-1,1,-1,-1,1,1,1,-1]);this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,a),this.gl_.activeTexture(this.gl_.TEXTURE0),this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_SURFACE),this.bindTexture(null)},ProjShaderProgram.prototype.prepareRenderPoints=function(){this.gl_.enableVertexAttribArray(this.locAttrCoordX_),this.gl_.vertexAttribPointer(this.locAttrCoordX_,1,this.gl_.FLOAT,this.gl_.FALSE,8,0),this.gl_.enableVertexAttribArray(this.locAttrCoordY_),this.gl_.vertexAttribPointer(this.locAttrCoordY_,1,this.gl_.FLOAT,this.gl_.FALSE,8,4),this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_NONE),this.bindTexture(null)},ProjShaderProgram.prototype.prepareRenderPolyline=function(){this.gl_.enableVertexAttribArray(this.locAttrCoordX_),this.gl_.vertexAttribPointer(this.locAttrCoordX_,1,this.gl_.FLOAT,this.gl_.FALSE,8,0),this.gl_.enableVertexAttribArray(this.locAttrCoordY_),this.gl_.vertexAttribPointer(this.locAttrCoordY_,1,this.gl_.FLOAT,this.gl_.FALSE,8,4),this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_NONE),this.bindTexture(null)},ProjShaderProgram.prototype.prepareRenderLatitudeLine=function(){this.gl_.disableVertexAttribArray(this.locAttrCoordX_),this.gl_.enableVertexAttribArray(this.locAttrCoordY_),this.gl_.vertexAttribPointer(this.locAttrCoordY_,1,this.gl_.FLOAT,this.gl_.FALSE,0,0),this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_NONE),this.bindTexture(null)},ProjShaderProgram.prototype.prepareRenderLongitudeLine=function(){this.gl_.disableVertexAttribArray(this.locAttrCoordY_),this.gl_.enableVertexAttribArray(this.locAttrCoordX_),this.gl_.vertexAttribPointer(this.locAttrCoordX_,1,this.gl_.FLOAT,this.gl_.FALSE,0,0),this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_NONE),this.bindTexture(null)},ProjShaderProgram.prototype.renderSurfaceTexture=function(a,b){this.gl_.bindTexture(this.gl_.TEXTURE_2D,a),this.gl_.uniform2f(this.locUnifDataCoord1_,b[0],b[1]),this.gl_.uniform2f(this.locUnifDataCoord2_,b[2],b[3]),this.gl_.drawArrays(this.gl_.TRIANGLE_STRIP,0,4)},ProjShaderProgram.prototype.renderPolyline=function(a){if(a.length/2<=ProjShaderProgram.POINTS_BUFFER_SIZE)this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(a)),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,a.length/2);else{var b=0,c=0;do{c=b+2*ProjShaderProgram.POINTS_BUFFER_SIZE,a.length<c&&(c=a.length);var d=a.slice(b,c);this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(d)),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,d.length/2),b=c-2}while(c<a.length)}},ProjShaderProgram.prototype.renderPoints=function(a){if(a.length/2<=ProjShaderProgram.POINTS_BUFFER_SIZE)this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(a)),this.gl_.drawArrays(this.gl_.POINTS,0,a.length/2);else{var b=0,c=0;do{c=b+2*ProjShaderProgram.POINTS_BUFFER_SIZE,a.length<c&&(c=a.length);var d=a.slice(b,c);this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(d)),this.gl_.drawArrays(this.gl_.POINTS,0,d.length/2),b=c}while(c<a.length)}},ProjShaderProgram.prototype.renderLatitudeLine=function(a,b,c){this.gl_.vertexAttrib1f(this.locAttrCoordX_,a),this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(b)),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,b.length)},ProjShaderProgram.prototype.renderLongitudeLine=function(a,b,c){this.gl_.vertexAttrib1f(this.locAttrCoordY_,a),this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(b)),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,b.length)},ProjShaderProgram.prototype.init=function(a,b){var c=this.loadShader_(this.gl_.VERTEX_SHADER,a),d=this.loadShader_(this.gl_.FRAGMENT_SHADER,b),e=this.gl_.createProgram();this.gl_.attachShader(e,c),this.gl_.attachShader(e,d),this.gl_.linkProgram(e);var f=this.gl_.getProgramParameter(e,this.gl_.LINK_STATUS);if(!f&&!this.gl_.isContextLost()){var g=this.gl_.getProgramInfoLog(e);return alert("Error linking program:\n"+g),this.gl_.deleteProgram(e),!1}return this.program_=e,this.gl_.useProgram(this.program_),this.locAttrCoordX_=this.gl_.getAttribLocation(this.program_,"aCoordX"),this.locAttrCoordY_=this.gl_.getAttribLocation(this.program_,"aCoordY"),this.locUnifFwdTransform_=this.gl_.getUniformLocation(this.program_,"uFwdTransform"),this.locUnifInvTransform_=this.gl_.getUniformLocation(this.program_,"uInvTransform"),this.locUnifProjCenter_=this.gl_.getUniformLocation(this.program_,"uProjCenter"),this.locUnifDataCoord1_=this.gl_.getUniformLocation(this.program_,"uDataCoord1"),this.locUnifDataCoord2_=this.gl_.getUniformLocation(this.program_,"uDataCoord2"),this.locUnifPointSize_=this.gl_.getUniformLocation(this.program_,"uPointSize"),this.locUnifCoordType_=this.gl_.getUniformLocation(this.program_,"uCoordType"),this.locUnifColor_=this.gl_.getUniformLocation(this.program_,"uColor"),this.locUnifTextureType_=this.gl_.getUniformLocation(this.program_,"uTextureType"),this.locUnifTexture_=this.gl_.getUniformLocation(this.program_,"uTexture"),this.coordsBuffer_=this.createBuffer_(ProjShaderProgram.DIMENSION,ProjShaderProgram.POINTS_BUFFER_SIZE),this.gl_.bindBuffer(this.gl_.ARRAY_BUFFER,this.coordsBuffer_.buffer),this.setClearColor({r:0,g:.1,b:0,a:1}),this.gl_.blendFunc(this.gl_.SRC_ALPHA,this.gl_.ONE_MINUS_SRC_ALPHA),!0},ProjShaderProgram.prototype.loadShader_=function(a,b){var c=this.gl_.createShader(a);if(this.gl_.shaderSource(c,b),this.gl_.compileShader(c),!this.gl_.getShaderParameter(c,this.gl_.COMPILE_STATUS)&&!this.gl_.isContextLost()){var d=this.gl_.getShaderInfoLog(c);return alert("Error compiling shader:\n"+d),this.gl_.deleteShader(c),null}return c},ProjShaderProgram.prototype.createBuffer_=function(a,b){var c=this.gl_.createBuffer();return this.gl_.bindBuffer(this.gl_.ARRAY_BUFFER,c),this.gl_.bufferData(this.gl_.ARRAY_BUFFER,b*a*4,this.gl_.DYNAMIC_DRAW),{buffer:c,dimension:a,maxNum:b}},"undefined"!=typeof module&&module.exports&&(module.exports=ProjShaderProgram);