/*!
 * RasterMapProjection v0.0.23  2018-11-18
 *   https://github.com/tomosn/raster-map-projection
 * Copyright (C) 2016-2018 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */

"use strict";Math.cosh||(Math.cosh=function(t){return(Math.exp(t)+Math.exp(-t))/2}),Math.sinh||(Math.sinh=function(t){return(Math.exp(t)-Math.exp(-t))/2});var RasterMapProjection=function(){};RasterMapProjection.createProjection=function(t,r,i){return null},RasterMapProjection.createShaderProgram=function(t){return new ProjShaderProgram(t)};var ImageUtils=function(){};ImageUtils.createTexture=function(t,r){var i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.bindTexture(t.TEXTURE_2D,null),i};var MathUtils=function(){};MathUtils.getTransform=function(t,r){var i=t.x2-t.x1,o=t.y2-t.y1;return[(r.x2-r.x1)/i,0,0,0,(r.y2-r.y1)/o,0,(r.x1*t.x2-t.x1*r.x2)/i,(r.y1*t.y2-t.y1*r.y2)/o,1]};var ProjMath=function(){};ProjMath.EPSILON=1e-7,ProjMath.SQRT_2=Math.sqrt(2),ProjMath.PI_SQ=Math.PI*Math.PI,ProjMath.HALF_PI=Math.PI/2,ProjMath.clamp=function(t,r,i){return Math.max(r,Math.min(i,t))},ProjMath.atan2Range=function(t,r){var i=r.min,o=r.max,a=t.min,e=t.max;if(0<=a)return 0<i?{min:Math.atan2(a,o),max:Math.atan2(e,i)}:o<0?{min:Math.atan2(e,o),max:Math.atan2(a,i)}:{min:Math.atan2(a,o),max:Math.atan2(a,i)};if(e<0)return 0<i?{min:Math.atan2(a,i),max:Math.atan2(e,o)}:o<0?{min:Math.atan2(e,i),max:Math.atan2(a,o)}:{min:Math.atan2(e,i),max:Math.atan2(e,o)};if(0<i)return{min:Math.atan2(a,i),max:Math.atan2(e,i)};if(o<0){var n=Math.atan2(e,o),h=Math.atan2(a,o);return Math.PI<=n?{min:n-2*Math.PI,max:h}:{min:n,max:h+2*Math.PI}}return{min:-Math.PI,max:Math.PI}},ProjMath.toLambdaPhi=function(t){var r=Math.sqrt(t[0]*t[0]+t[1]*t[1]);return{lambda:Math.atan2(t[1],t[0]),phi:Math.atan2(t[2],r)}},ProjMath.normalizeLambda=function(t){return-Math.PI<=t&&t<Math.PI?t:t-2*Math.PI*Math.floor((t+Math.PI)/(2*Math.PI))},ProjMath.neighborPoint=function(t,r){if(ProjMath.EPSILON<=Math.abs(t.phi-r.phi))return!1;var i=ProjMath.normalizeLambda(t.lambda),o=ProjMath.normalizeLambda(r.lambda);return Math.abs(i-o)<ProjMath.EPSILON},ProjMath.calcAngle=function(t,r,i,o){return Math.atan2(t*o-i*r,t*i+r*o)};var RangeUtils=function(){};RangeUtils.intersects_=function(t,r){return(r[0]-t[1])*(r[1]-t[0])<=0},RangeUtils.unionIfIntersects=function(t,r){return null===t||null===r?null:RangeUtils.intersects_(t,r)?[t[0]<r[0]?t[0]:r[0],t[1]<r[1]?r[1]:t[1]]:null};var LambdaRangeUtils=function(){};LambdaRangeUtils.isPeriodic=function(t){return 2*Math.PI-ProjMath.EPSILON<=t[1]-t[0]},LambdaRangeUtils.contains=function(t,r){if(LambdaRangeUtils.isPeriodic(t))return!0;if(t[1]-t[0]<r[1]-r[0])return!1;var i=LambdaRangeUtils.normalize(t),o=LambdaRangeUtils.normalize(r);return i[0]<=o[0]&&o[1]<=i[1]||Math.PI<i[1]&&o[1]<=i[1]-2*Math.PI},LambdaRangeUtils.normalize=function(t){if(LambdaRangeUtils.isPeriodic(t))return[-Math.PI,Math.PI];var r=t[0];if(-Math.PI<=r&&r<Math.PI)return t;var i=2*Math.PI*Math.floor((r+Math.PI)/(2*Math.PI));return[t[0]-i,t[1]-i]};var GeographicRectUtils=function(){};GeographicRectUtils.mergeRange_=function(t,r){var i=null;return null==t?i=r:null!=r&&(i=t,r[0]<i[0]&&(i[0]=r[0]),i[1]<r[1]&&(i[1]=r[1])),i},GeographicRectUtils.union=function(t,r){var i=GeographicRectUtils.mergeRange_(t.phi,r.phi),o=LambdaRangeUtils.normalize(t.lambda),a=LambdaRangeUtils.normalize(r.lambda),e=GeographicRectUtils.mergeRange_(o,a);return{lambda:LambdaRangeUtils.normalize(e),phi:i}},GeographicRectUtils.intersection=function(t,r){var i=t.phi[0]<r.phi[0]?r.phi[0]:t.phi[0],o=t.phi[1]<r.phi[1]?t.phi[1]:r.phi[1];if(o<=i)return null;var a=null,e=LambdaRangeUtils.isPeriodic(t.lambda),n=LambdaRangeUtils.isPeriodic(r.lambda);if(e&&n)a=[-Math.PI,Math.PI];else{var h=LambdaRangeUtils.normalize(t.lambda),l=LambdaRangeUtils.normalize(r.lambda);if(e)a=l;else if(n)a=h;else{var s=h[0]<l[0]?l[0]:h[0],_=h[1]<l[1]?h[1]:l[1];if(s<_)a=[s,_];else{var g=h[1]<l[1]?l[1]:h[1];if(Math.PI<g){var P=h[0]<l[0]?h[0]:l[0];P<g-2*Math.PI&&(a=[P,g-2*Math.PI])}if(null===a)return null}}}return{lambda:a,phi:[i,o]}};var ProjShaderProgram=function(t){this.gl_=t,this.vbo_=null,this.program_=null,this.coordsBuffer_=null,this.locAttrCoordX_=null,this.locAttrCoordY_=null,this.locUnifFwdTransform_=null,this.locUnifInvTransform_=null,this.locUnifProjCenter_=null,this.locUnifDataCoord1_=null,this.locUnifDataCoord2_=null,this.locUnifClipCoord1_=null,this.locUnifClipCoord2_=null,this.locUnifPointSize_=null,this.locUnifCoordType_=null,this.locUnifColor_=null,this.locUnifOpacity_=null,this.locUnifTextureType_=null,this.locUnifTexture_=null};ProjShaderProgram.SCREEN_RECT={x1:-1,y1:-1,x2:1,y2:1},ProjShaderProgram.DIMENSION=2,ProjShaderProgram.POINTS_BUFFER_SIZE=64,ProjShaderProgram.COORD_TYPE_DATA=0,ProjShaderProgram.COORD_TYPE_XY=1,ProjShaderProgram.COORD_TYPE_SCREEN=2,ProjShaderProgram.TEXTURE_TYPE_NONE=0,ProjShaderProgram.TEXTURE_TYPE_POINT=1,ProjShaderProgram.TEXTURE_TYPE_SURFACE=2,ProjShaderProgram.prototype.setColor=function(t){this.gl_.uniform4f(this.locUnifColor_,t.r,t.g,t.b,t.a)},ProjShaderProgram.prototype.setViewWindow=function(t,r,i,o,a){var e=(i-t)/2,n=(o-r)/2,h=(t+i)/2,l=(r+o)/2,s=Math.cos(a),_=Math.sin(a),g=[s/e,_/e,0,-_/n,s/n,0,-s*h/e+_*l/n,-_*h/e-s*l/n,1],P=[s*e,-n*_,0,_*e,s*n,0,h,l,1];this.gl_.uniformMatrix3fv(this.locUnifFwdTransform_,!1,g),this.gl_.uniformMatrix3fv(this.locUnifInvTransform_,!1,P)},ProjShaderProgram.prototype.setTransform=function(t,r,i,o,a){var e=i/2,n=o/2,h=Math.cos(a),l=Math.sin(a),s=[h/e,l/n,0,-l/n,h/n,0,-h*t/e+l*r/n,-l*t/e-h*r/n,1],_=[h*e,-l*n,0,l*e,h*n,0,t,r,1];this.gl_.uniformMatrix3fv(this.locUnifFwdTransform_,!1,s),this.gl_.uniformMatrix3fv(this.locUnifInvTransform_,!1,_)},ProjShaderProgram.prototype.setProjCenter=function(t,r){this.gl_.uniform2f(this.locUnifProjCenter_,t,r)},ProjShaderProgram.prototype.setPointSize=function(t){this.gl_.uniform1f(this.locUnifPointSize_,t)},ProjShaderProgram.prototype.setPointTexture=function(t){null!=t?(this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_POINT),this.bindTexture(t)):(this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_NONE),this.bindTexture(null))},ProjShaderProgram.prototype.setCoordType=function(t){this.gl_.uniform1i(this.locUnifCoordType_,t)},ProjShaderProgram.prototype.setCoordTypeData=function(){this.gl_.uniform1i(this.locUnifCoordType_,ProjShaderProgram.COORD_TYPE_DATA)},ProjShaderProgram.prototype.setCoordTypeXY=function(){this.gl_.uniform1i(this.locUnifCoordType_,ProjShaderProgram.COORD_TYPE_XY)},ProjShaderProgram.prototype.setCoordTypeScreen=function(){this.gl_.uniform1i(this.locUnifCoordType_,ProjShaderProgram.COORD_TYPE_SCREEN)},ProjShaderProgram.prototype.setClearColor=function(t){this.gl_.clearColor(t.r,t.g,t.b,t.a),this.gl_.enable(this.gl_.BLEND)},ProjShaderProgram.prototype.clear=function(t){this.gl_.clear(this.gl_.COLOR_BUFFER_BIT),this.gl_.viewport(0,0,t.width,t.height)},ProjShaderProgram.prototype.setOpacity=function(t){this.gl_.uniform1f(this.locUnifOpacity_,t)},ProjShaderProgram.prototype.bindTexture=function(t){this.gl_.activeTexture(this.gl_.TEXTURE0),this.gl_.bindTexture(this.gl_.TEXTURE_2D,t)},ProjShaderProgram.prototype.setTextureType_=function(t){this.gl_.uniform1i(this.locUnifTextureType_,t)},ProjShaderProgram.prototype.prepareRenderSurface=function(){this.gl_.enableVertexAttribArray(this.locAttrCoordX_),this.gl_.vertexAttribPointer(this.locAttrCoordX_,1,this.gl_.FLOAT,this.gl_.FALSE,8,0),this.gl_.enableVertexAttribArray(this.locAttrCoordY_),this.gl_.vertexAttribPointer(this.locAttrCoordY_,1,this.gl_.FLOAT,this.gl_.FALSE,8,4);var t=new Float32Array([-1,1,-1,-1,1,1,1,-1]);this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,t),this.gl_.activeTexture(this.gl_.TEXTURE0),this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_SURFACE),this.bindTexture(null)},ProjShaderProgram.prototype.prepareRenderPoints=function(){this.gl_.enableVertexAttribArray(this.locAttrCoordX_),this.gl_.vertexAttribPointer(this.locAttrCoordX_,1,this.gl_.FLOAT,this.gl_.FALSE,8,0),this.gl_.enableVertexAttribArray(this.locAttrCoordY_),this.gl_.vertexAttribPointer(this.locAttrCoordY_,1,this.gl_.FLOAT,this.gl_.FALSE,8,4),this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_NONE),this.bindTexture(null)},ProjShaderProgram.prototype.prepareRenderPolyline=function(){this.gl_.enableVertexAttribArray(this.locAttrCoordX_),this.gl_.vertexAttribPointer(this.locAttrCoordX_,1,this.gl_.FLOAT,this.gl_.FALSE,8,0),this.gl_.enableVertexAttribArray(this.locAttrCoordY_),this.gl_.vertexAttribPointer(this.locAttrCoordY_,1,this.gl_.FLOAT,this.gl_.FALSE,8,4),this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_NONE),this.bindTexture(null)},ProjShaderProgram.prototype.prepareRenderLatitudeLine=function(){this.gl_.disableVertexAttribArray(this.locAttrCoordX_),this.gl_.enableVertexAttribArray(this.locAttrCoordY_),this.gl_.vertexAttribPointer(this.locAttrCoordY_,1,this.gl_.FLOAT,this.gl_.FALSE,0,0),this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_NONE),this.bindTexture(null)},ProjShaderProgram.prototype.prepareRenderLongitudeLine=function(){this.gl_.disableVertexAttribArray(this.locAttrCoordY_),this.gl_.enableVertexAttribArray(this.locAttrCoordX_),this.gl_.vertexAttribPointer(this.locAttrCoordX_,1,this.gl_.FLOAT,this.gl_.FALSE,0,0),this.setTextureType_(ProjShaderProgram.TEXTURE_TYPE_NONE),this.bindTexture(null)},ProjShaderProgram.prototype.renderSurfaceTexture=function(t,r,i){this.gl_.bindTexture(this.gl_.TEXTURE_2D,t),this.gl_.uniform2f(this.locUnifDataCoord1_,r[0],r[1]),this.gl_.uniform2f(this.locUnifDataCoord2_,r[2],r[3]),i?(this.gl_.uniform2f(this.locUnifClipCoord1_,i[0],i[1]),this.gl_.uniform2f(this.locUnifClipCoord2_,i[2],i[3])):(this.gl_.uniform2f(this.locUnifClipCoord1_,0,0),this.gl_.uniform2f(this.locUnifClipCoord2_,1,1)),this.gl_.drawArrays(this.gl_.TRIANGLE_STRIP,0,4)},ProjShaderProgram.prototype.renderPolyline=function(t){if(t.length/2<=ProjShaderProgram.POINTS_BUFFER_SIZE)this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(t)),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,t.length/2);else{var r=0,i=0;do{i=r+2*ProjShaderProgram.POINTS_BUFFER_SIZE,t.length<i&&(i=t.length);var o=t.slice(r,i);this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(o)),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,o.length/2),r=i-2}while(i<t.length)}},ProjShaderProgram.prototype.renderPoints=function(t){if(t.length/2<=ProjShaderProgram.POINTS_BUFFER_SIZE)this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(t)),this.gl_.drawArrays(this.gl_.POINTS,0,t.length/2);else{var r=0,i=0;do{i=r+2*ProjShaderProgram.POINTS_BUFFER_SIZE,t.length<i&&(i=t.length);var o=t.slice(r,i);this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(o)),this.gl_.drawArrays(this.gl_.POINTS,0,o.length/2),r=i}while(i<t.length)}},ProjShaderProgram.prototype.renderLatitudeLine=function(t,r,i){this.gl_.vertexAttrib1f(this.locAttrCoordX_,t),this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(r)),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,r.length)},ProjShaderProgram.prototype.renderLongitudeLine=function(t,r,i){this.gl_.vertexAttrib1f(this.locAttrCoordY_,t),this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,new Float32Array(r)),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,r.length)},ProjShaderProgram.prototype.init=function(t,r){var i=this.loadShader_(this.gl_.VERTEX_SHADER,t),o=this.loadShader_(this.gl_.FRAGMENT_SHADER,r),a=this.gl_.createProgram();if(this.gl_.attachShader(a,i),this.gl_.attachShader(a,o),this.gl_.linkProgram(a),this.gl_.getProgramParameter(a,this.gl_.LINK_STATUS)||this.gl_.isContextLost())return this.program_=a,this.gl_.useProgram(this.program_),this.locAttrCoordX_=this.gl_.getAttribLocation(this.program_,"aCoordX"),this.locAttrCoordY_=this.gl_.getAttribLocation(this.program_,"aCoordY"),this.locUnifFwdTransform_=this.gl_.getUniformLocation(this.program_,"uFwdTransform"),this.locUnifInvTransform_=this.gl_.getUniformLocation(this.program_,"uInvTransform"),this.locUnifProjCenter_=this.gl_.getUniformLocation(this.program_,"uProjCenter"),this.locUnifDataCoord1_=this.gl_.getUniformLocation(this.program_,"uDataCoord1"),this.locUnifDataCoord2_=this.gl_.getUniformLocation(this.program_,"uDataCoord2"),this.locUnifClipCoord1_=this.gl_.getUniformLocation(this.program_,"uClipCoord1"),this.locUnifClipCoord2_=this.gl_.getUniformLocation(this.program_,"uClipCoord2"),this.locUnifPointSize_=this.gl_.getUniformLocation(this.program_,"uPointSize"),this.locUnifCoordType_=this.gl_.getUniformLocation(this.program_,"uCoordType"),this.locUnifColor_=this.gl_.getUniformLocation(this.program_,"uColor"),this.locUnifOpacity_=this.gl_.getUniformLocation(this.program_,"uOpacity"),this.locUnifTextureType_=this.gl_.getUniformLocation(this.program_,"uTextureType"),this.locUnifTexture_=this.gl_.getUniformLocation(this.program_,"uTexture"),this.coordsBuffer_=this.createBuffer_(ProjShaderProgram.DIMENSION,ProjShaderProgram.POINTS_BUFFER_SIZE),this.gl_.bindBuffer(this.gl_.ARRAY_BUFFER,this.coordsBuffer_.buffer),this.setClearColor({r:0,g:.1,b:0,a:1}),this.setOpacity(1),this.gl_.blendFunc(this.gl_.SRC_ALPHA,this.gl_.ONE_MINUS_SRC_ALPHA),!0;var e=this.gl_.getProgramInfoLog(a);return alert("Error linking program:\n"+e),this.gl_.deleteProgram(a),!1},ProjShaderProgram.prototype.loadShader_=function(t,r){var i=this.gl_.createShader(t);if(this.gl_.shaderSource(i,r),this.gl_.compileShader(i),this.gl_.getShaderParameter(i,this.gl_.COMPILE_STATUS)||this.gl_.isContextLost())return i;var o=this.gl_.getShaderInfoLog(i);return alert("Error compiling shader:\n"+o),this.gl_.deleteShader(i),null},ProjShaderProgram.prototype.createBuffer_=function(t,r){var i=this.gl_.createBuffer();return this.gl_.bindBuffer(this.gl_.ARRAY_BUFFER,i),this.gl_.bufferData(this.gl_.ARRAY_BUFFER,r*t*4,this.gl_.DYNAMIC_DRAW),{buffer:i,dimension:t,maxNum:r}},"undefined"!=typeof module&&module.exports&&(module.exports={RasterMapProjection:RasterMapProjection,ImageUtils:ImageUtils,MathUtils:MathUtils,RangeUtils:RangeUtils,LambdaRangeUtils:LambdaRangeUtils,GeographicRectUtils:GeographicRectUtils,ProjMath:ProjMath,ProjShaderProgram:ProjShaderProgram});