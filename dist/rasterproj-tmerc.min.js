/*!
 * Raster Map Projection v0.0.9  2016-09-04
 *   https://github.com/tomosn/raster-map-projection
 * Copyright (C) 2016 T.Seno
 * All rights reserved. 
 * @license GPL v3 License (http://www.gnu.org/licenses/gpl.html)
 */
"use strict";if("undefined"!=typeof module&&module.exports)var ProjMath=require("./rasterproj-common.js");var ProjTMERC=function(a,b){this.lam0=a,this.phi0=b};ProjTMERC.prototype.getProjCenter=function(){return{lambda:this.lam0,phi:this.phi0}},ProjTMERC.prototype.forward=function(a,b){var c=Math.cos(b)*Math.sin(a-this.lam0),d=Math.log((1+c)/(1-c))/2,e=Math.atan2(Math.tan(b),Math.cos(a-this.lam0))-this.phi0;return(e<-Math.PI||Math.PI<=e)&&(e-=2*Math.PI*Math.floor((e+Math.PI)/(2*Math.PI))),{x:d,y:e}},ProjTMERC.prototype.inverse=function(a,b){var c=this.inverse_phi_(a,b),d=this.inverse_lambda_(a,b);return(d<-Math.PI||Math.PI<=d)&&(d-=2*Math.PI*Math.floor((d+Math.PI)/(2*Math.PI))),{lambda:d,phi:c}},ProjTMERC.prototype.inverse_phi_=function(a,b){return Math.asin(ProjMath.clamp(Math.sin(b+this.phi0)/Math.cosh(a),-1,1))},ProjTMERC.prototype.inverse_lambda_=function(a,b){return Math.atan2(Math.sinh(a),Math.cos(b+this.phi0))+this.lam0},ProjTMERC.prototype.inverse_lambda_atY_=function(a,b){var c=Math.cos(b+this.phi0);if(0===c)return 0<=a?Math.PI/2:-Math.PI/2;var d=Math.sinh(a),e=Math.atan2(d,c)+this.lam0;return c<0&&d<0?e+2*Math.PI:e},ProjTMERC.prototype.containsNorthPole_=function(a,b,c,d){if(c<0||0<a)return!1;for(var e=(2*Math.floor((b+this.phi0)/(2*Math.PI)-.5)+.5)*Math.PI-this.phi0,f=0;f<256;++f){var g=e+2*Math.PI*f;if(d<g)break;if(b<=g&&g<=d)return!0}return!1},ProjTMERC.prototype.containsSouthPole_=function(a,b,c,d){if(c<0||0<a)return!1;for(var e=(2*Math.floor((b+this.phi0)/(2*Math.PI)+.5)-.5)*Math.PI-this.phi0,f=0;f<256;++f){var g=e+2*Math.PI*f;if(d<g)break;if(b<=g&&g<=d)return!0}return!1},ProjTMERC.prototype.inverseBoundingBox=function(a,b,c,d){var e=a<=c?a:c,f=a<=c?c:a,g=b<=d?b:d,h=b<=d?d:b;if(e<=0&&0<=f){var i=this.containsNorthPole_(e,g,f,h),j=this.containsSouthPole_(e,g,f,h);if(i&&j)return{lambda:[-Math.PI,+Math.PI],phi:[-Math.PI/2,+Math.PI/2]};if(i||j){var k=this.inversePhiRange_([e,f],[g,h]);return i?{lambda:[-Math.PI,+Math.PI],phi:[k[0],Math.PI/2]}:{lambda:[-Math.PI,+Math.PI],phi:[-Math.PI/2,k[1]]}}}var l=this.inversePhiRange_([e,f],[g,h]),m=this.inverseLambdaRange_([e,f],[g,h]);return m=this.normalizeLambdaRange_(m),2*Math.PI<m[1]-m[0]&&(m=[-Math.PI,Math.PI]),{lambda:m,phi:l}},ProjTMERC.prototype.mergeRange_=function(a,b){var c=null;return null==a?c=b:null!=b&&(c=a,b[0]<c[0]&&(c[0]=b[0]),c[1]<b[1]&&(c[1]=b[1])),c},ProjTMERC.prototype.normalizeLambdaRange_=function(a){var b=a[0];if(-Math.PI<=b&&b<Math.PI)return a;var c=2*Math.PI*Math.floor((b+Math.PI)/(2*Math.PI));return[a[0]-c,a[1]-c]},ProjTMERC.prototype.inverseLambdaRange_=function(a,b){var c=a[0]<=a[1]?a[0]:a[1],d=a[0]<=a[1]?a[1]:a[0],e=b[0]<=b[1]?b[0]:b[1],f=b[0]<=b[1]?b[1]:b[0],g=this.inverseLambdaRangeAtY_([c,d],[e,f]),h=this.inverseLambdaRangeAtX_([e,f],[c,d]),i=this.mergeRange_(h,g);return i},ProjTMERC.prototype.inverseLambdaRangeAtY_=function(a,b){for(var c=a[0]<=a[1]?a[0]:a[1],d=a[0]<=a[1]?a[1]:a[0],e=c<=0&&0<=d,f=b.length,g=null,h=null,i=0;i<f;i++){var j=b[i],k=e?this.inverse_lambda_atY_(c,j):this.inverse_lambda_(c,j);(null===g||k<g)&&(g=k),(null===h||h<k)&&(h=k),k=e?this.inverse_lambda_atY_(d,j):this.inverse_lambda_(d,j),k<g&&(g=k),h<k&&(h=k)}if(g<-Math.PI||Math.PI<=g){var l=2*Math.PI*Math.floor((g+Math.PI)/(2*Math.PI));g-=l,h-=l}return[g,h]},ProjTMERC.prototype.inverseLambdaRangeAtX_=function(a,b){for(var c=a[0]<=a[1]?a[0]:a[1],d=a[0]<=a[1]?a[1]:a[0],e=Math.PI*Math.floor((c+this.phi0)/Math.PI)-this.phi0,f=b.length,g=null,h=null,i=0;i<f;i++){var j=b[i],k=this.inverse_lambda_(j,c);(null===g||k<g)&&(g=k),(null===h||h<k)&&(h=k),k=this.inverse_lambda_(j,d),k<g&&(g=k),h<k&&(h=k);for(var l=1;l<=2;l++){var m=e+Math.PI*l;if(m<c)throw new Error("hoge!");if(d<m)break;k=this.inverse_lambda_(j,m),k<g&&(g=k),h<k&&(h=k)}}if(g<-Math.PI||Math.PI<=g){var n=2*Math.PI*Math.floor((g+Math.PI)/(2*Math.PI));g-=n,h-=n}return[g,h]},ProjTMERC.prototype.inversePhiRange_=function(a,b){var c=a[0]<=a[1]?a[0]:a[1],d=a[0]<=a[1]?a[1]:a[0],e=b[0]<=b[1]?b[0]:b[1],f=b[0]<=b[1]?b[1]:b[0],g=this.inversePhiRangeAtY_([c,d],[e,f]),h=this.inversePhiRangeAtX_([e,f],[c,d]),i=this.mergeRange_(h,g);return i},ProjTMERC.prototype.inversePhiRangeAtY_=function(a,b){for(var c=a[0]<=a[1]?a[0]:a[1],d=a[0]<=a[1]?a[1]:a[0],e=b.length,f=null,g=null,h=0;h<e;h++){var i=b[h],j=this.inverse_phi_(c,i);(null===f||j<f)&&(f=j),(null===g||g<j)&&(g=j),j=this.inverse_phi_(d,i),j<f&&(f=j),g<j&&(g=j),c<0&&0<d&&(j=this.inverse_phi_(0,i),j<f&&(f=j),g<j&&(g=j))}return[f,g]},ProjTMERC.prototype.inversePhiRangeAtX_=function(a,b){for(var c=a[0]<=a[1]?a[0]:a[1],d=a[0]<=a[1]?a[1]:a[0],e=Math.PI*(Math.floor((c+this.phi0)/Math.PI+.5)-.5)-this.phi0,f=b.length,g=null,h=null,i=0;i<f;i++){var j=b[i],k=this.inverse_phi_(j,c);(null===g||k<g)&&(g=k),(null===h||h<k)&&(h=k),k=this.inverse_phi_(j,d),k<g&&(g=k),h<k&&(h=k);for(var l=1;l<=2;l++){var m=e+Math.PI*l;if(m<c)throw new Error("hoge!");if(d<m)break;k=this.inverse_phi_(j,m),k<g&&(g=k),h<k&&(h=k)}}return[g,h]};var GraticuleGeneratorTMERC=function(a,b,c){GraticuleGenerator.call(this,a,b,c)};Object.setPrototypeOf(GraticuleGeneratorTMERC.prototype,GraticuleGenerator.prototype),GraticuleGeneratorTMERC.prototype.generateEquator_=function(a,b,c){var d=this.transform_(c,this.projection.lam0-35*Math.PI/72,0),e=this.transform_(c,this.projection.lam0+35*Math.PI/72,0),f=-1<d[0]?d[0]:-1,g=e[0]<1?e[0]:1;a.add([f,d[1]]),a.add([g,e[1]]),a.endPolyline();var h=this.transform_(c,this.projection.lam0+Math.PI,0);a.add([f,h[1]]),a.add([g,h[1]]),a.endPolyline()},GraticuleGeneratorTMERC.prototype.generateLongitudeLineAtLat=function(a,b,c,d){0===a?this.generateEquator_(b,c,d):this.generateLongitudeLines_(b,a*Math.PI/180,c,d)};var RasterProjTMERC=function(){this.shader_=null,this.gl_=null,this.canvasWidth=null,this.canvasHeight=null,this.program_=null,this.locTranslateY_=null,this.locTexture_=null,this.locAlpha_=null,this.locProjCenter_=null,this.locViewXY1_=null,this.locViewXY2_=null,this.locDataLambdaPhi1_=null,this.locDataLambdaPhi2_=null,this.locDrawGraticule_=null,this.vbo_=null,this.backColor_={r:0,g:0,b:0},this.zoomInLimit=Math.PI/20,this.zoomOutLimit=20*Math.PI,this.viewWindowRect_=this.getViewRect(),this.alpha_=1,this.center_=[0,0],this.projection=new ProjTMERC(0,0),this.numberOfPoints=64};RasterProjTMERC.prototype.getViewRect=function(){return[-Math.PI,-Math.PI,+Math.PI,+Math.PI]},RasterProjTMERC.prototype.init=function(a,b,c){this.shader_=new RasterProjShaderProgram(a),this.gl_=a,this.canvasWidth=b,this.canvasHeight=c,this.initShader()},RasterProjTMERC.prototype.setCanvasSize=function(a,b){this.canvasWidth=a,this.canvasHeight=b},RasterProjTMERC.prototype.setViewWindow=function(a,b,c,d){this.viewWindowRect_=[a,b,c,d]},RasterProjTMERC.prototype.getViewWindow=function(){return this.viewWindowRect_.slice(0)},RasterProjTMERC.prototype.setViewWindowCenter=function(a,b){var c=(this.viewWindowRect_[2]-this.viewWindowRect_[0])/2,d=(this.viewWindowRect_[3]-this.viewWindowRect_[1])/2;this.viewWindowRect_=[a-c,b-d,a+c,b+d]},RasterProjTMERC.prototype.getViewWindowCenter=function(){var a=(this.viewWindowRect_[2]+this.viewWindowRect_[0])/2,b=(this.viewWindowRect_[3]+this.viewWindowRect_[1])/2;return[a,b]},RasterProjTMERC.prototype.moveWindow=function(a,b){var c=-a*(this.viewWindowRect_[2]-this.viewWindowRect_[0])/this.canvasWidth,d=b*(this.viewWindowRect_[3]-this.viewWindowRect_[1])/this.canvasHeight,e=this.viewWindowRect_[0]+c,f=this.viewWindowRect_[1]+d,g=this.viewWindowRect_[2]+c,h=this.viewWindowRect_[3]+d;this.viewWindowRect_=[e,f,g,h]},RasterProjTMERC.prototype.zoomWindow=function(a){var b=(this.canvasHeight-a)/this.canvasHeight,c=b*(this.viewWindowRect_[2]-this.viewWindowRect_[0])/2,d=b*(this.viewWindowRect_[3]-this.viewWindowRect_[1])/2,e=(this.viewWindowRect_[2]+this.viewWindowRect_[0])/2,f=(this.viewWindowRect_[3]+this.viewWindowRect_[1])/2;null!=this.zoomInLimit&&(c<this.zoomInLimit||d<this.zoomInLimit)||null!=this.zoomOutLimit&&(this.zoomOutLimit<c||this.zoomOutLimit<d)||(this.viewWindowRect_=[e-c,f-d,e+c,f+d])},RasterProjTMERC.prototype.getViewPointFromWindow=function(a,b){var c=new CoordTransform([0,this.canvasHeight,this.canvasWidth,0],this.viewWindowRect_);return c.forwardPoint([a,b])},RasterProjTMERC.prototype.setAlpha=function(a){this.alpha_=a},RasterProjTMERC.prototype.setProjCenter=function(a,b){this.center_=[a,b],this.projection=new ProjTMERC(a,b)},RasterProjTMERC.prototype.initShader=function(){var a=this.shader_.init(RasterProjTMERC.VERTEX_SHADER_STR,RasterProjTMERC.FRAGMENT_SHADER_STR);if(a){this.program_=a,this.locTranslateY_=this.gl_.getUniformLocation(this.program_,"uTranslateY"),this.locTexture_=this.gl_.getUniformLocation(this.program_,"uTexture"),this.locAlpha_=this.gl_.getUniformLocation(this.program_,"uAlpha"),this.locProjCenter_=this.gl_.getUniformLocation(this.program_,"uProjCenter"),this.locViewXY1_=this.gl_.getUniformLocation(this.program_,"uViewXY1"),this.locViewXY2_=this.gl_.getUniformLocation(this.program_,"uViewXY2"),this.locDataLambdaPhi1_=this.gl_.getUniformLocation(this.program_,"uDataLambdaPhi1"),this.locDataLambdaPhi2_=this.gl_.getUniformLocation(this.program_,"uDataLambdaPhi2"),this.locDrawGraticule_=this.gl_.getUniformLocation(this.program_,"uDrawGraticule");var b=8+this.numberOfPoints;this.vbo_=this.gl_.createBuffer(),this.gl_.bindBuffer(this.gl_.ARRAY_BUFFER,this.vbo_),this.gl_.bufferData(this.gl_.ARRAY_BUFFER,4*b*2,this.gl_.DYNAMIC_DRAW),this.gl_.clearColor(this.backColor_.r,this.backColor_.g,this.backColor_.b,1),this.gl_.enable(this.gl_.BLEND)}},RasterProjTMERC.prototype.clear=function(){this.gl_.clear(this.gl_.COLOR_BUFFER_BIT),this.gl_.viewport(0,0,this.canvasWidth,this.canvasHeight)},RasterProjTMERC.prototype.renderTextures=function(a){var b=this.center_[0],c=this.center_[1],d=.5,e=.5;this.canvasHeight<this.canvasWidth?e=.5*this.canvasHeight/this.canvasWidth:this.canvasWidth<this.canvasHeight&&(d=.5*this.canvasWidth/this.canvasHeight);var f=new Float32Array([.5-d,.5-e,.5-d,.5+e,.5+d,.5-e,.5+d,.5+e]),g=new Float32Array([-1,-1,-1,1,1,-1,1,1]);this.gl_.useProgram(this.program_);var h=g.byteLength;this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,g),this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,h,f);var i=2;this.gl_.enableVertexAttribArray(0),this.gl_.vertexAttribPointer(0,i,this.gl_.FLOAT,this.gl_.FALSE,0,0),this.gl_.enableVertexAttribArray(1),this.gl_.vertexAttribPointer(1,i,this.gl_.FLOAT,this.gl_.FALSE,0,h),this.gl_.uniform1f(this.locTranslateY_,0),this.gl_.blendFunc(this.gl_.SRC_ALPHA,this.gl_.ONE),this.gl_.uniform1f(this.locAlpha_,this.alpha_),this.gl_.uniform2f(this.locProjCenter_,b,c),this.gl_.uniform2f(this.locViewXY1_,this.viewWindowRect_[0],this.viewWindowRect_[1]),this.gl_.uniform2f(this.locViewXY2_,this.viewWindowRect_[2],this.viewWindowRect_[3]),this.gl_.uniform1i(this.locTexture_,0),this.gl_.uniform1i(this.locDrawGraticule_,!1);for(var j=0;j<a.length;++j){var k=a[j][0],l=a[j][1],m=l[0],n=l[1],o=l[2],p=l[3];this.gl_.bindTexture(this.gl_.TEXTURE_2D,k),this.gl_.uniform2f(this.locDataLambdaPhi1_,m,n),this.gl_.uniform2f(this.locDataLambdaPhi2_,o,p),this.gl_.drawArrays(this.gl_.TRIANGLE_STRIP,0,4)}},RasterProjTMERC.prototype.renderGraticule=function(a){var b=this.center_[0],c=this.center_[1],d=2,e=this.numberOfPoints;this.gl_.useProgram(this.program_),this.gl_.enableVertexAttribArray(0),this.gl_.vertexAttribPointer(0,d,this.gl_.FLOAT,this.gl_.FALSE,0,0),this.gl_.uniform1f(this.locTranslateY_,0),this.gl_.blendFunc(this.gl_.ONE,this.gl_.ONE),this.gl_.uniform1f(this.locAlpha_,this.alpha_),this.gl_.uniform2f(this.locProjCenter_,b,c),this.gl_.uniform2f(this.locViewXY1_,this.viewWindowRect_[0],this.viewWindowRect_[1]),this.gl_.uniform2f(this.locViewXY2_,this.viewWindowRect_[2],this.viewWindowRect_[3]),this.gl_.uniform1i(this.locTexture_,0),this.gl_.uniform1i(this.locDrawGraticule_,!0);var f=this.viewWindowRect_[1],g=this.viewWindowRect_[3],h=2/(g-f),i=Math.floor((g-Math.PI)/(2*Math.PI))+1,j=-Math.floor((-f-Math.PI)/(2*Math.PI))-1,k=new GraticuleGeneratorTMERC(this.projection,e,a);(0<i||j<0)&&(k.checkScreenRect=function(a){return-1<=a[0]&&a[0]<=1});for(var l=k.generateLines(this.viewWindowRect_),m=0;m<l.length;++m){var n=l[m].length/2,o=new Float32Array(l[m]);if(this.gl_.bufferSubData(this.gl_.ARRAY_BUFFER,0,o),this.gl_.uniform1f(this.locTranslateY_,0),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,n),0<i)for(var p=1;p<=i;++p){var q=2*p*Math.PI*h;this.gl_.uniform1f(this.locTranslateY_,q),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,n)}if(j<0)for(var r=-1;j<=r;--r){var s=2*r*Math.PI*h;this.gl_.uniform1f(this.locTranslateY_,s),this.gl_.drawArrays(this.gl_.LINE_STRIP,0,n)}}},RasterProjTMERC.VERTEX_SHADER_STR=["precision highp float;","attribute vec3 aPosition;","attribute vec2 aTexCoord;","uniform float uTranslateY;","varying vec2 vTexCoord;","void main()","{","  gl_Position = vec4(aPosition.x, aPosition.y + uTranslateY, aPosition.z, 1.0);","  vTexCoord = aTexCoord;","}"].join("\n"),RasterProjTMERC.FRAGMENT_SHADER_STR=["precision highp float;","uniform sampler2D uTexture;","varying vec2 vTexCoord;","uniform vec2 uProjCenter;","uniform vec2 uViewXY1;","uniform vec2 uViewXY2;","uniform vec2 uDataLambdaPhi1;","uniform vec2 uDataLambdaPhi2;","uniform float uAlpha;","uniform bool uDrawGraticule;","const float pi = 3.14159265;","const float epsilon = 0.00000001;","const float blurRatio = 0.015;","const float xyRadius = pi;","vec2 proj_invserse(vec2 center, vec2 xy)","{","  float d = xy.y + center.y;","  float ep = exp(xy.x);","  float em = exp(-xy.x);","  float ch = (ep + em) / 2.0;","  float sh = (ep - em) / 2.0;","  float phi = asin( clamp( sin(d) / ch, -1.0, 1.0 ) );","  float lam = mod( center.x + atan( sh, cos(d) ) + pi, 2.0 * pi ) - pi;","  return vec2(lam, phi);","}","float inner_xy(vec2 xy)","{","  return 1.0;","}","void main()","{","  vec2 xy = mix(uViewXY1, uViewXY2, vTexCoord);","  vec2 lp = proj_invserse(uProjCenter, xy);","  vec2 lp1 = vec2(uDataLambdaPhi1.x, uDataLambdaPhi2.y);","  vec2 lp2 = vec2(uDataLambdaPhi2.x, uDataLambdaPhi1.y);","  vec2 ts = (lp - lp1) / (lp2 - lp1);","  float inXY = inner_xy(xy);","  vec2 inData = step(vec2(0.0, 0.0), ts) - step(vec2(1.0, 1.0), ts);","  vec4 OutputColor = texture2D(uTexture, ts) * inData.x * inData.y * inXY;","  OutputColor.a *= clamp(uAlpha, 0.0, 1.0);","  if ( uDrawGraticule ) {","    gl_FragColor = vec4(0.25, 0.25, 0.25, 1.0);","  } else {","    gl_FragColor = OutputColor;","  }","}"].join("\n"),"undefined"!=typeof module&&module.exports&&(module.exports=RasterProjTMERC,module.exports.ProjTMERC=ProjTMERC);